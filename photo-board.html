<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>ì‚¬ì§„ëŒ€ì§€</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&family=Bebas+Neue&display=swap" rel="stylesheet">
<style>
:root{
  --bg1:#0f1117;--bg2:#171b24;--bg3:#1e2330;--bg4:#252a38;
  --bdr:#2e3448;--m:#64748b;--m2:#94a3b8;
  --or:#f97316;--gn:#22c55e;
}
*{box-sizing:border-box;margin:0;padding:0}
body{background:var(--bg1);color:#e2e8f0;font-family:'Noto Sans KR',sans-serif;height:100vh;overflow:hidden;display:flex;flex-direction:column}

/* â”€ Side Panel â”€ */
.main-area{display:flex;flex:1;overflow:hidden}
.preview{flex:1;overflow:auto;display:flex;justify-content:center;align-items:flex-start;padding:36px 36px 80px;position:relative}
.sidepanel{width:220px;min-width:220px;background:var(--bg2);border-left:1px solid var(--bdr);display:flex;flex-direction:column;overflow:hidden;flex-shrink:0}
.sp-section{padding:12px 14px;border-bottom:1px solid var(--bdr)}
.sp-title{font-size:11px;font-weight:600;color:var(--m);text-transform:uppercase;letter-spacing:.8px;margin-bottom:8px}
.sp-stat{display:flex;justify-content:space-between;align-items:center;font-size:12px;color:var(--m2);padding:2px 0}
.sp-stat span:last-child{font-weight:700;color:#93c5fd}
.sp-stat.filled span:last-child{color:#4ade80}
.sp-stat.waiting span:last-child{color:#fb923c}
.sp-drop{border:1.5px dashed #2e3448;border-radius:8px;padding:18px 10px;text-align:center;cursor:pointer;transition:.15s;background:rgba(59,130,246,.03);margin:12px 14px 0}
.sp-drop:hover{border-color:#f97316;background:rgba(249,115,22,.06)}
.sp-drop-icon{font-size:26px;margin-bottom:6px;color:#4a90d9}
.sp-drop-txt{font-size:12px;font-weight:700;color:#e2e8f0;margin-bottom:3px}
.sp-drop-sub{font-size:10px;color:var(--m)}
.sp-drop input[type=file]{display:none}
.sp-qwrap{flex:1;overflow-y:auto;padding:8px 0}
.sp-qlbl{font-size:10px;color:var(--m);padding:4px 14px 6px;font-weight:600}
.sp-queue{list-style:none;display:flex;flex-direction:column;gap:4px;padding:0 10px}
.sp-qitem{display:flex;align-items:center;gap:8px;background:var(--bg3);border:1px solid var(--bdr);border-radius:6px;padding:5px 8px;cursor:grab;transition:.1s;position:relative}
.sp-qitem:hover{border-color:#4a90d9;background:var(--bg4)}
.sp-qitem img{width:36px;height:27px;object-fit:cover;border-radius:3px;flex-shrink:0}
.sp-qitem-name{font-size:10px;color:var(--m2);flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.sp-qitem-del{width:16px;height:16px;border-radius:50%;background:rgba(239,68,68,.7);border:none;color:#fff;font-size:10px;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;line-height:1}
.sp-qitem-del:hover{background:#ef4444}
.sp-qitem.drag-over{border-color:#f97316;background:rgba(249,115,22,.12);}
.sp-qitem-badge{min-width:36px;height:20px;border-radius:5px;background:#1e3a5f;border:1px solid #3b82f6;color:#93c5fd;font-size:10px;font-weight:700;display:flex;align-items:center;justify-content:center;flex-shrink:0;white-space:nowrap;padding:0 4px}
.sp-qitem-badge.empty{background:rgba(100,116,139,.15);border-color:var(--bdr);color:var(--m)}
.sp-qitem-badge.filled{background:rgba(34,197,94,.1);border-color:#22c55e;color:#4ade80}
.sp-qitem img{width:40px;height:30px;object-fit:cover;border-radius:3px;flex-shrink:0}
.sp-assign-btn{margin:8px 14px 12px;width:calc(100% - 28px);padding:8px;border-radius:7px;background:var(--or);border:none;color:#fff;font-size:12px;font-weight:700;cursor:pointer;font-family:'Noto Sans KR',sans-serif;transition:.15s}
.sp-assign-btn:hover{background:#ea580c}
.sp-assign-btn:disabled{background:var(--bg4);color:var(--m);cursor:not-allowed}



.sp-paste-hint{margin:5px 14px 0;font-size:12px;color:#e2e8f0;font-weight:600;text-align:center;padding:7px 5px;background:var(--bg3);border-radius:6px;line-height:1.6;border:1px dashed var(--bdr)}
.sp-paste-hint kbd{background:var(--bg4);border:1px solid #4a5568;border-radius:4px;padding:1px 5px;font-size:11px;color:#f1f5f9;font-family:monospace;font-weight:700}
.sp-cap-btn{display:flex;align-items:center;justify-content:center;gap:8px;border:1.5px dashed #3b82f6;border-radius:8px;padding:10px;background:rgba(59,130,246,.05);color:#93c5fd;font-size:12px;font-weight:700;cursor:pointer;transition:.15s;font-family:'Noto Sans KR',sans-serif;margin:6px 14px 0;width:calc(100% - 28px)}
.sp-cap-btn:hover{border-color:#60a5fa;background:rgba(59,130,246,.15)}

#capGuide{position:fixed;inset:0;z-index:9999;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.6);backdrop-filter:blur(4px)}
#capGuide.active{display:flex}
.capguide-box{background:var(--bg2);border:1px solid var(--bdr);border-radius:14px;padding:28px 32px;text-align:center;max-width:320px;width:90%}
.capguide-icon{font-size:36px;margin-bottom:12px}
.capguide-title{font-size:15px;font-weight:700;color:#e2e8f0;margin-bottom:8px}
.capguide-step{font-size:12px;color:var(--m2);line-height:2;margin-bottom:14px}
.capguide-step kbd{background:var(--bg4);border:1px solid #4a5568;border-radius:4px;padding:2px 6px;color:#e2e8f0;font-family:monospace;font-size:11px}
.capguide-wait{font-size:12px;color:#60a5fa;font-weight:600;margin-bottom:16px;display:flex;align-items:center;justify-content:center;gap:6px}
.capguide-wait::before{content:'';width:8px;height:8px;background:#3b82f6;border-radius:50%;animation:blink .9s infinite}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.2}}
.capguide-cancel{background:var(--bg4);border:1px solid var(--bdr);color:var(--m2);padding:7px 20px;border-radius:7px;font-size:12px;cursor:pointer;font-family:'Noto Sans KR',sans-serif}
.capguide-cancel:hover{color:#fff}

.paste-flash{position:fixed;inset:0;background:rgba(59,130,246,.15);z-index:99998;pointer-events:none;opacity:0;transition:opacity .3s}




/* â”€ Save Panel (left) â”€ */
.savepanel{width:220px;min-width:220px;background:var(--bg2);border-right:1px solid var(--bdr);display:flex;flex-direction:column;overflow:hidden;flex-shrink:0;transition:transform .3s}
.savepanel.hidden{display:none}
.sp-hdr{padding:12px 14px 8px;border-bottom:1px solid var(--bdr);display:flex;align-items:center;justify-content:space-between}
.sp-hdr-title{font-size:11px;font-weight:700;color:var(--m);text-transform:uppercase;letter-spacing:.8px}
.sp-save-btn{padding:5px 10px;border-radius:6px;background:var(--or);border:none;color:#fff;font-size:11px;font-weight:700;cursor:pointer;font-family:'Noto Sans KR',sans-serif;transition:.15s;white-space:nowrap}
.sp-save-btn:hover{background:#ea580c}
.sp-save-btn:disabled{background:var(--bg4);color:var(--m);cursor:not-allowed}
.sp-login-prompt{padding:20px 14px;text-align:center;color:var(--m);font-size:12px;line-height:1.7}
.sp-login-prompt-btn{margin-top:10px;width:100%;padding:8px;border-radius:7px;background:rgba(59,130,246,.15);border:1px solid rgba(59,130,246,.4);color:#93c5fd;font-size:12px;font-weight:600;cursor:pointer;font-family:'Noto Sans KR',sans-serif;transition:.15s}
.sp-login-prompt-btn:hover{background:rgba(59,130,246,.3)}
.sp-list{flex:1;overflow-y:auto;padding:6px 0}
.sp-item{padding:9px 14px;cursor:pointer;border-bottom:1px solid rgba(46,52,72,.5);transition:.1s;position:relative}
.sp-item:hover{background:var(--bg3)}
.sp-item.active{background:rgba(249,115,22,.08);border-left:2px solid var(--or)}
.sp-item-name{font-size:12px;font-weight:600;color:#e2e8f0;margin-bottom:2px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;padding-right:20px}
.sp-item-meta{font-size:10px;color:var(--m)}
.sp-item-del{position:absolute;right:8px;top:50%;transform:translateY(-50%);width:18px;height:18px;border-radius:50%;background:rgba(239,68,68,.7);border:none;color:#fff;font-size:10px;cursor:pointer;display:flex;align-items:center;justify-content:center;opacity:0;transition:.1s}
.sp-item:hover .sp-item-del{opacity:1}
.sp-item-del:hover{background:#ef4444}
.sp-empty{padding:20px 14px;text-align:center;color:var(--m);font-size:11px;line-height:1.8}
.sp-new-btn{margin:8px 14px 10px;width:calc(100% - 28px);padding:7px;border-radius:7px;background:var(--bg3);border:1px dashed var(--bdr);color:var(--m2);font-size:11px;font-weight:600;cursor:pointer;font-family:'Noto Sans KR',sans-serif;transition:.15s}
.sp-new-btn:hover{border-color:#f97316;color:#f97316}
/* ì €ì¥ ì´ë¦„ ëª¨ë‹¬ */
#saveModal{position:fixed;inset:0;background:rgba(0,0,0,.6);backdrop-filter:blur(4px);z-index:9999;display:none;align-items:center;justify-content:center}
#saveModal.open{display:flex}
.save-modal-box{background:var(--bg2);border:1px solid var(--bdr);border-radius:12px;padding:24px;width:320px}
.save-modal-title{font-size:14px;font-weight:700;margin-bottom:12px;color:#e2e8f0}
.save-modal-inp{width:100%;padding:9px 12px;border-radius:7px;border:1px solid var(--bdr);background:var(--bg3);color:#e2e8f0;font-size:13px;font-family:'Noto Sans KR',sans-serif;margin-bottom:14px}
.save-modal-inp:focus{outline:none;border-color:var(--or)}
.save-modal-btns{display:flex;gap:8px}
.save-modal-btns button{flex:1;padding:8px;border-radius:7px;font-size:12px;font-weight:700;cursor:pointer;font-family:'Noto Sans KR',sans-serif;border:none;transition:.15s}
.save-modal-ok{background:var(--or);color:#fff}
.save-modal-ok:hover{background:#ea580c}
.save-modal-cancel{background:var(--bg4);color:var(--m2)}
.save-modal-cancel:hover{background:var(--bg3);color:#fff}


/* ë¡œê·¸ì¸ í•„ìš” íŒì—… */
#loginRequiredToast{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%) scale(.9);background:var(--bg2);border:1px solid var(--bdr);border-radius:14px;padding:28px 32px;text-align:center;z-index:9999;opacity:0;pointer-events:none;transition:all .25s;width:280px;box-shadow:0 12px 40px rgba(0,0,0,.6)}
#loginRequiredToast.show{opacity:1;transform:translate(-50%,-50%) scale(1);pointer-events:auto}

/* â”€ Nav â”€ */
.nav{position:sticky;top:0;z-index:200;background:rgba(15,17,23,.95);backdrop-filter:blur(16px);border-bottom:1px solid var(--bdr);padding:0 24px;display:flex;align-items:center;height:52px;gap:16px;flex-shrink:0}
.logo{font-family:'Bebas Neue',sans-serif;font-size:20px;letter-spacing:.1em;color:var(--or);display:flex;align-items:center;gap:8px;text-decoration:none}
.logo span{color:#e2e8f0}
.logo span{color:#e2e8f0}
.nav-back{font-size:12px;color:var(--m2)!important;text-decoration:none;display:flex;align-items:center;gap:4px;padding:5px 10px;border-radius:6px;transition:.15s}
.nav-back:hover{color:#fff;background:var(--bg4)}
.nav-sep{color:var(--bdr);font-size:16px}
.nav-site{font-size:13px;font-weight:600;color:#e2e8f0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:400px}
.nav-right{margin-left:auto;display:flex;align-items:center;gap:10px}
/* â”€ Toolbar â”€ */
.toolbar{height:50px;background:var(--bg2);border-bottom:1px solid var(--bdr);display:flex;align-items:center;padding:0 12px;gap:7px;flex-shrink:0;overflow-x:auto}
.tl{flex:1;font-size:13px;color:var(--m2);font-weight:600}
.btn{padding:6px 13px;border-radius:7px;font-size:13px;font-family:'Noto Sans KR',sans-serif;cursor:pointer;border:none;font-weight:500;white-space:nowrap;transition:.15s}
.btn.g{background:var(--bg4);color:var(--m2);border:1px solid var(--bdr)}.btn.g:hover{background:var(--bg3);color:#fff}
.btn.g:disabled{opacity:.35;cursor:not-allowed}
.btn.green{background:var(--gn);color:#fff}.btn.green:hover{background:#16a34a}
.btn.orange{background:var(--or);color:#fff}.btn.orange:hover{background:#ea580c}
/* â”€ Fmtbar â”€ */
.fmtbar{height:36px;background:var(--bg3);border-bottom:1px solid var(--bdr);display:flex;align-items:center;padding:0 8px;gap:2px;flex-shrink:0;overflow-x:auto}
.fsep{width:1px;height:16px;background:var(--bdr);margin:0 4px;flex-shrink:0}
.flbl{font-size:10px;color:var(--m);white-space:nowrap;padding:0 2px}
.fb{background:var(--bg4);border:1px solid var(--bdr);color:var(--m2);border-radius:5px;height:22px;cursor:pointer;font-size:12px;font-family:'Noto Sans KR',sans-serif;display:inline-flex;align-items:center;justify-content:center;transition:.1s;white-space:nowrap;line-height:1;padding:0 6px}
.fb:hover{background:var(--bg3);color:#fff;border-color:#4b5563}
.fb.on{background:rgba(249,115,22,.22);color:var(--or);border-color:var(--or)}
.fsel{background:var(--bg4);border:1px solid var(--bdr);color:var(--m2);border-radius:5px;padding:0 4px;height:22px;font-size:12px;cursor:pointer}
.fnum{background:var(--bg4);border:1px solid var(--bdr);color:var(--m2);border-radius:5px;padding:0;height:22px;font-size:11px;width:32px;text-align:center;-moz-appearance:textfield}
.fnum::-webkit-inner-spin-button,.fnum::-webkit-outer-spin-button{-webkit-appearance:none;margin:0}
.fhint{font-size:10px;color:var(--m);white-space:nowrap;margin-left:4px;flex-shrink:0}
/* â”€ Settings â”€ */
.settings{background:var(--bg3);border-bottom:1px solid var(--bdr);padding:8px 14px;display:flex;align-items:center;gap:14px;flex-shrink:0;flex-wrap:wrap}
.sg{display:flex;flex-direction:column;gap:3px}.sg label{font-size:10px;color:var(--m);font-weight:500}
.sg input,.sg select{background:var(--bg4);border:1px solid var(--bdr);color:#e2e8f0;border-radius:6px;padding:5px 9px;font-size:12px;font-family:'Noto Sans KR',sans-serif;outline:none}
.sg input{width:190px}.sg select{width:140px;cursor:pointer}.sg input:focus{border-color:var(--or)}
.pntoggle{background:var(--bg4);border:1px solid var(--bdr);color:var(--m2);border-radius:6px;padding:5px 11px;font-size:12px;cursor:pointer;font-family:'Noto Sans KR',sans-serif;transition:.15s}
.pntoggle.on{background:rgba(249,115,22,.18);border-color:var(--or);color:var(--or)}
.csw{width:22px;height:22px;border-radius:3px;cursor:pointer;border:2px solid transparent;flex-shrink:0}
.csw:hover{border-color:#f97316;transform:scale(1.1)}
/* â”€ Preview â”€ */
/* preview moved to side_css */
.scalewrap{transform-origin:top center;flex-shrink:0}
/* â”€ Sheet â”€ */
.sheet{width:794px;height:1123px;background:#fff;color:#111;box-shadow:0 8px 40px rgba(0,0,0,.6);font-family:'Malgun Gothic',sans-serif;padding:56.7px;position:relative;display:flex;flex-direction:column}
.shdr{margin-bottom:7px;flex-shrink:0}
.shdr-top{position:relative;display:flex;align-items:baseline;margin-bottom:4px}
.stitle{font-size:20px;font-weight:700;cursor:text;font-family:'Malgun Gothic',sans-serif;color:#002060;letter-spacing:4px}
.stitle:focus{outline:2px solid #f97316;background:#fffbf0}
.smeta{display:flex;align-items:center;position:absolute;right:0;top:50%;transform:translateY(-50%);white-space:nowrap;}
.smeta-lbl{font-size:11px;font-weight:700;padding-right:7px;white-space:nowrap;cursor:pointer}
.smeta-inp{font-size:12px;outline:none;background:transparent;font-family:'Malgun Gothic',sans-serif;min-width:20px;display:inline-block;white-space:nowrap;cursor:text;}
.smeta-inp:focus{background:#fffbf0;outline:none}
.sinp-empty:not(:focus):before{content:attr(data-placeholder);color:#aaa;pointer-events:none}
.smeta-txt{font-size:12px;font-family:'Malgun Gothic',sans-serif;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;min-width:0}
.sdeco{width:100%;height:auto;display:block;margin-bottom:4px}
/* â”€ Grid â”€ */
.grid{display:grid;grid-template-columns:1fr 1fr;gap:5px;flex:1;align-content:stretch;grid-auto-rows:1fr;min-height:0}
.slot{border:1.5px solid #222;display:flex;flex-direction:column;height:100%;min-height:0}
/* photo */
.photo.drop-hover{outline:3px solid #f97316!important;background:#fff3e0!important;}
.photo{flex:1;min-height:0;background:#f0f0f0;border-bottom:1px solid #222;display:flex;align-items:center;justify-content:center;position:relative;cursor:pointer;overflow:hidden;transition:background .15s}
.photo:hover{background:#e8e8e8}
.photo img{width:100%;height:100%;object-fit:cover;display:block}
.uphint{display:flex;flex-direction:column;align-items:center;gap:5px;color:#aaa;font-size:11px;pointer-events:none}
.uphint svg{opacity:.35}
.photo input[type=file]{position:absolute;inset:0;opacity:0;cursor:pointer}
.delp{position:absolute;top:4px;right:4px;background:rgba(0,0,0,.5);color:#fff;border:none;border-radius:50%;width:20px;height:20px;font-size:12px;cursor:pointer;display:none;align-items:center;justify-content:center;line-height:1}
.photo:hover .delp{display:flex}
.slotnum{position:absolute;top:5px;left:6px;font-size:17px;font-weight:700;color:rgba(0,0,0,.15);pointer-events:none;font-family:'Malgun Gothic',sans-serif;user-select:none}
/* meta row */
.metarow{display:grid;border-bottom:1px solid #222;min-height:22px}
.mlbl{font-size:10px;font-weight:700;padding:3px 5px;border-right:1px solid #222;background:#f5f5f5;display:flex;align-items:center;justify-content:center;overflow:hidden;white-space:nowrap;color:#444;flex-shrink:0;cursor:pointer;box-sizing:border-box}
.mlbl-sep{border-left:1px solid #222}
.minp{font-size:11px;padding:3px 5px;border:none;outline:none;font-family:'Malgun Gothic',sans-serif;background:transparent;color:#111;width:100%;min-width:0}
/* desc row */
.descrow{display:flex;min-height:28px}
.dlbl{font-size:10px;font-weight:700;padding:3px 5px;border-right:1px solid #222;background:#f5f5f5;display:flex;align-items:center;justify-content:center;overflow:hidden;white-space:nowrap;color:#444;flex-shrink:0;cursor:pointer;box-sizing:border-box}
.dinp{flex:1;font-size:11px;padding:3px 5px;border:none;outline:none;font-family:'Malgun Gothic',sans-serif;resize:none;background:transparent;color:#111;line-height:1.5;min-height:26px;width:100%;min-width:0}
/* selection */
.sel{cursor:pointer}.sel.on{background:#fff3e0!important;outline:2px solid #f97316;outline-offset:-1px}
.photo.on{outline:3px solid #f97316;outline-offset:-3px}
/* page wrap */
.pagewrap{position:relative}
.pgnum{position:absolute;bottom:8px;left:50%;transform:translateX(-50%);font-size:10px;color:#888;pointer-events:none;white-space:nowrap;font-family:'Malgun Gothic',sans-serif}
.delpg{position:absolute;top:-11px;right:-11px;width:24px;height:24px;border-radius:50%;background:#ef4444;border:none;color:#fff;font-size:15px;cursor:pointer;display:flex;align-items:center;justify-content:center;z-index:10;transition:.15s;line-height:1}
.delpg:hover{background:#b91c1c;transform:scale(1.1)}
.addpgwrap{display:flex;justify-content:center;padding:18px 0 38px}
.addpgbtn{background:var(--bg3);border:2px dashed var(--bdr);border-radius:10px;color:var(--m2);font-size:14px;padding:11px 40px;cursor:pointer;transition:.2s;font-family:'Noto Sans KR',sans-serif}
.addpgbtn:hover{border-color:var(--or);color:var(--or);background:rgba(249,115,22,.07)}
/* zoom */
.zoompanel{position:fixed;bottom:14px;right:234px;z-index:300;background:rgba(23,27,36,.88);backdrop-filter:blur(12px);border:1px solid var(--bdr);border-radius:10px;padding:5px 9px;display:flex;align-items:center;gap:6px}
.zb{background:var(--bg4);border:1px solid var(--bdr);color:var(--m2);border-radius:6px;padding:3px 10px;cursor:pointer;font-size:13px;transition:.1s}.zb:hover{background:var(--bg3);color:#fff}
#zdisp{font-size:13px;color:#fff;min-width:38px;text-align:center}
/* toast */
.toast{position:fixed;bottom:74px;left:50%;transform:translateX(-50%) translateY(18px);background:#1e293b;color:#e2e8f0;padding:7px 17px;border-radius:20px;font-size:13px;opacity:0;transition:.28s;pointer-events:none;z-index:9999;border:1px solid var(--bdr)}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
@media print{
  body{overflow:visible!important;height:auto}
  .nav,.toolbar,.fmtbar,.settings,.zoompanel,.toast,.delpg,.addpgwrap{display:none!important}
  .preview{padding:0!important;overflow:visible!important;display:flex!important;}.main-area{overflow:visible!important}
  .scalewrap{transform:none!important}
  .sheet{box-shadow:none;width:210mm;height:297mm;padding:15mm}
  .pagewrap{break-after:page}
  @page{size:A4 portrait;margin:0}
}
</style>
<script src="auth.js"></script>
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ì–‘ì‹ ì €ì¥ / ë¶ˆëŸ¬ì˜¤ê¸° (localStorage, ì‚¬ìš©ìë³„)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getSaveKey() {
  const p = AUTH.isUser() ? AUTH.getUserProfile() : (AUTH.isAdmin() ? AUTH.getProfile() : null);
  if (!p || !p.email) return null;
  return 'pb_saves_' + p.email.replace(/[^a-zA-Z0-9]/g,'_');
}
function loadSaves() {
  const key = getSaveKey(); if (!key) return [];
  try { return JSON.parse(localStorage.getItem(key) || '[]'); } catch { return []; }
}
function writeSaves(list) {
  const key = getSaveKey(); if (!key) return;
  localStorage.setItem(key, JSON.stringify(list));
}

function renderSavePanel() {
  const body = document.getElementById('savePanelBody');
  const btn  = document.getElementById('spSaveBtn');
  if (!body) return;
  const loggedIn = AUTH.isLoggedIn();
  btn.disabled = !loggedIn;
  if (!loggedIn) {
    body.innerHTML = `<div class="sp-login-prompt">
      ğŸ”’ ë¡œê·¸ì¸í•˜ë©´<br>ì–‘ì‹ì„ ì €ì¥í•˜ê³ <br>ì–¸ì œë“  ë¶ˆëŸ¬ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
      <button class="sp-login-prompt-btn" onclick="AUTH.toggleUserDropdown()">êµ¬ê¸€ë¡œ ë¡œê·¸ì¸</button>
    </div>`;
    return;
  }
  const saves = loadSaves();
  if (!saves.length) {
    body.innerHTML = '<div class="sp-empty">ì €ì¥ëœ ì–‘ì‹ì´ ì—†ìŠµë‹ˆë‹¤.<br>+ ì €ì¥ ë²„íŠ¼ì„ ëˆŒëŸ¬<br>í˜„ì¬ ì–‘ì‹ì„ ì €ì¥í•˜ì„¸ìš”.</div>';
  } else {
    body.innerHTML = '';
    const ul = document.createElement('div'); ul.className = 'sp-list';
    saves.forEach((s, idx) => {
      const item = document.createElement('div');
      item.className = 'sp-item' + (s.active ? ' active' : '');
      item.innerHTML = `
        <div class="sp-item-name">${s.name}</div>
        <div class="sp-item-meta">${s.date} Â· ${s.pages}í˜ì´ì§€</div>
        <button class="sp-item-del" onclick="deleteSave(${idx},event)" title="ì‚­ì œ">Ã—</button>`;
      item.addEventListener('click', () => loadSave(idx));
      ul.appendChild(item);
    });
    body.appendChild(ul);
  }
  // ìƒˆ ì–‘ì‹ ë²„íŠ¼
  const nb = document.createElement('button'); nb.className='sp-new-btn'; nb.textContent='+ ìƒˆ ì–‘ì‹ ì‹œì‘';
  nb.onclick = () => { resetForm(); };
  body.appendChild(nb);
}

let pendingSaveName = '';

function showLoginRequired() {
  let el = document.getElementById('loginRequiredToast');
  if (!el) {
    el = document.createElement('div');
    el.id = 'loginRequiredToast';
    el.innerHTML = `
      <div style="font-size:28px;margin-bottom:10px">ğŸ”’</div>
      <div style="font-size:14px;font-weight:700;color:#e2e8f0;margin-bottom:6px">ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤</div>
      <div style="font-size:12px;color:var(--m2);line-height:1.7;margin-bottom:16px">ì €ì¥ ê¸°ëŠ¥ì€ ë¡œê·¸ì¸í•œ ì‚¬ìš©ìë§Œ<br>ì´ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
      <button onclick="AUTH.toggleUserDropdown();hideLoginRequired()" style="width:100%;padding:9px;border-radius:7px;background:#3b82f6;border:none;color:#fff;font-size:12px;font-weight:700;cursor:pointer;font-family:'Noto Sans KR',sans-serif;margin-bottom:7px">êµ¬ê¸€ë¡œ ë¡œê·¸ì¸</button>
      <button onclick="hideLoginRequired()" style="width:100%;padding:7px;border-radius:7px;background:var(--bg4);border:1px solid var(--bdr);color:var(--m2);font-size:12px;cursor:pointer;font-family:'Noto Sans KR',sans-serif">ë‹«ê¸°</button>`;
    document.body.appendChild(el);
    el.addEventListener('click', e => { if(e.target === el) hideLoginRequired(); });
  }
  el.classList.add('show');
  clearTimeout(el._t);
  el._t = setTimeout(hideLoginRequired, 5000);
}
function hideLoginRequired() {
  const el = document.getElementById('loginRequiredToast');
  if (el) el.classList.remove('show');
}

function openSaveModal() {
  if (!AUTH.isLoggedIn()) { showLoginRequired(); return; }
  const site = document.getElementById('siteName').value || '';
  document.getElementById('saveModalInp').value = site || '';
  document.getElementById('saveModal').classList.add('open');
  document.getElementById('saveModalInp').focus();
}
function closeSaveModal() { document.getElementById('saveModal').classList.remove('open'); }
document.getElementById('saveModal').addEventListener('click', e => { if(e.target.id==='saveModal') closeSaveModal(); });
document.getElementById('saveModalInp').addEventListener('keydown', e => { if(e.key==='Enter') confirmSave(); if(e.key==='Escape') closeSaveModal(); });

function confirmSave() {
  const name = document.getElementById('saveModalInp').value.trim();
  if (!name) { document.getElementById('saveModalInp').focus(); return; }
  const saves = loadSaves();
  const now = new Date();
  const dateStr = `${now.getFullYear()}.${String(now.getMonth()+1).padStart(2,'0')}.${String(now.getDate()).padStart(2,'0')}`;
  // pages ì§ë ¬í™” (ì´ë¯¸ì§€ëŠ” base64 ê·¸ëŒ€ë¡œ)
  const snapshot = JSON.parse(JSON.stringify(pages));
  const entry = {
    name, date: dateStr, pages: snapshot.length,
    siteName: document.getElementById('siteName').value,
    docTitle: document.getElementById('docTitle').value,
    slotCount, showPN,
    data: snapshot,
    id: Date.now()
  };
  saves.unshift(entry);
  if (saves.length > 30) saves.splice(30); // ìµœëŒ€ 30ê°œ
  writeSaves(saves);
  closeSaveModal();
  renderSavePanel();
  toast(`"${name}" ì €ì¥ë¨`);
}

function loadSave(idx) {
  const saves = loadSaves();
  const entry = saves[idx]; if (!entry) return;
  saveUndo();
  pages.length = 0;
  entry.data.forEach(pg => pages.push(pg));
  slotCount = entry.slotCount || 6;
  showPN = entry.showPN ?? true;
  document.getElementById('siteName').value = entry.siteName || '';
  document.getElementById('docTitle').value = entry.docTitle || 'ì‚¬ì§„ëŒ€ì§€';
  // slotCount ë“œë¡­ë‹¤ìš´ ë™ê¸°í™”
  const sel = document.getElementById('slotSel');
  if (sel) sel.value = String(slotCount);
  syncSite(entry.siteName||''); syncTitle(entry.docTitle||'ì‚¬ì§„ëŒ€ì§€'); syncNavSite(entry.siteName||'');
  sel?.dispatchEvent ? null : null;
  renderAll(); renderSavePanel(); toast(`"${entry.name}" ë¶ˆëŸ¬ì˜´`);
}

function deleteSave(idx, e) {
  e.stopPropagation();
  const saves = loadSaves();
  const name = saves[idx]?.name || '';
  saves.splice(idx, 1);
  writeSaves(saves);
  renderSavePanel();
  toast(`"${name}" ì‚­ì œë¨`);
}

// ë¡œê·¸ì¸ ìƒíƒœ ë³€ê²½ ì‹œ íŒ¨ë„ ê°±ì‹ 
window.onAuthStateChange = () => renderSavePanel();
window.onUserLogin  = () => renderSavePanel();
window.onUserLogout = () => renderSavePanel();


</script>
<script src="https://accounts.google.com/gsi/client" async></script>
</head>
<body>

<nav class="nav">
  <a class="logo" href="index.html"><span style="color:var(--or)">âš </span> <span>SAFETY</span></a>
  <a class="nav-back" href="index.html">â† í™ˆ</a>
  <span class="nav-sep">|</span>
  <div class="nav-site" id="navSite">ì‚¬ì§„ëŒ€ì§€ ì‘ì„±</div>
  <div class="nav-right" id="navRight"></div>
</nav>

<div class="toolbar">
  <div class="tl">ì‚¬ì§„ëŒ€ì§€ ì‘ì„±</div>
  <button class="btn g" onclick="resetForm()">â†º ì´ˆê¸°í™”</button>
  <button class="btn g" id="undoBtn" onclick="undo()" disabled>â†© ë˜ëŒë¦¬ê¸°</button>
  <button class="btn g" id="addSlotBtn" onclick="addSlot()">+ ì¹¸ ì¶”ê°€ (í˜„ì¬ 6ì¹¸)</button>
  <button class="btn g" id="rmSlotBtn" onclick="removeSlot()" style="display:none">âˆ’ ì¹¸ ì œê±°</button>
  <button class="btn green" onclick="saveExcel()">ğŸ“Š ì—‘ì…€ ì €ì¥</button>
  <button class="btn orange" onclick="printPDF()">ğŸ–¨ PDF ì €ì¥</button>
</div>

<div class="fmtbar">
  <span class="flbl">ê¸€ê¼´</span>
  <select class="fsel" id="fmtFont" onchange="applyFmt('font',this.value)" style="width:108px">
    <option value="'Malgun Gothic',sans-serif" selected>ë§‘ì€ ê³ ë”•</option>
    <option value="'Noto Sans KR',sans-serif">Noto Sans</option>
    <option value="Arial,sans-serif">Arial</option>
    <option value="'Times New Roman',serif">Times</option>
  </select>
  <button class="fb" id="colorBtn" onclick="togglePalette(event)" title="ê¸€ê¼´ ìƒ‰ìƒ" style="padding:0 6px;flex-direction:column;gap:1px;height:26px">
    <span style="font-size:14px;font-weight:700;font-family:'Malgun Gothic',sans-serif;line-height:1.3;color:currentColor">ê°€</span>
    <span id="colorBar" style="display:block;width:18px;height:4px;background:#e84040;border-radius:1px"></span>
  </button>
  <div id="colorPalette" style="display:none;position:fixed;z-index:9000;background:#1e2330;border:1px solid #2e3448;border-radius:8px;padding:10px;box-shadow:0 8px 32px rgba(0,0,0,.7)">
    <div style="font-size:10px;color:#94a3b8;margin-bottom:6px">ìë™</div>
    <div style="display:flex;gap:4px;margin-bottom:8px">
      <div class="csw auto-color" style="width:22px;height:22px;background:#111;border:2px solid #f97316;border-radius:3px;cursor:pointer" onclick="pickColor('#111111')" title="ìë™"></div>
    </div>
    <div style="font-size:10px;color:#94a3b8;margin-bottom:5px">í…Œë§ˆ ìƒ‰</div>
    <div id="themeColors" style="display:grid;grid-template-columns:repeat(10,22px);gap:3px;margin-bottom:8px"></div>
    <div style="font-size:10px;color:#94a3b8;margin-bottom:5px">í‘œì¤€ ìƒ‰</div>
    <div id="stdColors" style="display:grid;grid-template-columns:repeat(10,22px);gap:3px;margin-bottom:8px"></div>
    <div style="font-size:10px;color:#94a3b8;margin-bottom:5px">ìµœê·¼ ìƒ‰</div>
    <div id="recentColors" style="display:grid;grid-template-columns:repeat(10,22px);gap:3px"></div>
  </div>
  <span class="flbl">í¬ê¸°</span>
  <button class="fb" style="min-width:20px;font-size:14px;font-weight:700" onclick="qFont(-1)">âˆ’</button>
  <input class="fnum" type="number" id="fmtSize" value="11" min="6" max="72" onchange="applyFmt('fontSize',this.value+'px')">
  <button class="fb" style="min-width:20px;font-size:14px;font-weight:700" onclick="qFont(1)">+</button>
  <div class="fsep"></div>
  <span class="flbl">ìê°„</span>
  <button class="fb" style="min-width:20px;font-size:14px;font-weight:700" onclick="qSpacing(-0.5)">âˆ’</button>
  <input class="fnum" type="number" id="fmtSpacing" value="0" min="-5" max="20" step="0.5" onchange="applyFmt('spacing',this.value+'px')" style="width:36px">
  <button class="fb" style="min-width:20px;font-size:14px;font-weight:700" onclick="qSpacing(0.5)">+</button>
  <div class="fsep"></div>
  <span class="flbl">ê°€ë¡œ</span>
  <button class="fb" id="AL" onclick="applyFmt('align','left')" title="ì™¼ìª½">
    <svg width="13" height="13" viewBox="0 0 13 13" fill="currentColor"><rect x="0" y="0" width="13" height="2" rx=".8"/><rect x="0" y="3.5" width="8" height="2" rx=".8"/><rect x="0" y="7" width="10" height="2" rx=".8"/><rect x="0" y="10.5" width="6" height="2" rx=".8"/></svg>
  </button>
  <button class="fb" id="AC" onclick="applyFmt('align','center')" title="ê°€ìš´ë°">
    <svg width="13" height="13" viewBox="0 0 13 13" fill="currentColor"><rect x="0" y="0" width="13" height="2" rx=".8"/><rect x="2.5" y="3.5" width="8" height="2" rx=".8"/><rect x="1.5" y="7" width="10" height="2" rx=".8"/><rect x="3.5" y="10.5" width="6" height="2" rx=".8"/></svg>
  </button>
  <button class="fb" id="AR" onclick="applyFmt('align','right')" title="ì˜¤ë¥¸ìª½">
    <svg width="13" height="13" viewBox="0 0 13 13" fill="currentColor"><rect x="0" y="0" width="13" height="2" rx=".8"/><rect x="5" y="3.5" width="8" height="2" rx=".8"/><rect x="3" y="7" width="10" height="2" rx=".8"/><rect x="7" y="10.5" width="6" height="2" rx=".8"/></svg>
  </button>
  <div style="width:1px;height:13px;background:#3e4559;margin:0 3px;flex-shrink:0"></div>
  <button class="fb" id="VT" onclick="applyFmt('valign','top')" title="ìœ„">
    <svg width="13" height="13" viewBox="0 0 13 13"><rect x="0" y="0" width="13" height="1.5" fill="currentColor" rx=".5"/><rect x="1" y="3" width="4" height="8" rx=".8" fill="currentColor" opacity=".5"/><rect x="8" y="3" width="4" height="5" rx=".8" fill="currentColor" opacity=".5"/></svg>
  </button>
  <button class="fb" id="VM" onclick="applyFmt('valign','middle')" title="ê°€ìš´ë°">
    <svg width="13" height="13" viewBox="0 0 13 13"><rect x="0" y="5.75" width="13" height="1.5" fill="currentColor" rx=".5"/><rect x="1" y="1" width="4" height="11" rx=".8" fill="currentColor" opacity=".5"/><rect x="8" y="3" width="4" height="7" rx=".8" fill="currentColor" opacity=".5"/></svg>
  </button>
  <button class="fb" id="VB" onclick="applyFmt('valign','bottom')" title="ì•„ë˜">
    <svg width="13" height="13" viewBox="0 0 13 13"><rect x="0" y="11.5" width="13" height="1.5" fill="currentColor" rx=".5"/><rect x="1" y="2" width="4" height="8" rx=".8" fill="currentColor" opacity=".5"/><rect x="8" y="5" width="4" height="5" rx=".8" fill="currentColor" opacity=".5"/></svg>
  </button>
  <div class="fsep"></div>
  <button class="fb" id="BOLD" onclick="applyFmt('bold',null)" style="font-weight:800;font-size:13px;padding:0 8px">B</button>
  <div class="fsep"></div>
  <span class="flbl">í…Œë‘ë¦¬</span>
  <button class="fb" id="BT" onclick="togBdr('bt')" title="ìœ„">
    <svg width="14" height="14" viewBox="0 0 14 14"><rect x="1" y="1" width="12" height="12" rx="1" fill="none" stroke="currentColor" stroke-width=".6" stroke-dasharray="1.5 1"/><line x1="1" y1="1" x2="13" y2="1" stroke="currentColor" stroke-width="2.5"/></svg>
  </button>
  <button class="fb" id="BB" onclick="togBdr('bb')" title="ì•„ë˜">
    <svg width="14" height="14" viewBox="0 0 14 14"><rect x="1" y="1" width="12" height="12" rx="1" fill="none" stroke="currentColor" stroke-width=".6" stroke-dasharray="1.5 1"/><line x1="1" y1="13" x2="13" y2="13" stroke="currentColor" stroke-width="2.5"/></svg>
  </button>
  <button class="fb" id="BL" onclick="togBdr('bl')" title="ì™¼">
    <svg width="14" height="14" viewBox="0 0 14 14"><rect x="1" y="1" width="12" height="12" rx="1" fill="none" stroke="currentColor" stroke-width=".6" stroke-dasharray="1.5 1"/><line x1="1" y1="1" x2="1" y2="13" stroke="currentColor" stroke-width="2.5"/></svg>
  </button>
  <button class="fb" id="BR" onclick="togBdr('br')" title="ì˜¤ë¥¸">
    <svg width="14" height="14" viewBox="0 0 14 14"><rect x="1" y="1" width="12" height="12" rx="1" fill="none" stroke="currentColor" stroke-width=".6" stroke-dasharray="1.5 1"/><line x1="13" y1="1" x2="13" y2="13" stroke="currentColor" stroke-width="2.5"/></svg>
  </button>
  <button class="fb" id="BALL" onclick="togBdr('all')" title="ì „ì²´">
    <svg width="14" height="14" viewBox="0 0 14 14"><rect x="1" y="1" width="12" height="12" rx="1" fill="none" stroke="currentColor" stroke-width="2.5"/></svg>
  </button>
  <button class="fb" id="BNONE" onclick="togBdr('none')" title="ì—†ìŒ">
    <svg width="14" height="14" viewBox="0 0 14 14"><rect x="1" y="1" width="12" height="12" rx="1" fill="none" stroke="currentColor" stroke-width=".6" stroke-dasharray="1.5 1"/><line x1="3" y1="3" x2="11" y2="11" stroke="#ef4444" stroke-width="1.8"/><line x1="11" y1="3" x2="3" y2="11" stroke="#ef4444" stroke-width="1.8"/></svg>
  </button>
  <div class="fsep"></div>
  <button class="fb" onclick="mergeSelected()">âŠ ë³‘í•©</button>
  <button class="fb" onclick="splitSelected()">âŠŸ ë¶„í• </button>
  <div class="fsep"></div>
  <span class="flbl">ì„¸ë¡œ</span>
  <button class="fb" style="min-width:20px" onclick="adjSz('h',-5)">âˆ’</button>
  <span id="sizeH" style="font-size:10px;color:var(--m2);min-width:32px;text-align:center">â€”</span>
  <button class="fb" style="min-width:20px" onclick="adjSz('h',5)">+</button>
  <div class="fsep"></div>
  <span class="flbl">ê°€ë¡œ</span>
  <button class="fb" style="min-width:20px" onclick="adjSz('w',-2)">âˆ’</button>
  <span id="sizeW" style="font-size:10px;color:var(--m2);min-width:32px;text-align:center">â€”</span>
  <button class="fb" style="min-width:20px" onclick="adjSz('w',2)">+</button>
  <div class="fsep"></div>
  <span id="fhint" class="fhint">ì…€ì„ í´ë¦­í•˜ì—¬ ì„ íƒ</span>
</div>

<div class="settings">
  <div class="sg"><label>í˜„ì¥ëª…</label>
    <input type="text" id="siteName" placeholder="í˜„ì¥ëª…ì„ ì…ë ¥í•˜ì„¸ìš”" oninput="syncSite(this.value)">
  </div>
  <div class="sg"><label>ë¬¸ì„œ ì œëª©</label>
    <input type="text" id="docTitle" value="ì‚¬ì§„ëŒ€ì§€" oninput="syncTitle(this.value)">
  </div>
  <div class="sg"><label>ì¹¸ ìˆ˜</label>
    <select onchange="setSlotCount(+this.value)">
      <option value="2">2ì¹¸ (1Ã—2)</option>
      <option value="4">4ì¹¸ (2Ã—2)</option>
      <option value="6" selected>6ì¹¸ (3Ã—2)</option>
      <option value="8">8ì¹¸ (4Ã—2)</option>
    </select>
  </div>
  <div class="sg"><label>ìª½ í‘œì‹œ</label>
    <button class="pntoggle on" id="pntoggle" onclick="togglePN()">í‘œì‹œ ì¼œì§</button>
  </div>
</div>

<!-- ì €ì¥ ëª¨ë‹¬ -->
<div id="saveModal">
  <div class="save-modal-box">
    <div class="save-modal-title">ğŸ’¾ ì–‘ì‹ ì €ì¥</div>
    <input class="save-modal-inp" id="saveModalInp" placeholder="ì €ì¥ ì´ë¦„ ì…ë ¥ (ì˜ˆ: ì„ë¬¸í˜¸ 3ì›”)" maxlength="40">
    <div class="save-modal-btns">
      <button class="save-modal-ok" onclick="confirmSave()">ì €ì¥</button>
      <button class="save-modal-cancel" onclick="closeSaveModal()">ì·¨ì†Œ</button>
    </div>
  </div>
</div>
<div class="main-area">
<!-- ì €ì¥ íŒ¨ë„ (ì¢Œì¸¡) -->
<div class="savepanel" id="savePanel">
  <div class="sp-hdr">
    <div class="sp-hdr-title">ğŸ“ ì €ì¥ëœ ì–‘ì‹</div>
    <button class="sp-save-btn" id="spSaveBtn" onclick="openSaveModal()">+ ì €ì¥</button>
  </div>
  <div id="savePanelBody"></div>
</div>
<div class="preview" id="preview">
  <div class="scalewrap" id="scalewrap">
    <div id="pgwrap"></div>
  </div>
<div class="zoompanel">
  <button class="zb" onclick="zOut()">âˆ’</button>
  <span id="zdisp">90%</span>
  <button class="zb" onclick="zIn()">+</button>
  <button class="zb" onclick="zFit()">ë§ì¶¤</button>
</div>
</div>
<!-- Side Panel -->
<div class="sidepanel">
  <div class="sp-section">
    <div class="sp-title">í˜„í™©</div>
    <div class="sp-stat"><span>ì´ ì¹¸</span><span id="stat-total">0</span></div>
    <div class="sp-stat filled"><span>ì±„ìš´ ì¹¸</span><span id="stat-filled">0</span></div>
    <div class="sp-stat waiting"><span>ëŒ€ê¸° ì‚¬ì§„</span><span id="stat-queue">0</span></div>
  </div>
  <label class="sp-drop" id="spDrop">
    <div class="sp-drop-icon">ğŸ–¼</div>
    <div class="sp-drop-txt">ì‚¬ì§„ ì¶”ê°€</div>
    <div class="sp-drop-sub">í´ë¦­í•˜ê±°ë‚˜<br>ë“œë˜ê·¸&amp;ë“œë¡­</div>
    <input type="file" id="spFileInput" accept="image/*" multiple>
  </label>
  <div class="sp-paste-hint">ğŸªŸ <kbd>Win</kbd>+<kbd>V</kbd> ë¡œ í´ë¦½ë³´ë“œ ì‚¬ì§„ ì¶”ê°€</div>
  <div class="sp-qwrap">
    <div class="sp-qlbl" id="spQlbl">ëŒ€ê¸° ì‚¬ì§„ (0)</div>
    <ul class="sp-queue" id="spQueue"></ul>
  </div>
  <button class="sp-assign-btn" id="spAssignBtn" onclick="assignQueue()" disabled>ë¹ˆ ì¹¸ì— ìˆœì„œëŒ€ë¡œ ë°°ì¹˜</button>
</div>
</div><!-- /main-area -->
</div>


<div class="toast" id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ìƒíƒœ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let slotCount = 6;
let showPN = true;
const pages = [];
const sel = new Set();   // "pi:si:ct" í˜•ì‹
const hist = [];         // undo stack
let zoom = 0.9;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ê¸°ë³¸ ë°ì´í„° ìƒì„±
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function autoSizeInput(inp) {
  let ruler = document.getElementById('__sinp_ruler__');
  if (!ruler) {
    ruler = document.createElement('span');
    ruler.id = '__sinp_ruler__';
    ruler.style.cssText = 'visibility:hidden;position:fixed;top:-9999px;left:-9999px;white-space:pre;pointer-events:none;';
    document.body.appendChild(ruler);
  }
  ruler.style.font = `${inp.style.fontWeight||'400'} ${inp.style.fontSize||'12px'} ${inp.style.fontFamily||"'Malgun Gothic',sans-serif"}`;
  ruler.textContent = inp.value || inp.placeholder || '';
  inp.style.width = Math.max(20, ruler.offsetWidth + 6) + 'px';
}
function defCell() {
  return {font:"'Malgun Gothic',sans-serif",sz:'11px',align:'left',bold:false,va:'middle',bt:0,bb:0,bl:0,br:0,color:'#111',spacing:'0px'};
}
function defLbl() {
  return {font:"'Malgun Gothic',sans-serif",sz:'10px',align:'center',bold:true,va:'middle',bt:0,bb:0,bl:0,br:0,color:'#444',spacing:'0px'};
}
function newSlot() {
  return {
    img:'',loc:'',date:'',desc:'',
    locLbl:'ìœ„ì¹˜',dateLbl:'ì¼ì‹œ',descLbl:'ë‚´ìš©',
    merged:false,
    ph:220,mh:22,dh:28,
    lw:38,dw:38,ew:38,
    cells:{
      photo:defCell(),
      loc:defCell(),date:defCell(),desc:defCell(),
      locLabel:defLbl(),dateLabel:defLbl(),descLabel:defLbl()
    }
  };
}
function ensureSlots(pg) {
  while (pg.slots.length < slotCount) pg.slots.push(newSlot());
  if (!pg.titleFmt) pg.titleFmt = {font:"'Malgun Gothic',sans-serif",sz:'20px',bold:true,color:'#002060',spacing:'4px'};
  if (!pg.siteFmt)  pg.siteFmt  = {font:"'Malgun Gothic',sans-serif",sz:'12px',bold:false,color:'#111'};
  if (!pg.siteLblFmt) pg.siteLblFmt = {font:"'Malgun Gothic',sans-serif",sz:'11px',bold:true,color:'#111'};
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Undo
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function saveUndo() {
  hist.push(JSON.stringify({
    slotCount,
    pgs: pages.map(p=>({slots:p.slots})),
    title: document.getElementById('docTitle').value,
    site: document.getElementById('siteName').value
  }));
  if (hist.length > 50) hist.shift();
  document.getElementById('undoBtn').disabled = false;
}
function applyColor(value) {
  document.getElementById('colorBar').style.background = value;
  applyFmt('color', value);
}
function undo() {
  if (!hist.length) { toast('ë˜ëŒë¦´ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤'); return; }
  const s = JSON.parse(hist.pop());
  slotCount = s.slotCount;
  pages.length = 0;
  s.pgs.forEach(p => pages.push({slots:p.slots}));
  document.getElementById('docTitle').value = s.title;
  document.getElementById('siteName').value = s.site;
  sel.clear();
  renderAll();
  if (!hist.length) document.getElementById('undoBtn').disabled = true;
  toast('â†© ë˜ëŒë¦¬ê¸°');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ë™ê¸°í™”
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function syncTitle(v) { document.querySelectorAll('.sync-title').forEach(e=>e.textContent=v); }
function syncNavSite(v) {
  const ns = document.getElementById('navSite');
  if (ns) ns.textContent = v ? `${v} â€” ì‚¬ì§„ëŒ€ì§€` : 'ì‚¬ì§„ëŒ€ì§€ ì‘ì„±';
}
function syncSite(v)  { document.querySelectorAll('.sync-site').forEach(e=>{ if(e.tagName==='INPUT') e.value=v; else if(e.contentEditable==='true'){if(e.textContent!==v)e.textContent=v;} else e.textContent=v; }); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ì…€ ì„ íƒ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function selCell(pi, si, ct, multi) {
  const k = `${pi}:${si}:${ct}`;
  if (!multi) sel.clear();
  if (sel.has(k)) sel.delete(k);
  else sel.add(k);
  refreshSel();
  refreshFmtBar();
}
function selHdr(pi, type) {
  sel.clear();
  sel.add(`${pi}:hdr:${type}`);
  refreshSel();
  refreshFmtBar();
}
let recentColors = [];
let paletteOpen = false;
function togglePalette(e) {
  e.stopPropagation();
  const pal = document.getElementById('colorPalette');
  if (paletteOpen) { pal.style.display='none'; paletteOpen=false; return; }
  // ìœ„ì¹˜ ê³„ì‚°
  const btn = document.getElementById('colorBtn');
  const r = btn.getBoundingClientRect();
  pal.style.top = (r.bottom+4)+'px';
  pal.style.left = r.left+'px';
  buildPalette();
  pal.style.display='block';
  paletteOpen=true;
}
function buildPalette() {
  const theme = [
    ['#ffffff','#000000','#e7e6e6','#44546a','#4472c4','#ed7d31','#a9d18e','#ff0000','#ffff00','#92d050'],
    ['#f2f2f2','#7f7f7f','#d0cece','#d6dce4','#dae3f3','#fce4d6','#e2efda','#ffc7ce','#ffeb9c','#c6efce'],
    ['#d8d8d8','#595959','#aeabab','#adb9ca','#b4c6e7','#f8cbad','#c6e0b4','#ff8080','#ffd966','#70ad47'],
    ['#bfbfbf','#404040','#767171','#8497b0','#8faadc','#f4b183','#a9d18e','#ff0000','#ffbf00','#548235'],
    ['#a5a5a5','#262626','#3a3838','#323f4f','#2e75b6','#c55a11','#538135','#c00000','#bf8f00','#375623'],
  ];
  const std = ['#c00000','#ff0000','#ffc000','#ffff00','#92d050','#00b050','#00b0f0','#0070c0','#002060','#7030a0'];

  const tc = document.getElementById('themeColors'); tc.innerHTML='';
  const sc = document.getElementById('stdColors'); sc.innerHTML='';
  const rc = document.getElementById('recentColors'); rc.innerHTML='';

  theme.forEach(row=>row.forEach(col=>{
    const d=document.createElement('div'); d.className='csw';
    d.style.background=col; d.title=col;
    d.onclick=()=>pickColor(col);
    tc.appendChild(d);
  }));
  std.forEach(col=>{
    const d=document.createElement('div'); d.className='csw';
    d.style.background=col; d.title=col;
    d.onclick=()=>pickColor(col);
    sc.appendChild(d);
  });
  recentColors.slice(0,10).forEach(col=>{
    const d=document.createElement('div'); d.className='csw';
    d.style.background=col; d.title=col;
    d.onclick=()=>pickColor(col);
    rc.appendChild(d);
  });
}
function pickColor(val) {
  document.getElementById('colorPalette').style.display='none'; paletteOpen=false;
  document.getElementById('colorBar').style.background=val;
  if (!recentColors.includes(val)) { recentColors.unshift(val); if(recentColors.length>10) recentColors.pop(); }
  applyFmt('color',val);
}
document.addEventListener('click',()=>{ if(paletteOpen){document.getElementById('colorPalette').style.display='none';paletteOpen=false;} });
function refreshSel() {
  document.querySelectorAll('.sel').forEach(el => {
    const slot = el.closest('[data-idx]');
    if (!slot) return;
    const active = sel.has(`${slot.dataset.page}:${slot.dataset.idx}:${el.dataset.ct}`);
    el.classList.toggle('on', active);
  });
  // hdr ìš”ì†Œ í•˜ì´ë¼ì´íŠ¸
  document.querySelectorAll('[data-hdr-page]').forEach(el => {
    const active = sel.has(`${el.dataset.hdrPage}:hdr:${el.dataset.hdrType}`);
    el.style.outline = active ? '2px solid #f97316' : '';
    el.style.outlineOffset = active ? '-1px' : '';
    if (el.tagName==='INPUT'||el.tagName==='DIV') el.style.background = active ? '#fff3e0' : '';
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  í¬ë§·ë°” ê°±ì‹  â€” ë‹¨ í•˜ë‚˜ì˜ í•¨ìˆ˜ê°€ ëª¨ë“  ë²„íŠ¼ ì²˜ë¦¬
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const BTN_IDS = ['AL','AC','AR','VT','VM','VB','BOLD','BT','BB','BL','BR','BALL','BNONE'];
function refreshFmtBar() {
  // 1) í•­ìƒ ì „ë¶€ ì´ˆê¸°í™”
  BTN_IDS.forEach(id => {
    const el = document.getElementById(id);
    if (el) el.classList.remove('on');
  });
  document.getElementById('fhint').textContent = 'ì…€ì„ í´ë¦­í•˜ì—¬ ì„ íƒ';
  document.getElementById('sizeH').textContent = 'â€”';
  document.getElementById('sizeW').textContent = 'â€”';

  if (!sel.size) return;

  // 2) ì²« ë²ˆì§¸ ì„ íƒ ì…€ì˜ ë°ì´í„°ë¡œ ë²„íŠ¼ ìƒíƒœ ì„¤ì •
  const [pi,si,ct] = [...sel][0].split(':');

  // í—¤ë”(ì œëª©/í˜„ì¥ëª…) íŠ¹ìˆ˜ ì²˜ë¦¬
  if (si === 'hdr') {
    const pg = pages[+pi]; if (!pg) return;
    const f = ct==='title' ? pg.titleFmt : ct==='sitelabel' ? pg.siteLblFmt : pg.siteFmt;
    if (!f) return;
    document.getElementById('fmtFont').value = f.font||"'Malgun Gothic',sans-serif";
    document.getElementById('fmtSize').value = parseInt(f.sz)||11;
    document.getElementById('fmtSpacing').value = parseFloat(f.spacing)||0;
    document.getElementById('colorBar').style.background = f.color||'#111111';
    const hintMap={title:'ë¬¸ì„œ ì œëª© ì„ íƒë¨',site:'í˜„ì¥ëª… ì„ íƒë¨',sitelabel:'í˜„ì¥ëª… ë¼ë²¨ ì„ íƒë¨'};
    document.getElementById('fhint').textContent = hintMap[ct]||'';
    if (f.bold) document.getElementById('BOLD').classList.add('on');
    return;
  }

  const d = pages[+pi]?.slots[+si];
  const f = d?.cells[ct];
  if (!f) return;

  // í°íŠ¸/í¬ê¸°
  document.getElementById('fmtFont').value = f.font;
  document.getElementById('fmtSize').value = parseInt(f.sz) || 11;
  document.getElementById('fmtSpacing').value = parseFloat(f.spacing)||0;

  // ê°€ë¡œ ì •ë ¬
  const aMap = {left:'AL', center:'AC', right:'AR'};
  if (aMap[f.align]) document.getElementById(aMap[f.align]).classList.add('on');

  // ì„¸ë¡œ ì •ë ¬
  const vMap = {top:'VT', middle:'VM', bottom:'VB'};
  if (vMap[f.va]) document.getElementById(vMap[f.va]).classList.add('on');

  // ìƒ‰ìƒ
  const col = f.color || '#111111';
  document.getElementById('colorBar').style.background = col;

  // ë³¼ë“œ
  if (f.bold) document.getElementById('BOLD').classList.add('on');

  // í…Œë‘ë¦¬
  if (f.bt) document.getElementById('BT').classList.add('on');
  if (f.bb) document.getElementById('BB').classList.add('on');
  if (f.bl) document.getElementById('BL').classList.add('on');
  if (f.br) document.getElementById('BR').classList.add('on');
  if (f.bt && f.bb && f.bl && f.br) document.getElementById('BALL').classList.add('on');
  if (!f.bt && !f.bb && !f.bl && !f.br) document.getElementById('BNONE').classList.add('on');

  // íŒíŠ¸ & í¬ê¸°
  const lbl = {loc:'ìœ„ì¹˜',date:'ì¼ì‹œ',desc:'ë‚´ìš©',photo:'ì‚¬ì§„',locLabel:'ìœ„ì¹˜ë¼ë²¨',dateLabel:'ì¼ì‹œë¼ë²¨',descLabel:'ë‚´ìš©ë¼ë²¨'};
  document.getElementById('fhint').textContent =
    [...sel].map(k=>{const p=k.split(':');return `${+p[0]+1}p-${+p[1]+1}ë²ˆ ${lbl[p[2]]||p[2]}`;}).join(', ') + ' ì„ íƒë¨';

  if (ct==='photo') document.getElementById('sizeH').textContent = (d.ph||220)+'px';
  else if (['loc','locLabel','date','dateLabel'].includes(ct)) document.getElementById('sizeH').textContent = (d.mh||22)+'px';
  else if (['desc','descLabel'].includes(ct)) document.getElementById('sizeH').textContent = (d.dh||28)+'px';

  if (['loc','locLabel'].includes(ct)) document.getElementById('sizeW').textContent = (d.lw||38)+'px';
  else if (['date','dateLabel'].includes(ct)) document.getElementById('sizeW').textContent = (d.dw||38)+'px';
  else if (['desc','descLabel'].includes(ct)) document.getElementById('sizeW').textContent = (d.ew||38)+'px';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  í¬ë§· ì ìš©
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function applyFmt(type, value) {
  if (!sel.size) return;
  saveUndo();
  sel.forEach(k => {
    const [pi,si,ct] = k.split(':');
    if (si === 'hdr') {
      const pg = pages[+pi]; if (!pg) return;
      const f = ct==='title' ? pg.titleFmt : ct==='sitelabel' ? pg.siteLblFmt : pg.siteFmt;
      if (!f) return;
      if (type==='font')    { f.font=value; }
      if (type==='fontSize') { f.sz=value; }
      if (type==='bold')    { f.bold=!f.bold; }
      if (type==='spacing') { f.spacing=value; }
      if (type==='color')   { f.color=value; }
      // DOM ì¦‰ì‹œ ë°˜ì˜
      const el = document.querySelector(`[data-hdr-page="${pi}"][data-hdr-type="${ct}"]`);
      if (el) {
        el.style.fontFamily=f.font;
        el.style.fontSize=f.sz;
        el.style.fontWeight=f.bold?'700':'400';
        el.style.color=f.color;
        el.style.letterSpacing=f.spacing||'0px';
        if (ct==='site') el.style.textIndent=f.spacing||'0px';
        if (el.dataset.hdrType==='title') el.style.textIndent=f.spacing||'0px';
      }
      return;
    }
    const f = pages[+pi]?.slots[+si]?.cells[ct];
    if (!f) return;
    if (type==='font')    f.font = value;
    if (type==='fontSize') f.sz = value;
    if (type==='align')   f.align = value;
    if (type==='valign')  f.va = value;
    if (type==='bold')    f.bold = !f.bold;
    if (type==='spacing') f.spacing = value;
    if (type==='color')   f.color = value;
    applyFmtDOM(pi, si, ct, f);
  });
  refreshFmtBar();
}
function applyFmtDOM(pi, si, ct, f) {
  const slot = document.querySelector(`[data-page="${pi}"][data-idx="${si}"]`);
  if (!slot) return;
  const el = slot.querySelector(`[data-ct="${ct}"]`);
  if (!el) return;
  const jc = {left:'flex-start',center:'center',right:'flex-end'};
  const ai = {top:'flex-start',middle:'center',bottom:'flex-end'};
  const isLbl = ct.endsWith('Label');
  if (isLbl) {
    el.style.fontFamily = f.font;
    el.style.fontSize = f.sz;
    el.style.fontWeight = f.bold ? '700' : '400';
    el.style.color = f.color || '';
    el.style.letterSpacing = f.spacing || '0px';
    el.style.justifyContent = jc[f.align] || 'center';
    el.style.alignItems = ai[f.va] || 'center';
    const inp = el.querySelector('input');
    if (inp) { inp.style.textAlign = f.align || 'center'; inp.style.color = f.color || ''; inp.style.letterSpacing = f.spacing || '0px'; inp.style.textIndent = f.spacing || '0px'; }
  } else {
    el.style.fontFamily = f.font;
    el.style.fontSize = f.sz;
    el.style.fontWeight = f.bold ? '700' : '400';
    el.style.textAlign = f.align;
    el.style.color = f.color || '';
    el.style.letterSpacing = f.spacing || '0px';
  }
  applyBdrDOM(el, f);
}
function applyBdrDOM(el, f) {
  const b = '1.5px solid #333';
  el.style.borderTop    = f.bt ? b : '';
  el.style.borderBottom = f.bb ? b : '';
  el.style.borderLeft   = f.bl ? b : '';
  el.style.borderRight  = f.br ? b : '';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  í°íŠ¸ í¬ê¸° ë²„íŠ¼
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function qFont(d) {
  if (!sel.size) return;
  const [pi,si,ct] = [...sel][0].split(':');
  let f;
  if (si === 'hdr') {
    const pg = pages[+pi];
    f = ct==='title' ? pg?.titleFmt : ct==='sitelabel' ? pg?.siteLblFmt : pg?.siteFmt;
  } else {
    f = pages[+pi]?.slots[+si]?.cells[ct];
  }
  if (!f) return;
  const n = Math.max(6, Math.min(72, (parseInt(f.sz)||11) + d));
  applyFmt('fontSize', n+'px');
  document.getElementById('fmtSize').value = n;
}

function qSpacing(d) {
  if (!sel.size) return;
  const [pi,si,ct] = [...sel][0].split(':');
  let f;
  if (si === 'hdr') {
    const pg = pages[+pi];
    f = ct==='title' ? pg?.titleFmt : ct==='sitelabel' ? pg?.siteLblFmt : pg?.siteFmt;
  } else {
    f = pages[+pi]?.slots[+si]?.cells[ct];
  }
  if (!f) return;
  const n = Math.max(-5, Math.min(20, Math.round(((parseFloat(f.spacing)||0) + d)*10)/10));
  applyFmt('spacing', n+'px');
  document.getElementById('fmtSpacing').value = n;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  í…Œë‘ë¦¬ í† ê¸€
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function togBdr(side) {
  if (!sel.size) { toast('ì…€ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”'); return; }
  saveUndo();
  sel.forEach(k => {
    const [pi,si,ct] = k.split(':');
    const f = pages[+pi]?.slots[+si]?.cells[ct];
    if (!f) return;
    if (side==='all')  { f.bt=f.bb=f.bl=f.br=1; }
    else if (side==='none') { f.bt=f.bb=f.bl=f.br=0; }
    else { f[side] = f[side] ? 0 : 1; }
    const slot = document.querySelector(`[data-page="${pi}"][data-idx="${si}"]`);
    const el = slot?.querySelector(`[data-ct="${ct}"]`);
    if (el) applyBdrDOM(el, f);
  });
  refreshFmtBar();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  í¬ê¸° ì¡°ì ˆ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function adjSz(axis, delta) {
  if (axis === 'h') {
    (sel.size ? [...sel] : Array.from({length:slotCount},(_,i)=>`0:${i}:photo`)).forEach(k=>{
      const [pi,si,ct] = k.split(':');
      const d = pages[+pi]?.slots[+si]; if (!d) return;
      const slot = document.querySelector(`[data-page="${pi}"][data-idx="${si}"]`);
      if (ct==='photo'||(!sel.size)) {
        d.ph = Math.max(30, Math.min(600, (d.ph||220)+delta));
        const pa = slot?.querySelector('.photo'); if(pa){pa.style.flex='none';pa.style.height=d.ph+'px';}
      } else if (['loc','locLabel','date','dateLabel'].includes(ct)) {
        d.mh = Math.max(8, Math.min(80, (d.mh||22)+delta));
        const r = slot?.querySelector('.metarow');
        if(r){ r.style.minHeight=d.mh+'px'; r.style.height=d.mh+'px'; r.style.overflow='hidden'; }
      } else if (['desc','descLabel'].includes(ct)) {
        d.dh = Math.max(8, Math.min(200, (d.dh||28)+delta));
        const r = slot?.querySelector('.descrow');
        if(r){ r.style.minHeight=d.dh+'px'; r.style.height=d.dh+'px'; r.style.overflow='hidden'; }
        const ta = slot?.querySelector('.dinp');
        if(ta){ ta.style.minHeight=(d.dh-2)+'px'; ta.style.height=(d.dh-2)+'px'; }
      }
    });
  } else {
    (sel.size ? [...sel] : Array.from({length:slotCount},(_,i)=>`0:${i}:loc`)).forEach(k=>{
      const [pi,si,ct] = k.split(':');
      const d = pages[+pi]?.slots[+si]; if (!d) return;
      if (['loc','locLabel'].includes(ct)||!sel.size) {
        d.lw = Math.max(10, Math.min(120, (d.lw||38)+delta));
        if (!sel.size) d.dw = d.ew = d.lw;
        applyLW(+pi,+si);
      } else if (['date','dateLabel'].includes(ct)) {
        d.dw = Math.max(10, Math.min(120, (d.dw||38)+delta));
        applyLW(+pi,+si);
      } else if (['desc','descLabel'].includes(ct)) {
        d.ew = Math.max(10, Math.min(120, (d.ew||38)+delta));
        applyLW(+pi,+si);
      }
    });
  }
  refreshFmtBar();
}
function applyLW(pi, si) {
  const slot = document.querySelector(`[data-page="${pi}"][data-idx="${si}"]`); if (!slot) return;
  const d = pages[pi]?.slots[si]; if (!d) return;
  const lw=d.lw+'px', dw=d.dw+'px', ew=d.ew+'px';
  slot.style.setProperty('--lw',lw);
  slot.style.setProperty('--dw',dw);
  slot.style.setProperty('--ew',ew);
  const mr = slot.querySelector('.metarow');
  if (mr) mr.style.gridTemplateColumns = d.merged ? `${lw} 1fr` : `${lw} 1fr ${dw} 1fr`;
  const dl = slot.querySelector('.dlbl');
  if (dl) { dl.style.width=ew; dl.style.minWidth=ew; dl.style.maxWidth=ew; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ë³‘í•© / ë¶„í• 
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function mergeSelected() {
  if (!sel.size) { toast('ì…€ì„ ì„ íƒí•˜ì„¸ìš”'); return; }
  saveUndo();
  const done = new Set();
  [...sel].forEach(k=>{
    const [pi,si] = k.split(':'); const key=`${pi}:${si}`;
    if (done.has(key)) return; done.add(key);
    const d = pages[+pi]?.slots[+si]; if (!d||d.merged) return;
    if (d.date) d.loc += (d.loc?' ':'')+d.date;
    d.merged = true;
  });
  renderAll(); toast('ë³‘í•©ë¨');
}
function splitSelected() {
  if (!sel.size) { toast('ì…€ì„ ì„ íƒí•˜ì„¸ìš”'); return; }
  saveUndo();
  const done = new Set();
  [...sel].forEach(k=>{
    const [pi,si] = k.split(':'); const key=`${pi}:${si}`;
    if (done.has(key)) return; done.add(key);
    const d = pages[+pi]?.slots[+si]; if (d) d.merged = false;
  });
  renderAll(); toast('ë¶„í• ë¨');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  cStyle í—¬í¼
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function cStyle(f, isLbl) {
  if (!f) return '';
  const jc = {left:'flex-start',center:'center',right:'flex-end'};
  const ai = {top:'flex-start',middle:'center',bottom:'flex-end'};
  const b = '1.5px solid #333';
  const bdr = `border-top:${f.bt?b:''};border-bottom:${f.bb?b:''};border-left:${f.bl?b:''};border-right:${f.br?b:''}`;
  if (isLbl) return `display:flex;font-family:${f.font};font-size:${f.sz};font-weight:${f.bold?'700':'400'};letter-spacing:${f.spacing||'0px'};justify-content:${jc[f.align]||'center'};align-items:${ai[f.va||'middle']||'center'};overflow:hidden;box-sizing:border-box;${bdr}`;
  return `font-family:${f.font};font-size:${f.sz};text-align:${f.align};font-weight:${f.bold?'700':'400'};letter-spacing:${f.spacing||'0px'};${bdr}`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ìŠ¬ë¡¯ DOM ìƒì„±
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function makeSlot(pi, si, d) {
  d = d || newSlot();
  const lw=d.lw+'px', dw=d.dw+'px', ew=d.ew+'px';
  const div = document.createElement('div');
  div.className = 'slot'; div.dataset.idx = si; div.dataset.page = pi;
  div.style.setProperty('--lw',lw); div.style.setProperty('--dw',dw); div.style.setProperty('--ew',ew);

  // ì‚¬ì§„
  const pa = document.createElement('div');
  pa.className = 'photo sel'; pa.dataset.ct = 'photo';
  if (sel.has(`${pi}:${si}:photo`)) pa.classList.add('on');
  if (d.ph !== 220) { pa.style.flex='none'; pa.style.height=d.ph+'px'; }
  pa.addEventListener('click', e => {
    if (e.target.closest('input[type=file],button')) return;
    e.stopPropagation(); selCell(pi, si, 'photo', e.ctrlKey||e.metaKey);
  });
  pa.addEventListener('dragover', e => {
    if (e.dataTransfer.types.includes('queue-idx') || e.dataTransfer.types.includes('Files')) {
      e.preventDefault(); pa.classList.add('drop-hover');
    }
  });
  pa.addEventListener('dragleave', () => pa.classList.remove('drop-hover'));
  pa.addEventListener('drop', e => {
    e.preventDefault(); pa.classList.remove('drop-hover');
    // íì—ì„œ ë“œë˜ê·¸
    const qi = e.dataTransfer.getData('queue-idx');
    if (qi !== '') {
      const item = photoQueue[+qi];
      if (item) { saveUndo(); d.img = item.dataUrl; photoQueue.splice(+qi,1); renderQueue(); renderAll(); updateSideStat();
const _initSite = document.getElementById('siteName').value;
if (_initSite) syncNavSite(_initSite);
renderSavePanel(); }
      return;
    }
    // íŒŒì¼ ë“œë˜ê·¸
    const file = [...e.dataTransfer.files].find(f=>f.type.startsWith('image/'));
    if (file) {
      const r = new FileReader();
      r.onload = ev => { saveUndo(); d.img=ev.target.result; renderAll(); updateSideStat(); };
      r.readAsDataURL(file);
    }
  });
  const numEl = document.createElement('div');
  numEl.className = 'slotnum'; numEl.textContent = si+1;
  pa.appendChild(numEl);
  if (d.img) {
    const img = document.createElement('img'); img.src = d.img;
    const del = document.createElement('button'); del.className='delp'; del.textContent='âœ•';
    del.onclick = e => { e.stopPropagation(); saveUndo(); d.img=''; renderAll(); };
    pa.append(img, del);
  } else {
    const hint = document.createElement('div'); hint.className='uphint';
    hint.innerHTML=`<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg><span>ì‚¬ì§„ í´ë¦­ or ë“œë˜ê·¸</span>`;
    const fi = document.createElement('input'); fi.type='file'; fi.accept='image/*';
    fi.onchange = e => {
      const file = e.target.files[0]; if (!file) return;
      const r = new FileReader();
      r.onload = ev => { saveUndo(); d.img=ev.target.result; renderAll(); };
      r.readAsDataURL(file);
    };
    pa.append(hint, fi);
  }
  div.appendChild(pa);

  // ìœ„ì¹˜+ì¼ì‹œ í–‰
  const mr = document.createElement('div');
  mr.className = 'metarow'; mr.style.minHeight = d.mh+'px'; mr.style.height = d.mh+'px'; mr.style.overflow='hidden';
  mr.style.gridTemplateColumns = d.merged ? `${lw} 1fr` : `${lw} 1fr ${dw} 1fr`;

  function mkLbl(ct, txtKey, extraCls) {
    const lbl = document.createElement('div');
    lbl.className = 'mlbl sel' + (extraCls?' '+extraCls:'');
    lbl.dataset.ct = ct;
    if (sel.has(`${pi}:${si}:${ct}`)) lbl.classList.add('on');
    lbl.style.cssText = cStyle(d.cells[ct], true);
    const inp = document.createElement('input'); inp.type='text'; inp.value=d[txtKey]||'';
    inp.style.cssText = `background:none;border:none;outline:none;padding:0;margin:0;font:inherit;color:inherit;text-align:${d.cells[ct]?.align||'center'};width:100%;min-width:0;cursor:text;letter-spacing:inherit;text-indent:${d.cells[ct]?.spacing||'0px'}`;
    inp.oninput = ev => { saveUndo(); d[txtKey]=ev.target.value; };
    inp.onfocus = ev => { ev.stopPropagation(); selCell(pi,si,ct,false); };
    lbl.appendChild(inp);
    lbl.addEventListener('click', e=>{ if(e.target===lbl)inp.focus(); e.stopPropagation(); selCell(pi,si,ct,e.ctrlKey||e.metaKey); });
    return lbl;
  }
  function mkInp(ct, val, ph) {
    const inp = document.createElement('input');
    inp.className = 'minp sel'; inp.dataset.ct = ct;
    if (sel.has(`${pi}:${si}:${ct}`)) inp.classList.add('on');
    inp.value=val; inp.placeholder=ph; inp.style.cssText=cStyle(d.cells[ct],false);
    inp.oninput = ev => { saveUndo(); d[ct==='loc'?'loc':'date']=ev.target.value; };
    inp.addEventListener('click', e=>{ e.stopPropagation(); selCell(pi,si,ct,e.ctrlKey||e.metaKey); });
    return inp;
  }
  const lblLoc  = mkLbl('locLabel','locLbl',null);
  const inpLoc  = mkInp('loc', d.loc, 'ì´¬ì˜ ìœ„ì¹˜');
  const lblDate = mkLbl('dateLabel','dateLbl','mlbl-sep');
  const inpDate = mkInp('date', d.date, 'YYYY-MM-DD');
  if (d.merged) { [lblDate,inpDate].forEach(e=>e.style.display='none'); }
  mr.append(lblLoc, inpLoc, lblDate, inpDate);
  div.appendChild(mr);

  // ë‚´ìš© í–‰
  const dr = document.createElement('div');
  dr.className = 'descrow'; dr.style.minHeight = d.dh+'px'; dr.style.height = d.dh+'px'; dr.style.overflow='hidden';
  const dlbl = document.createElement('div');
  dlbl.className = 'dlbl sel'; dlbl.dataset.ct = 'descLabel';
  if (sel.has(`${pi}:${si}:descLabel`)) dlbl.classList.add('on');
  dlbl.style.cssText = cStyle(d.cells.descLabel, true);
  dlbl.style.width=ew; dlbl.style.minWidth=ew; dlbl.style.maxWidth=ew;
  const dinpLbl = document.createElement('input'); dinpLbl.type='text'; dinpLbl.value=d.descLbl||'ë‚´ìš©';
  dinpLbl.style.cssText = `background:none;border:none;outline:none;padding:0;margin:0;font:inherit;color:inherit;text-align:${d.cells.descLabel?.align||'center'};width:100%;min-width:0;cursor:text`;
  dinpLbl.oninput = e=>{ saveUndo(); d.descLbl=e.target.value; };
  dinpLbl.onfocus = e=>{ e.stopPropagation(); selCell(pi,si,'descLabel',false); };
  dlbl.appendChild(dinpLbl);
  dlbl.addEventListener('click', e=>{ if(e.target===dlbl)dinpLbl.focus(); e.stopPropagation(); selCell(pi,si,'descLabel',e.ctrlKey||e.metaKey); });
  const ta = document.createElement('textarea');
  ta.className = 'dinp sel'; ta.dataset.ct = 'desc';
  if (sel.has(`${pi}:${si}:desc`)) ta.classList.add('on');
  ta.rows=2; ta.placeholder='ì‚¬ì§„ ì„¤ëª…'; ta.value=d.desc;
  ta.style.cssText = cStyle(d.cells.desc, false);
  ta.oninput = e=>{ saveUndo(); d.desc=e.target.value; };
  ta.addEventListener('click', e=>{ e.stopPropagation(); selCell(pi,si,'desc',e.ctrlKey||e.metaKey); });
  dr.append(dlbl, ta);
  div.appendChild(dr);
  return div;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ì „ì²´ ë Œë”
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const DECO='data:image/png;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/4gHYSUNDX1BST0ZJTEUAAQEAAAHIAAAAAAQwAABtbnRyUkdCIFhZWiAH4AABAAEAAAAAAABhY3NwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQAA9tYAAQAAAADTLQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAlkZXNjAAAA8AAAACRyWFlaAAABFAAAABRnWFlaAAABKAAAABRiWFlaAAABPAAAABR3dHB0AAABUAAAABRyVFJDAAABZAAAAChnVFJDAAABZAAAAChiVFJDAAABZAAAAChjcHJ0AAABjAAAADxtbHVjAAAAAAAAAAEAAAAMZW5VUwAAAAgAAAAcAHMAUgBHAEJYWVogAAAAAAAAb6IAADj1AAADkFhZWiAAAAAAAABimQAAt4UAABjaWFlaIAAAAAAAACSgAAAPhAAAts9YWVogAAAAAAAA9tYAAQAAAADTLXBhcmEAAAAAAAQAAAACZmYAAPKnAAANWQAAE9AAAApbAAAAAAAAAABtbHVjAAAAAAAAAAEAAAAMZW5VUwAAACAAAAAcAEcAbwBvAGcAbABlACAASQBuAGMALgAgADIAMAAxADb/2wBDAAUDBAQEAwUEBAQFBQUGBwwIBwcHBw8LCwkMEQ8SEhEPERETFhwXExQaFRERGCEYGh0dHx8fExciJCIeJBweHx7/2wBDAQUFBQcGBw4ICA4eFBEUHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh7/wAARCAAKB9ADASIAAhEBAxEB/8QAGAABAQEBAQAAAAAAAAAAAAAAAAYHBQj/xAAmEAEAAQIEBgIDAAAAAAAAAAAAAQIDBAUGEQcSEyEiURRBMWGB/8QAGQEBAAMBAQAAAAAAAAAAAAAAAAQFBgcD/8QAIREBAAIBAwQDAAAAAAAAAAAAAAECAwQFESExQnEVQZH/2gAMAwEAAhEDEQA/APOOlMy+dgIt3Kt79rxq/cfUuyhNEzMZzERMxE0Tuu3RNm1N9Rpa2v3jp+MfuWGuHPMV7T1AFoggAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAJ7V2cXMFFvD4W5NF+aormqJ70xH4aZozO7ee5HaxcTHWiOW9T6qhhupJmc7xO8zPn9rjgfVV8zH0c08vJTO2/bfdzDf8ANbU572t4zxHpM3nbsXxkZfKvE8+/pqgDNsCAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAJjiLqCMiyOvo17Yu/4WvdPur+KdjfGeqqdTW6ZqmaYsxtG/aHtgpF7xErjYtJTVa2tMnaOvvh/9k=';

function renderAll() {
  const title = document.getElementById('docTitle').value || 'ì‚¬ì§„ëŒ€ì§€';
  const site  = document.getElementById('siteName').value || '';
  const wrap  = document.getElementById('pgwrap');
  wrap.innerHTML = '';
  wrap.style.cssText = 'display:flex;flex-direction:column;gap:22px;align-items:center';

  pages.forEach((pg, pi) => {
    ensureSlots(pg);
    const pw = document.createElement('div'); pw.className='pagewrap';
    if (pages.length > 1) {
      const db = document.createElement('button'); db.className='delpg';
      db.textContent='Ã—'; db.title=`${pi+1}í˜ì´ì§€ ì‚­ì œ`;
      db.onclick = ()=>delPage(pi); pw.appendChild(db);
    }
    const sheet = document.createElement('div'); sheet.className='sheet';

    // í—¤ë”
    const hdr = document.createElement('div'); hdr.className='shdr';
    const htop = document.createElement('div'); htop.className='shdr-top';
    const tEl = document.createElement('div'); tEl.className='stitle'; tEl.textContent=title;
    tEl.dataset.hdrPage=pi; tEl.dataset.hdrType='title';
    const tf = pg.titleFmt||{}; tEl.style.fontFamily=tf.font||"'Malgun Gothic',sans-serif"; tEl.style.fontSize=tf.sz||'20px'; tEl.style.color=tf.color||'#002060'; tEl.style.fontWeight=tf.bold===false?'400':'700'; tEl.style.letterSpacing=tf.spacing||'4px'; tEl.style.textIndent=tf.spacing||'4px';
    tEl.addEventListener('click',e=>{e.stopPropagation();selHdr(pi,'title');});
    if (pi===0) {
      tEl.contentEditable = 'true';
      tEl.oninput = ()=>{ document.getElementById('docTitle').value=tEl.textContent; syncTitle(tEl.textContent); };
    } else {
      tEl.classList.add('sync-title');
    }
    const mDiv = document.createElement('div'); mDiv.className='smeta';
    const mLbl = document.createElement('div'); mLbl.className='smeta-lbl';
    mLbl.textContent='í˜„ì¥ëª… :';
    mLbl.dataset.hdrPage=pi; mLbl.dataset.hdrType='sitelabel';
    mLbl.style.cursor='pointer';
    const slf=pg.siteLblFmt||{}; if(slf.font)mLbl.style.fontFamily=slf.font; if(slf.sz)mLbl.style.fontSize=slf.sz; if(slf.color)mLbl.style.color=slf.color; if(slf.bold===false)mLbl.style.fontWeight='400';
    mLbl.addEventListener('click',e=>{e.stopPropagation();selHdr(pi,'sitelabel');});
    if (pi===0) {
      const sinp = document.createElement('div'); sinp.className='smeta-inp sync-site';
      sinp.contentEditable='true';
      sinp.dataset.hdrPage=pi; sinp.dataset.hdrType='site';
      sinp.textContent = site||'';
      if (!site) sinp.classList.add('sinp-empty');
      const sf=pg.siteFmt||{}; sinp.style.fontFamily=sf.font||"'Malgun Gothic',sans-serif"; sinp.style.fontSize=sf.sz||'12px'; sinp.style.color=sf.color||'#111'; sinp.style.fontWeight=sf.bold?'700':'400';
      sinp.addEventListener('input',()=>{
        const v=sinp.textContent;
        document.getElementById('siteName').value=v; syncSite(v); syncNavSite(v);
        sinp.classList.toggle('sinp-empty',!v.trim());
      });
      sinp.addEventListener('click',e=>{e.stopPropagation();selHdr(pi,'site');});
      sinp.addEventListener('focus',e=>{e.stopPropagation();selHdr(pi,'site');});
      mDiv.append(mLbl, sinp);
    } else {
      const sv = document.createElement('div'); sv.className='smeta-txt sync-site'; sv.textContent=site;
      sv.dataset.hdrPage=pi; sv.dataset.hdrType='site';
      const sf2=pg.siteFmt||{}; sv.style.fontFamily=sf2.font||"'Malgun Gothic',sans-serif"; sv.style.fontSize=sf2.sz||'12px'; sv.style.color=sf2.color||'#111'; sv.style.fontWeight=sf2.bold?'700':'400';
      sv.addEventListener('click',e=>{e.stopPropagation();selHdr(pi,'site');});
      mDiv.append(mLbl, sv);
    }
    htop.append(tEl, mDiv);
    const deco = document.createElement('img'); deco.className='sdeco'; deco.src=DECO;
    hdr.append(htop, deco); sheet.appendChild(hdr);

    // ê·¸ë¦¬ë“œ
    const grid = document.createElement('div'); grid.className='grid';
    for (let i=0; i<slotCount; i++) grid.appendChild(makeSlot(pi, i, pg.slots[i]));
    if (slotCount%2!==0) {
      const em = document.createElement('div');
      em.style.cssText='border:1.5px dashed #ddd;display:flex;align-items:center;justify-content:center;color:#ccc;font-size:12px';
      em.textContent='ë¹ˆ ì¹¸'; grid.appendChild(em);
    }
    sheet.appendChild(grid);

    const pn = document.createElement('div'); pn.className='pgnum';
    pn.textContent=`${pi+1} / ${pages.length}`;
    if (!showPN) pn.style.display='none';
    sheet.appendChild(pn);
    pw.appendChild(sheet); wrap.appendChild(pw);
  });

  // í˜ì´ì§€ ì¶”ê°€ ë²„íŠ¼
  const apw = document.createElement('div'); apw.className='addpgwrap';
  const apb = document.createElement('button'); apb.className='addpgbtn';
  apb.textContent='ï¼‹ í˜ì´ì§€ ì¶”ê°€'; apb.onclick=addPage;
  apw.appendChild(apb); wrap.appendChild(apw);

  document.getElementById('addSlotBtn').textContent=`+ ì¹¸ ì¶”ê°€ (í˜„ì¬ ${slotCount}ì¹¸)`;
  document.getElementById('rmSlotBtn').style.display = slotCount>2 ? '' : 'none';
  refreshSel();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  í˜ì´ì§€ ê´€ë¦¬
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addPage() {
  saveUndo();
  const pg={slots:[]}; ensureSlots(pg); pages.push(pg);
  renderAll();
  setTimeout(()=>{
    const pws=document.querySelectorAll('.pagewrap');
    if(pws.length) pws[pws.length-1].scrollIntoView({behavior:'smooth',block:'center'});
  },150);
}
function delPage(pi) {
  if (pages.length<=1) { toast('ë§ˆì§€ë§‰ í˜ì´ì§€ëŠ” ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤'); return; }
  saveUndo(); pages.splice(pi,1); renderAll();
  toast(`${pi+1}í˜ì´ì§€ ì‚­ì œë¨`);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ì¹¸ ìˆ˜
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setSlotCount(n) { saveUndo(); slotCount=n; pages.forEach(ensureSlots); renderAll(); }
function addSlot() {
  if (slotCount>=12) { toast('ìµœëŒ€ 12ì¹¸'); return; }
  saveUndo(); slotCount+=2;
  pages.forEach(pg=>{ pg.slots.push(newSlot()); pg.slots.push(newSlot()); });
  renderAll();
}
function removeSlot() { if(slotCount<=2) return; saveUndo(); slotCount-=2; renderAll(); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ì´ˆê¸°í™” / ì €ì¥
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function resetForm() {
  saveUndo();
  pages.length=0; sel.clear();
  const pg={slots:[]}; ensureSlots(pg); pages.push(pg);
  document.getElementById('siteName').value='';
  document.getElementById('docTitle').value='ì‚¬ì§„ëŒ€ì§€';
  syncSite(''); syncTitle('ì‚¬ì§„ëŒ€ì§€');
  renderAll(); toast('ì´ˆê¸°í™”ë¨');
}
function printPDF() { toast('ì¸ì‡„ ì°½ì—ì„œ "PDFë¡œ ì €ì¥" ì„ íƒ'); setTimeout(()=>window.print(),500); }
function saveExcel() { toast('ì—‘ì…€ ì €ì¥ ê¸°ëŠ¥ ì¤€ë¹„ ì¤‘'); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ìª½ í‘œì‹œ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function togglePN() {
  showPN = !showPN;
  const btn = document.getElementById('pntoggle');
  btn.textContent = showPN ? 'í‘œì‹œ ì¼œì§' : 'í‘œì‹œ êº¼ì§';
  btn.classList.toggle('on', showPN);
  document.querySelectorAll('.pgnum').forEach(e=>e.style.display=showPN?'':'none');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ì¤Œ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setZoom(v) {
  zoom = Math.max(0.3, Math.min(2, v));
  const w = document.getElementById('scalewrap');
  w.style.transform = `scale(${zoom})`;
  w.style.transformOrigin = 'top center';
  document.getElementById('zdisp').textContent = Math.round(zoom*100)+'%';
}
function zIn()  { setZoom(Math.round((zoom+0.1)*10)/10); }
function zOut() { setZoom(Math.round((zoom-0.1)*10)/10); }
function zFit() { const aw=window.innerWidth-80,ah=window.innerHeight-220; setZoom(Math.min(1,aw/794,ah/1123)); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  í† ìŠ¤íŠ¸
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let tT;
function toast(m) {
  const t=document.getElementById('toast');
  t.textContent=m; t.classList.add('show');
  clearTimeout(tT); tT=setTimeout(()=>t.classList.remove('show'),2000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ì „ì—­ ì´ë²¤íŠ¸
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('click', e=>{
  if (!e.target.closest('[data-idx],[data-ct],[data-hdr-page],.fmtbar')) {
    sel.clear(); refreshSel(); refreshFmtBar();
  }
});
document.addEventListener('keydown', e=>{
  if ((e.ctrlKey||e.metaKey)&&e.key==='z'&&!e.shiftKey) { e.preventDefault(); undo(); }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ì´ˆê¸° ì‹¤í–‰
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
pages.push({slots:[]});
ensureSlots(pages[0]);
renderAll();
setZoom(0.9);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ì‚¬ì´ë“œíŒ¨ë„ - ì‚¬ì§„ í
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let photoQueue = []; // {dataUrl, name}

function updateSideStat() {
  const total = pages.reduce((s,p)=>s+p.slots.length,0);
  const filled = pages.reduce((s,p)=>s+p.slots.filter(d=>d.img).length,0);
  document.getElementById('stat-total').textContent = total;
  document.getElementById('stat-filled').textContent = filled;
  document.getElementById('stat-queue').textContent = photoQueue.length;
  document.getElementById('spQlbl').textContent = `ëŒ€ê¸° ì‚¬ì§„ (${photoQueue.length})`;
  const btn = document.getElementById('spAssignBtn');
  btn.disabled = photoQueue.length === 0;
}

function addToQueue(files) {
  const remaining = [...files];
  function readNext() {
    if (!remaining.length) { renderQueue(); updateSideStat(); return; }
    const file = remaining.shift();
    const r = new FileReader();
    r.onload = ev => {
      photoQueue.push({dataUrl: ev.target.result, name: file.name});
      readNext();
    };
    r.readAsDataURL(file);
  }
  readNext();
}

function getEmptySlots() {
  const slots = [];
  for (let pi=0; pi<pages.length; pi++) {
    for (let si=0; si<pages[pi].slots.length; si++) {
      if (!pages[pi].slots[si].img) slots.push({pi, si, global: slots.length+1});
    }
  }
  return slots;
}
function renderQueue() {
  const ul = document.getElementById('spQueue');
  ul.innerHTML = '';
  const emptySlots = getEmptySlots();
  photoQueue.forEach((item, idx) => {
    const li = document.createElement('li'); li.className='sp-qitem';
    li.draggable = true;
    li.dataset.idx = idx;
    const img = document.createElement('img'); img.src = item.dataUrl;
    const name = document.createElement('span'); name.className='sp-qitem-name'; name.textContent = item.name;
    // ë°°ì¹˜ë  ìŠ¬ë¡¯ ì •ë³´
    const badge = document.createElement('div');
    if (idx < emptySlots.length) {
      const s = emptySlots[idx];
      const pageLabel = pages.length > 1 ? `P${s.pi+1}-` : '';
      badge.className = 'sp-qitem-badge';
      badge.textContent = `${pageLabel}${s.si+1}ë²ˆ`;
    } else {
      badge.className = 'sp-qitem-badge empty';
      badge.textContent = 'ë¯¸ë°°ì¹˜';
    }
    const del = document.createElement('button'); del.className='sp-qitem-del'; del.textContent='Ã—';
    del.onclick = e => { e.stopPropagation(); photoQueue.splice(idx,1); renderQueue(); updateSideStat(); };
    li.append(img, badge, name, del);
    // ë“œë˜ê·¸ ìˆœì„œ ë³€ê²½
    li.addEventListener('dragstart', e => { e.dataTransfer.setData('queue-idx', idx); e.dataTransfer.setData('text/plain', 'queue'); li.style.opacity='.4'; });
    li.addEventListener('dragend', () => li.style.opacity='1');
    li.addEventListener('dragover', e => {
      if (e.dataTransfer.types.includes('queue-idx')) { e.preventDefault(); li.classList.add('drag-over'); }
    });
    li.addEventListener('dragleave', () => li.classList.remove('drag-over'));
    li.addEventListener('drop', e => {
      e.preventDefault(); li.classList.remove('drag-over');
      const from = +e.dataTransfer.getData('queue-idx');
      const to = idx;
      if (isNaN(from) || from === to) return;
      const [moved] = photoQueue.splice(from, 1); photoQueue.splice(to, 0, moved);
      renderQueue();
    });
    ul.appendChild(li);
  });
}

function assignQueue() {
  if (!photoQueue.length) return;
  saveUndo();
  let qi = 0;
  for (const pg of pages) {
    for (const slot of pg.slots) {
      if (!slot.img && qi < photoQueue.length) {
        slot.img = photoQueue[qi].dataUrl;
        qi++;
      }
    }
  }
  photoQueue.splice(0, qi);
  renderQueue(); renderAll(); updateSideStat();
  toast(`${qi}ì¥ ë°°ì¹˜ ì™„ë£Œ`);
}

// ì‚¬ì§„ í íŒŒì¼ ì…ë ¥
document.getElementById('spFileInput').addEventListener('change', e => {
  addToQueue(e.target.files);
  e.target.value='';
});

// ë“œë˜ê·¸&ë“œë¡­ ì¡´
const spDrop = document.getElementById('spDrop');
spDrop.addEventListener('dragover', e => { e.preventDefault(); spDrop.style.borderColor='#f97316'; });
spDrop.addEventListener('dragleave', () => spDrop.style.borderColor='');
spDrop.addEventListener('drop', e => {
  e.preventDefault(); spDrop.style.borderColor='';
  const files = [...e.dataTransfer.files].filter(f=>f.type.startsWith('image/'));
  if (files.length) addToQueue(files);
});

// renderAll ì´í›„ stat ì—…ë°ì´íŠ¸
const _origRenderAll = renderAll;
renderAll = function() { _origRenderAll(); updateSideStat(); renderQueue(); };
updateSideStat();




// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  í´ë¦½ë³´ë“œ ë¶™ì—¬ë„£ê¸° ìº¡ì²˜
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function flashPaste() {
  const f = document.getElementById('pasteFlash');
  f.style.opacity='1'; setTimeout(()=>f.style.opacity='0',300);
}
function clipboardImageToQueue(blob) {
  const r = new FileReader();
  r.onload = ev => {
    const name=`ìº¡ì²˜_${new Date().toLocaleTimeString('ko-KR').replace(/:/g,'-')}.png`;
    photoQueue.push({dataUrl:ev.target.result, name});
    renderQueue(); updateSideStat(); flashPaste();
    toast('ìº¡ì²˜ ì‚¬ì§„ì´ ëŒ€ê¸°ì—´ì— ì¶”ê°€ë¨');
  };
  r.readAsDataURL(blob);
}
function pasteFromClipboard() { /* Ctrl+V ì‚¬ìš© */ }
// ì „ì—­ Ctrl+V ì´ë²¤íŠ¸
document.addEventListener('paste', e => {
  const items = e.clipboardData?.items;
  if (!items) return;
  for (const item of items) {
    if (item.type.startsWith('image/')) {
      e.preventDefault();
      clipboardImageToQueue(item.getAsFile());
      return;
    }
  }
});

</script>
<div class="paste-flash" id="pasteFlash"></div>

</body>
</html>
