<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>í˜„ì¥ì‚¬ì§„ ê°¤ëŸ¬ë¦¬ Â· Safety Portal</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&family=Bebas+Neue&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0f1117;--bg2:#171b24;--bg3:#1e2330;--bg4:#252a38;
  --border:#2c3347;--orange:#f97316;--blue:#3b82f6;
  --green:#22c55e;--red:#ef4444;--yellow:#eab308;
  --text:#f1f5f9;--muted:#64748b;--muted2:#94a3b8;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
html{scroll-behavior:smooth;}
body{font-family:'Noto Sans KR',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;}
body::before{content:'';position:fixed;inset:0;z-index:0;
  background-image:linear-gradient(rgba(249,115,22,.025) 1px,transparent 1px),
  linear-gradient(90deg,rgba(249,115,22,.025) 1px,transparent 1px);
  background-size:40px 40px;pointer-events:none;}

nav{position:sticky;top:0;z-index:100;background:rgba(15,17,23,.95);
  backdrop-filter:blur(16px);border-bottom:1px solid var(--border);
  padding:0 24px;display:flex;align-items:center;height:52px;gap:16px;}
.nav-logo{font-family:'Bebas Neue',sans-serif;font-size:20px;letter-spacing:.1em;color:var(--orange);text-decoration:none;}
.nav-logo span{color:var(--text);}
.nav-back{font-size:12px;color:var(--muted2);text-decoration:none;display:flex;align-items:center;gap:4px;padding:5px 10px;border-radius:6px;transition:all .15s;}
.nav-back:hover{color:var(--text);background:var(--bg3);}
.breadcrumb{display:flex;align-items:center;gap:6px;font-size:13px;overflow:hidden;flex-wrap:wrap;}
.bc-item{color:var(--muted2);cursor:pointer;white-space:nowrap;padding:3px 6px;border-radius:5px;transition:all .15s;}
.bc-item:hover{color:var(--text);background:var(--bg3);}
.bc-item.active{color:var(--text);font-weight:600;}
.bc-sep{color:var(--muted);font-size:11px;}
.nav-right{margin-left:auto;display:flex;align-items:center;gap:10px;}
.drive-badge{display:flex;align-items:center;gap:6px;font-size:12px;padding:4px 10px;border-radius:6px;border:1px solid var(--border);background:var(--bg3);cursor:pointer;transition:all .15s;}
.drive-badge:hover{border-color:var(--orange);}
.drive-dot{width:7px;height:7px;border-radius:50%;}
.drive-dot.on{background:var(--green);box-shadow:0 0 5px var(--green);}
.drive-dot.off{background:var(--red);}
.btn{padding:6px 14px;border-radius:7px;font-size:12px;font-weight:600;cursor:pointer;
  border:1px solid var(--border);background:var(--bg3);color:var(--muted2);
  transition:all .15s;font-family:'Noto Sans KR',sans-serif;white-space:nowrap;}
.btn:hover{color:var(--text);border-color:var(--muted);}
.btn.primary{background:var(--orange);border-color:var(--orange);color:#fff;}
.btn.primary:hover{background:#ea6c0a;}
.btn.danger{border-color:var(--red);color:var(--red);}
.btn.danger:hover{background:var(--red);color:#fff;}
.btn.sm{padding:4px 10px;font-size:11px;}
.btn.google{background:#fff;border-color:#ddd;color:#333;display:flex;align-items:center;gap:8px;}
.btn.google:hover{background:#f5f5f5;border-color:#bbb;}

/* ì—°ê²° í™”ë©´ */
.connect-screen{position:relative;z-index:1;display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:calc(100vh - 52px);padding:40px 24px;text-align:center;}
.connect-icon{font-size:64px;margin-bottom:20px;}
.connect-title{font-size:24px;font-weight:700;margin-bottom:10px;}
.connect-desc{font-size:14px;color:var(--muted2);line-height:1.7;margin-bottom:32px;max-width:420px;}
.connect-card{background:var(--bg2);border:1px solid var(--border);border-radius:14px;padding:28px;max-width:420px;width:100%;}
.connect-card h3{font-size:15px;font-weight:700;margin-bottom:16px;}
.connect-step{display:flex;align-items:flex-start;gap:12px;margin-bottom:14px;text-align:left;}
.step-num{width:22px;height:22px;border-radius:50%;background:var(--orange);color:#fff;font-size:11px;font-weight:700;display:flex;align-items:center;justify-content:center;flex-shrink:0;margin-top:1px;}
.step-text{font-size:12px;color:var(--muted2);line-height:1.6;}
.step-text b{color:var(--text);}

/* ë ˆì´ì•„ì›ƒ */
.page{position:relative;z-index:1;display:flex;max-width:1400px;margin:0 auto;padding:20px 24px 60px;gap:0;}
.sidebar{width:260px;min-width:180px;max-width:500px;flex-shrink:0;position:relative;}
.resizer{width:6px;cursor:col-resize;position:absolute;right:-3px;top:0;bottom:0;z-index:20;border-radius:3px;transition:background .15s;}
.resizer:hover,.resizer.active{background:var(--orange);}
.sidebar-card{background:var(--bg2);border:1px solid var(--border);border-radius:10px;overflow:hidden;position:sticky;top:68px;}
.sidebar-head{padding:12px 14px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;}
.sidebar-head span{font-size:11px;font-weight:700;letter-spacing:.08em;color:var(--muted);text-transform:uppercase;}
.tree{padding:8px 0;max-height:calc(100vh - 140px);overflow-y:auto;}
.tree::-webkit-scrollbar{width:3px;}
.tree::-webkit-scrollbar-thumb{background:var(--border);}
.tree-item{display:flex;align-items:center;padding:6px 10px;font-size:12px;color:var(--muted2);cursor:pointer;gap:5px;transition:all .15s;border-left:2px solid transparent;user-select:none;min-width:0;}
.tree-item:hover{color:var(--text);background:rgba(255,255,255,.04);}
.tree-item.active{color:var(--orange);background:rgba(249,115,22,.07);border-left-color:var(--orange);}
.tree-item .ti-icon{font-size:13px;flex-shrink:0;}
.tree-item .ti-name{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.tree-item .ti-toggle{font-size:10px;color:var(--muted);transition:transform .2s;flex-shrink:0;}
.tree-item.open .ti-toggle{transform:rotate(90deg);}
.tree-children{padding-left:14px;border-left:1px solid var(--border);margin-left:20px;}
.tree-children.hidden{display:none;}
.tree-loading{padding:12px 14px;font-size:11px;color:var(--muted);display:flex;align-items:center;gap:8px;}
.spin{display:inline-block;animation:spin 1s linear infinite;}
@keyframes spin{to{transform:rotate(360deg);}}
.content{flex:1;min-width:0;margin-left:280px;}

/* í´ë” í—¤ë” */
.folder-header{display:flex;align-items:center;gap:12px;margin-bottom:20px;}
.folder-icon{font-size:28px;}
.folder-title{font-size:20px;font-weight:700;}
.folder-path{font-size:12px;color:var(--muted);margin-top:2px;}
.folder-actions{margin-left:auto;display:flex;gap:8px;}

/* ì„œë¸Œí´ë” ê·¸ë¦¬ë“œ */
.subfolder-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:10px;margin-bottom:24px;}
.folder-card{background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:16px;cursor:pointer;transition:all .2s;text-align:center;}
.folder-card:hover{border-color:var(--orange);background:var(--bg3);transform:translateY(-2px);}
.folder-card .fc-icon{font-size:26px;margin-bottom:8px;}
.folder-card .fc-name{font-size:12px;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.folder-card .fc-cnt{font-size:10px;color:var(--muted);margin-top:3px;}

/* ì—…ë¡œë“œ íŒ¨ë„ */
.upload-section{margin-top:32px;padding-top:24px;border-top:1px solid var(--border);}
.upload-section-label{font-size:11px;font-weight:700;letter-spacing:.1em;color:var(--muted);text-transform:uppercase;margin-bottom:14px;display:flex;align-items:center;gap:10px;}
.upload-section-label::after{content:'';flex:1;height:1px;background:var(--border);}
.upload-panel{background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:14px 16px;margin:0 auto 20px;max-width:560px;}
.upload-panel h4{font-size:12px;font-weight:700;margin-bottom:10px;display:flex;align-items:center;gap:8px;display:none;}
.dropzone{border:2px dashed var(--border);border-radius:8px;padding:18px 16px;text-align:center;cursor:pointer;transition:all .2s;position:relative;}
.dropzone:hover,.dropzone.drag{border-color:var(--orange);background:rgba(249,115,22,.04);}
.dropzone input[type=file]{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%;}
.preview-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(80px,1fr));gap:5px;margin:10px 0;}
.preview-item{position:relative;border-radius:5px;overflow:hidden;aspect-ratio:4/3;background:var(--bg3);}
.preview-item img{width:100%;height:100%;object-fit:cover;}
.preview-item .pi-x{position:absolute;top:2px;right:2px;width:15px;height:15px;border-radius:50%;background:rgba(239,68,68,.9);color:#fff;font-size:9px;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;}
.upload-prog{height:5px;background:var(--bg3);border-radius:3px;overflow:hidden;margin:8px 0;}
.upload-prog-bar{height:100%;background:var(--orange);border-radius:3px;transition:width .3s;width:0%;}
.upload-log{font-size:11px;color:var(--muted2);text-align:center;min-height:18px;margin-bottom:8px;}

/* ì„¹ì…˜ ë¼ë²¨ */
.sec-label{font-size:11px;font-weight:700;letter-spacing:.1em;color:var(--muted);text-transform:uppercase;margin-bottom:12px;display:flex;align-items:center;gap:10px;}
.sec-label::after{content:'';flex:1;height:1px;background:var(--border);}

/* ì‚¬ì§„ ê·¸ë¦¬ë“œ */
.photo-toolbar{display:flex;align-items:center;gap:10px;margin-bottom:12px;flex-wrap:wrap;}
.srch{position:relative;}
.srch svg{position:absolute;left:9px;top:50%;transform:translateY(-50%);pointer-events:none;color:var(--muted);}
.srch input{background:var(--bg2);border:1px solid var(--border);border-radius:7px;padding:7px 12px 7px 30px;color:var(--text);font-size:12px;font-family:'Noto Sans KR',sans-serif;width:190px;}
.srch input:focus{outline:none;border-color:var(--orange);}
.srch input::placeholder{color:var(--muted);}
.photo-stat{font-size:12px;color:var(--muted);margin-left:auto;}
.photo-stat b{color:var(--text);}
.photo-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(155px,1fr));gap:7px;}
.photo-card{position:relative;border-radius:8px;overflow:hidden;background:var(--bg3);cursor:pointer;border:1px solid var(--border);aspect-ratio:4/3;transition:transform .2s,border-color .2s,box-shadow .2s;}
.photo-card:hover{transform:translateY(-3px);border-color:var(--orange);box-shadow:0 10px 28px rgba(0,0,0,.5);}
.photo-card img{width:100%;height:100%;object-fit:cover;display:block;}
.photo-card .pc-ov{position:absolute;inset:0;background:linear-gradient(to top,rgba(0,0,0,.75),transparent 55%);opacity:0;transition:opacity .2s;display:flex;align-items:flex-end;padding:7px;}
.photo-card:hover .pc-ov{opacity:1;}
.photo-card .pc-nm{font-size:10px;color:#fff;word-break:break-all;line-height:1.3;}
.photo-card .pc-del-btn{position:absolute;top:5px;right:5px;width:24px;height:24px;border-radius:5px;border:none;background:rgba(239,68,68,.85);color:#fff;font-size:12px;cursor:pointer;opacity:0;transition:opacity .15s;z-index:5;display:flex;align-items:center;justify-content:center;}
.photo-card:hover .pc-del-btn{opacity:1;}
.photo-card .pc-check{position:absolute;top:5px;left:5px;z-index:5;}
.photo-card .pc-check input{width:16px;height:16px;cursor:pointer;accent-color:var(--orange);}

/* ë¹ˆ ìƒíƒœ */
.empty-box{text-align:center;padding:48px 20px;color:var(--muted);}
.empty-box .eb-icon{font-size:36px;margin-bottom:10px;}
.empty-box p{font-size:13px;line-height:1.8;color:var(--muted2);}
.loading-box{text-align:center;padding:40px;color:var(--muted);font-size:13px;}

/* ëª¨ë‹¬ */
.modal{display:none;position:fixed;inset:0;z-index:999;background:rgba(0,0,0,.93);align-items:center;justify-content:center;padding:20px;}
.modal.open{display:flex;}
.modal-wrap{position:relative;display:flex;flex-direction:column;align-items:center;}
.modal-img{max-width:90vw;max-height:82vh;border-radius:8px;box-shadow:0 24px 80px rgba(0,0,0,.8);display:block;object-fit:contain;}
.modal-x{position:absolute;top:-14px;right:-14px;width:30px;height:30px;border-radius:50%;background:var(--bg3);border:1px solid var(--border);color:var(--text);font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .15s;}
.modal-x:hover{background:#ef4444;border-color:#ef4444;color:#fff;}
.modal-nav{display:flex;gap:10px;margin-top:14px;}
.modal-nav button{padding:7px 18px;border-radius:7px;font-size:13px;font-weight:600;border:1px solid var(--border);background:var(--bg3);color:var(--muted2);cursor:pointer;transition:all .15s;font-family:'Noto Sans KR',sans-serif;}
.modal-nav button:hover{color:var(--text);border-color:var(--muted);}
.modal-info{text-align:center;margin-top:8px;font-size:12px;color:var(--muted);}
.modal-counter{font-size:11px;color:var(--muted);margin-top:3px;}

/* í† ìŠ¤íŠ¸ */
/* ìº˜ë¦°ë” */
.cal-card{background:var(--bg2);border:1px solid var(--border);border-radius:10px;overflow:hidden;margin-top:10px;}
.cal-head{padding:10px 12px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;}
.cal-head span{font-size:12px;font-weight:700;color:var(--text);}
.cal-nav{background:none;border:none;color:var(--muted2);cursor:pointer;font-size:14px;padding:2px 6px;border-radius:4px;transition:all .15s;}
.cal-nav:hover{color:var(--text);background:var(--bg3);}
.cal-grid{padding:8px;}
.cal-dow{display:grid;grid-template-columns:repeat(7,1fr);margin-bottom:4px;}
.cal-dow span{text-align:center;font-size:9px;font-weight:700;color:var(--muted);padding:2px 0;}
.cal-days{display:grid;grid-template-columns:repeat(7,1fr);gap:2px;}
.cal-day{text-align:center;font-size:11px;padding:4px 2px;border-radius:5px;cursor:pointer;color:var(--muted2);transition:all .15s;min-height:24px;display:flex;align-items:center;justify-content:center;position:relative;}
.cal-day:hover{background:var(--bg3);color:var(--text);}
.cal-day.empty{cursor:default;}
.cal-day.has-photos{color:var(--orange);font-weight:700;}
.cal-day.has-photos::after{content:'';position:absolute;bottom:2px;left:50%;transform:translateX(-50%);width:4px;height:4px;border-radius:50%;background:var(--orange);}
.cal-day.today{background:var(--bg3);color:var(--text);font-weight:700;}
.cal-day.selected{background:var(--orange);color:#fff;font-weight:700;}
.cal-day.selected::after{display:none;}
.cal-day.sun{color:#f87171;}
.cal-day.sat{color:#60a5fa;}
.cal-day.has-photos.sun{color:#fca5a5;}
.cal-day.has-photos.sat{color:#93c5fd;}
.toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(20px);background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:10px 20px;font-size:13px;color:var(--text);z-index:500;opacity:0;transition:all .3s;pointer-events:none;}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0);}

@media(max-width:768px){.sidebar{display:none;}.page{padding:12px 14px 40px;}.content{margin-left:0;}}
</style>
</head>
<body>

<nav>
  <a class="nav-logo" href="index.html">âš  <span>SAFETY</span></a>
  <a class="nav-back" href="index.html">â† í™ˆ</a>
  <span style="color:var(--border)">|</span>
  <div class="breadcrumb" id="breadcrumb"></div>
  <div class="nav-right">
    <div class="drive-badge" id="driveBadge" onclick="toggleDriveAuth()">
      <div class="drive-dot off" id="driveDot"></div>
      <span id="driveLabel">ë“œë¼ì´ë¸Œ ì—°ê²°</span>
    </div>
    <button class="btn sm" onclick="toggleEditMode()" id="editBtn" style="display:none">âœï¸ í¸ì§‘</button>
  </div>
</nav>

<!-- ì—°ê²° ì „ í™”ë©´ -->
<div id="connectScreen" class="connect-screen">
  <div class="connect-icon">ğŸ”—</div>
  <div class="connect-title">êµ¬ê¸€ ë“œë¼ì´ë¸Œ ì—°ë™</div>
  <div class="connect-desc">êµ¬ê¸€ ë“œë¼ì´ë¸Œì˜ í´ë”ì™€ ì‚¬ì§„ì„ ê°¤ëŸ¬ë¦¬ì—ì„œ ë°”ë¡œ í™•ì¸í•˜ì„¸ìš”.<br>ë“œë¼ì´ë¸Œì— ì‚¬ì§„ì„ ì¶”ê°€í•˜ë©´ ìë™ìœ¼ë¡œ ë°˜ì˜ë©ë‹ˆë‹¤.</div>
  <div class="connect-card">
    <h3>ğŸ“ ë£¨íŠ¸ í´ë” ì„¤ì •</h3>
    <div class="connect-step">
      <div class="step-num">1</div>
      <div class="step-text">êµ¬ê¸€ ë“œë¼ì´ë¸Œì—ì„œ ê°¤ëŸ¬ë¦¬ë¡œ ì‚¬ìš©í•  <b>í´ë” ID</b>ë¥¼ ë³µì‚¬í•˜ì„¸ìš”.<br>
        í´ë” ì—´ê¸° â†’ ì£¼ì†Œì°½ì—ì„œ <b>folders/ ë’¤ì˜ ë¬¸ìì—´</b>ì´ IDì˜ˆìš”</div>
    </div>
    <div class="connect-step">
      <div class="step-num">2</div>
      <div class="step-text">ì•„ë˜ì— ë¶™ì—¬ë„£ê³  êµ¬ê¸€ ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•˜ì„¸ìš”</div>
    </div>
    <div style="display:flex;gap:8px;margin-bottom:12px;">
      <input type="text" id="rootFolderInput" placeholder="í´ë” ID ë¶™ì—¬ë„£ê¸° (ë˜ëŠ” ë¹„ì›Œë‘ë©´ ë‚´ ë“œë¼ì´ë¸Œ ì „ì²´)"
        style="flex:1;background:var(--bg3);border:1px solid var(--border);border-radius:7px;padding:9px 12px;color:var(--text);font-size:12px;font-family:'Noto Sans KR',sans-serif;">
    </div>
    <button class="btn google" style="width:100%;justify-content:center;padding:11px;" onclick="startGoogleAuth()">
      <svg width="18" height="18" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
      êµ¬ê¸€ ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸
    </button>
    <div style="font-size:11px;color:var(--muted);text-align:center;margin-top:10px;line-height:1.6;">
      ë“œë¼ì´ë¸Œ ì½ê¸°Â·ì“°ê¸° ê¶Œí•œë§Œ ì‚¬ìš©í•©ë‹ˆë‹¤.<br>ë°ì´í„°ëŠ” ì™¸ë¶€ë¡œ ì „ì†¡ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
    </div>
  </div>
</div>

<!-- ê°¤ëŸ¬ë¦¬ í™”ë©´ -->
<div id="galleryScreen" style="display:none">
  <div class="page">
    <aside class="sidebar" id="sidebar">
      <div class="resizer" id="resizer"></div>
      <div class="sidebar-card">
        <div class="sidebar-head">
          <span>í´ë” êµ¬ì¡°</span>
          <button class="btn sm" onclick="refreshTree()" title="ìƒˆë¡œê³ ì¹¨" style="padding:2px 6px;">â†º</button>
        </div>
        <div class="tree" id="treeRoot"></div>
      </div>
      <div class="cal-card" id="calCard">
        <div class="cal-head">
          <button class="cal-nav" onclick="calMove(-1)">â€¹</button>
          <span id="calTitle"></span>
          <button class="cal-nav" onclick="calMove(1)">â€º</button>
        </div>
        <div class="cal-grid">
          <div class="cal-dow">
            <span style="color:#f87171">ì¼</span><span>ì›”</span><span>í™”</span><span>ìˆ˜</span><span>ëª©</span><span>ê¸ˆ</span><span style="color:#60a5fa">í† </span>
          </div>
          <div class="cal-days" id="calDays"></div>
        </div>
      </div>
    </aside>
    <div class="content" id="content"></div>
  </div>
</div>

<!-- ëª¨ë‹¬ -->
<div class="modal" id="modal" onclick="closeModal(event)">
  <div class="modal-wrap">
    <button class="modal-x" onclick="closeModal(null)">âœ•</button>
    <img class="modal-img" id="mImg" src="" alt="">
    <div class="modal-nav">
      <button onclick="moveModal(-1)">â† ì´ì „</button>
      <button onclick="moveModal(1)">ë‹¤ìŒ â†’</button>
    </div>
    <div class="modal-info" id="mInfo"></div>
    <div class="modal-counter" id="mCounter"></div>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- Google API -->
<script src="https://accounts.google.com/gsi/client" async></script>

<script>
// â”€â”€ ì„¤ì • â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const CLIENT_ID = '167323077293-8gsd86rn7fjvo7dvo4994fhm6opr19cd.apps.googleusercontent.com';
const SCOPES    = 'https://www.googleapis.com/auth/drive';
const IMG_EXTS  = /\.(jpg|jpeg|png|bmp|gif|tif|tiff|webp)$/i;

// â”€â”€ ìƒíƒœ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let accessToken  = localStorage.getItem('drive_token') || '';
let tokenExpiry  = parseInt(localStorage.getItem('drive_token_expiry') || '0');
let rootFolderId = localStorage.getItem('drive_root') || '';
let currentFolderId = '';
let currentFolderName = '';
let folderPath   = []; // [{id, name}]
let allPhotos    = [];
let curModalIdx  = 0;
let editMode     = false;
let selectedPhotos = new Set();
let treeCache    = {}; // folderId â†’ children

// â”€â”€ OAuth â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startGoogleAuth() {
  const input = document.getElementById('rootFolderInput').value.trim();
  if (input) {
    // URLì—ì„œ ID ì¶”ì¶œ ì§€ì›
    const match = input.match(/[-\w]{25,}/);
    if (match) rootFolderId = match[0];
    else rootFolderId = input;
  } else {
    rootFolderId = 'root';
  }
  localStorage.setItem('drive_root', rootFolderId);

  const client = google.accounts.oauth2.initTokenClient({
    client_id: CLIENT_ID,
    scope: SCOPES,
    callback: (resp) => {
      if (resp.error) { showToast('âŒ ë¡œê·¸ì¸ ì‹¤íŒ¨: ' + resp.error); return; }
      accessToken = resp.access_token;
      tokenExpiry = Date.now() + (resp.expires_in - 60) * 1000;
      localStorage.setItem('drive_token', accessToken);
      localStorage.setItem('drive_token_expiry', tokenExpiry);
      onAuthSuccess();
    }
  });
  client.requestAccessToken();
}

function toggleDriveAuth() {
  if (accessToken && Date.now() < tokenExpiry) {
    if (confirm('ë“œë¼ì´ë¸Œ ì—°ê²°ì„ í•´ì œí• ê¹Œìš”?')) disconnectDrive();
  } else {
    document.getElementById('connectScreen').style.display = 'flex';
    document.getElementById('galleryScreen').style.display = 'none';
  }
}

function disconnectDrive() {
  google.accounts.oauth2.revoke(accessToken, () => {});
  accessToken = ''; tokenExpiry = 0;
  localStorage.removeItem('drive_token');
  localStorage.removeItem('drive_token_expiry');
  updateDriveBadge(false);
  document.getElementById('editBtn').style.display = 'none';
  document.getElementById('connectScreen').style.display = 'flex';
  document.getElementById('galleryScreen').style.display = 'none';
  showToast('ë“œë¼ì´ë¸Œ ì—°ê²° í•´ì œë¨');
}

function onAuthSuccess() {
  updateDriveBadge(true);
  document.getElementById('connectScreen').style.display = 'none';
  document.getElementById('galleryScreen').style.display = 'block';
  document.getElementById('editBtn').style.display = '';
  folderPath = [];
  navigateToFolder(rootFolderId, 'ğŸ“ ë‚´ ë“œë¼ì´ë¸Œ');
  setTimeout(() => renderCal(), 1500);
}

function updateDriveBadge(connected) {
  document.getElementById('driveDot').className = 'drive-dot ' + (connected ? 'on' : 'off');
  document.getElementById('driveLabel').textContent = connected ? 'ë“œë¼ì´ë¸Œ ì—°ê²°ë¨' : 'ë“œë¼ì´ë¸Œ ì—°ê²°';
}

// â”€â”€ Drive API í˜¸ì¶œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function driveAPI(endpoint, opts = {}) {
  if (!accessToken) throw new Error('ë¡œê·¸ì¸ í•„ìš”');
  const url = `https://www.googleapis.com/drive/v3/${endpoint}`;
  const res = await fetch(url, {
    ...opts,
    headers: {
      'Authorization': `Bearer ${accessToken}`,
      'Content-Type': 'application/json',
      ...(opts.headers || {})
    }
  });
  if (res.status === 401) { disconnectDrive(); throw new Error('í† í° ë§Œë£Œ'); }
  if (!res.ok) { const e = await res.json(); throw new Error(e.error?.message || res.statusText); }
  if (res.status === 204) return {};
  return res.json();
}

async function listFolder(folderId) {
  if (treeCache[folderId]) return treeCache[folderId];
  const q = encodeURIComponent(`'${folderId}' in parents and trashed=false`);
  const fields = 'files(id,name,mimeType,thumbnailLink,webContentLink,iconLink,size,modifiedTime,shortcutDetails)';
  const data = await driveAPI(`files?q=${q}&fields=${fields}&orderBy=name&pageSize=1000`);
  let files = data.files || [];

  // ë°”ë¡œê°€ê¸°(shortcut)ë¥¼ ì‹¤ì œ íŒŒì¼ ì •ë³´ë¡œ êµì²´
  const shortcuts = files.filter(f => f.mimeType === 'application/vnd.google-apps.shortcut');
  if (shortcuts.length > 0) {
    const resolved = await Promise.all(shortcuts.map(async s => {
      try {
        const targetId = s.shortcutDetails?.targetId;
        if (!targetId) return null;
        const target = await driveAPI(`files/${targetId}?fields=id,name,mimeType,thumbnailLink,webContentLink,size,modifiedTime`);
        // ë°”ë¡œê°€ê¸° ì´ë¦„ ìœ ì§€, ì‹¤ì œ íŒŒì¼ ì •ë³´ ì‚¬ìš©
        return { ...target, name: s.name, _shortcut: true };
      } catch { return null; }
    }));
    // ë°”ë¡œê°€ê¸°ë¥¼ ì‹¤ì œ íŒŒì¼ë¡œ êµì²´
    const shortcutIds = new Set(shortcuts.map(s => s.id));
    files = files.filter(f => !shortcutIds.has(f.id));
    resolved.filter(Boolean).forEach(f => files.push(f));
  }

  treeCache[folderId] = files;
  return files;
}

async function uploadToDrive(file, folderId) {
  const meta = JSON.stringify({ name: file.name, parents: [folderId] });
  const form = new FormData();
  form.append('metadata', new Blob([meta], { type: 'application/json' }));
  form.append('file', file);
  const res = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
    method: 'POST',
    headers: { 'Authorization': `Bearer ${accessToken}` },
    body: form
  });
  if (!res.ok) throw new Error('ì—…ë¡œë“œ ì‹¤íŒ¨');
  return res.json();
}

async function deleteFromDrive(fileId) {
  await driveAPI(`files/${fileId}`, { method: 'DELETE', headers: { 'Content-Type': '' } });
}

// â”€â”€ ë„¤ë¹„ê²Œì´ì…˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function navigateToFolder(folderId, name) {
  currentFolderId = folderId;
  currentFolderName = name;
  selectedPhotos.clear();

  // ê²½ë¡œ ì¶”ì 
  const existing = folderPath.findIndex(f => f.id === folderId);
  if (existing >= 0) folderPath = folderPath.slice(0, existing + 1);
  else if (folderId !== rootFolderId) folderPath.push({ id: folderId, name });
  else folderPath = [{ id: folderId, name }];

  renderBreadcrumb();
  await renderContent();
}

// â”€â”€ ë¸Œë ˆë“œí¬ëŸ¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderBreadcrumb() {
  const bc = document.getElementById('breadcrumb');
  bc.innerHTML = '';
  folderPath.forEach((f, i) => {
    if (i > 0) { const sep = document.createElement('span'); sep.className = 'bc-sep'; sep.textContent = 'â€º'; bc.appendChild(sep); }
    const item = document.createElement('span');
    item.className = 'bc-item' + (i === folderPath.length - 1 ? ' active' : '');
    item.textContent = f.name;
    item.onclick = () => navigateToFolder(f.id, f.name);
    bc.appendChild(item);
  });
}

// â”€â”€ íŠ¸ë¦¬ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function refreshTree() {
  treeCache = {};
  renderTreeRoot();
}
async function renderTreeRoot() {
  const root = document.getElementById('treeRoot');
  root.innerHTML = '<div class="tree-loading"><span class="spin">â³</span> ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
  try {
    const files = await listFolder(rootFolderId);
    root.innerHTML = '';
    const folders = files.filter(f => f.mimeType === 'application/vnd.google-apps.folder');

    // ë£¨íŠ¸ í•­ëª©
    const rootItem = makeTreeItem('ğŸ“', folderPath[0]?.name || 'ë‚´ ë“œë¼ì´ë¸Œ', rootFolderId, 0, folders.length > 0);
    root.appendChild(rootItem);
    if (currentFolderId === rootFolderId || folderPath.some(f => f.id === rootFolderId)) {
      const ch = document.createElement('div');
      ch.className = 'tree-children';
      folders.forEach(f => {
        const item = makeTreeItem('ğŸ“‚', f.name, f.id, 1, false);
        ch.appendChild(item);
      });
      root.appendChild(ch);
    }
  } catch(e) {
    root.innerHTML = `<div class="tree-loading" style="color:var(--red)">ì˜¤ë¥˜: ${e.message}</div>`;
  }
}

function makeTreeItem(icon, name, folderId, depth, hasChildren) {
  const item = document.createElement('div');
  item.className = 'tree-item' + (currentFolderId === folderId ? ' active' : '');
  item.style.paddingLeft = (14 + depth * 12) + 'px';
  item.innerHTML = `<span class="ti-toggle">${hasChildren ? 'â–¶' : ' '}</span><span class="ti-icon">${icon}</span><span class="ti-name">${name}</span>`;
  item.onclick = () => navigateToFolder(folderId, name);
  return item;
}

// â”€â”€ ì½˜í…ì¸  ë Œë” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function renderContent() {
  const content = document.getElementById('content');
  content.innerHTML = '<div class="loading-box"><span class="spin">â³</span> ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
  renderTreeRoot();

  try {
    const files = await listFolder(currentFolderId);
    content.innerHTML = '';

    const folders = files.filter(f => f.mimeType === 'application/vnd.google-apps.folder');
    const photos  = files.filter(f =>
      f.mimeType !== 'application/vnd.google-apps.folder' &&
      (f.mimeType?.startsWith('image/') || IMG_EXTS.test(f.name))
    );
    allPhotos = photos;

    // í—¤ë”
    const hdr = document.createElement('div');
    hdr.className = 'folder-header';
    hdr.innerHTML = `<span class="folder-icon">ğŸ“‚</span>
      <div><div class="folder-title">${currentFolderName}</div>
      <div class="folder-path">í´ë” ${folders.length}ê°œ Â· ì‚¬ì§„ ${photos.length}ì¥</div></div>
      <div class="folder-actions" id="folderActions"></div>`;
    content.appendChild(hdr);

    // í•˜ìœ„ í´ë”
    if (folders.length > 0) {
      const lbl = document.createElement('div'); lbl.className = 'sec-label'; lbl.textContent = 'í•˜ìœ„ í´ë”';
      content.appendChild(lbl);
      const grid = document.createElement('div'); grid.className = 'subfolder-grid';
      folders.forEach(f => {
        const card = document.createElement('div'); card.className = 'folder-card';
        card.innerHTML = `<div class="fc-icon">ğŸ“</div><div class="fc-name">${f.name}</div><div class="fc-cnt">í´ë”</div>`;
        card.onclick = () => navigateToFolder(f.id, f.name);
        grid.appendChild(card);
      });
      content.appendChild(grid);
    }

    // ì‚¬ì§„
    if (photos.length > 0) {
      const lbl = document.createElement('div'); lbl.className = 'sec-label'; lbl.id = 'photoSecLabel'; lbl.textContent = `ì‚¬ì§„ (${photos.length}ì¥)`;
      content.appendChild(lbl);

      const toolbar = document.createElement('div'); toolbar.className = 'photo-toolbar';
      toolbar.innerHTML = `
        <div class="srch">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
          <input type="text" placeholder="íŒŒì¼ëª… ê²€ìƒ‰" oninput="filterPhotos(this.value)">
        </div>
        ${editMode ? `<button class="btn sm" onclick="selectAll(true)">ì „ì²´ì„ íƒ</button>
          <button class="btn sm" onclick="selectAll(false)">ì„ íƒí•´ì œ</button>
          <button class="btn sm danger" id="bulkDelBtn" style="display:none" onclick="deleteSelected()">ğŸ—‘ ì„ íƒì‚­ì œ</button>` : ''}
        <div class="photo-stat" id="photoStat"><b>${photos.length}</b>ì¥</div>`;
      content.appendChild(toolbar);

      const grid = document.createElement('div'); grid.className = 'photo-grid'; grid.id = 'photoGrid';
      photos.forEach((p, i) => {
        const card = document.createElement('div');
        card.className = 'photo-card';
        card.dataset.name = p.name;
        card.dataset.id   = p.id;
        // ì¸ë„¤ì¼: Drive ê³µì‹ URL (í† í° ë¶ˆí•„ìš”, ê³µìœ  ì„¤ì • ë¬´ê´€í•˜ê²Œ ë™ì‘)
        const imgSrc = p.thumbnailLink
          ? p.thumbnailLink.replace(/=s\d+/, '=s400').replace(/=s220/, '=s400')
          : `https://lh3.googleusercontent.com/d/${p.id}=s400`;
        card.innerHTML = `
          <img src="${imgSrc}" alt="${p.name}" loading="lazy">
          <div class="pc-ov"><div class="pc-nm">${p.name}</div></div>
          ${editMode ? `<button class="pc-del-btn" onclick="event.stopPropagation();deletePhoto('${p.id}','${p.name}',this.closest('.photo-card'))">ğŸ—‘</button>
            <label class="pc-check" onclick="event.stopPropagation()"><input type="checkbox" onchange="toggleSelect(this,'${p.id}')"></label>` : ''}`;
        if (!editMode) card.onclick = () => { curModalIdx = i; openModalPhoto(p); };
        grid.appendChild(card);
      });
      content.appendChild(grid);
    } else if (folders.length === 0) {
      const box = document.createElement('div'); box.className = 'empty-box';
      box.innerHTML = '<div class="eb-icon">ğŸ–¼ï¸</div><p>ì´ í´ë”ì— ì‚¬ì§„ì´ ì—†ìŠµë‹ˆë‹¤.<br>ì•„ë˜ ì—…ë¡œë“œ ì˜ì—­ì—ì„œ ì‚¬ì§„ì„ ì¶”ê°€í•´ë³´ì„¸ìš”!</p>';
      content.appendChild(box);
    }

    // ì—…ë¡œë“œ íŒ¨ë„ (ì‚¬ì§„ ì•„ë˜, êµ¬ë¶„ì„  í¬í•¨)
    const upSection = document.createElement('div');
    upSection.className = 'upload-section';
    const upLabel = document.createElement('div');
    upLabel.className = 'upload-section-label';
    upLabel.textContent = 'ì‚¬ì§„ ì—…ë¡œë“œ';
    upSection.appendChild(upLabel);
    content.appendChild(upSection);
    renderUploadPanel(upSection);

  } catch(e) {
    content.innerHTML = `<div class="empty-box"><div class="eb-icon">âš ï¸</div><p>ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ${e.message}</p></div>`;
  }
}

// â”€â”€ ì—…ë¡œë“œ íŒ¨ë„ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderUploadPanel(container) {
  let uploadFiles = [];
  let isUploading = false;

  const panel = document.createElement('div');
  panel.className = 'upload-panel';
  panel.innerHTML = `

    <div class="dropzone" id="upDZ">
      <input type="file" id="upFI" accept="image/*" multiple>
      <div style="font-size:26px;margin-bottom:6px">ğŸ“¸</div>
      <div style="font-size:13px;font-weight:600;color:var(--muted2)">ì‚¬ì§„ì„ ëŒì–´ë‹¤ ë†“ê±°ë‚˜ í´ë¦­</div>
      <div style="font-size:11px;color:var(--muted);margin-top:3px">JPG, PNG, BMP, GIF Â· ì—¬ëŸ¬ ì¥ ë™ì‹œ ê°€ëŠ¥</div>
    </div>
    <div class="preview-grid" id="upPG" style="display:none"></div>
    <div class="upload-prog" id="upProg" style="display:none"><div class="upload-prog-bar" id="upPB"></div></div>
    <div class="upload-log" id="upLog"></div>
    <div style="display:flex;gap:8px;align-items:center;">
      <button class="btn primary" id="upBtn" onclick="doUpload()" disabled>ğŸ“¤ ì—…ë¡œë“œ</button>
      <button class="btn sm" id="upClr" onclick="clearUp()" style="display:none">ì´ˆê¸°í™”</button>
      <span id="upCnt" style="font-size:12px;color:var(--muted)"></span>
    </div>`;
  container.appendChild(panel);

  const dz = panel.querySelector('#upDZ');
  const fi = panel.querySelector('#upFI');
  dz.addEventListener('dragover', e => { e.preventDefault(); dz.classList.add('drag'); });
  dz.addEventListener('dragleave', () => dz.classList.remove('drag'));
  dz.addEventListener('drop', e => { e.preventDefault(); dz.classList.remove('drag'); addFiles(e.dataTransfer.files); });
  fi.addEventListener('change', () => addFiles(fi.files));

  function addFiles(list) {
    const exts = ['jpg','jpeg','png','bmp','gif','tif','tiff','webp'];
    [...list].filter(f => exts.includes(f.name.split('.').pop().toLowerCase()))
      .forEach(f => { if (!uploadFiles.find(x => x.name === f.name && x.size === f.size)) uploadFiles.push(f); });
    renderPrev(); updateCnt();
    panel.querySelector('#upBtn').disabled = !uploadFiles.length;
  }

  function renderPrev() {
    const pg = panel.querySelector('#upPG');
    pg.style.display = uploadFiles.length ? 'grid' : 'none';
    pg.innerHTML = '';
    uploadFiles.forEach((f, i) => {
      const url = URL.createObjectURL(f);
      const el = document.createElement('div'); el.className = 'preview-item';
      el.innerHTML = `<img src="${url}"><button class="pi-x" onclick="rmFile(${i})">âœ•</button>`;
      pg.appendChild(el);
    });
    panel.querySelector('#upClr').style.display = uploadFiles.length ? '' : 'none';
  }

  window.rmFile = i => { uploadFiles.splice(i,1); renderPrev(); updateCnt(); if(!uploadFiles.length) panel.querySelector('#upBtn').disabled=true; };
  window.clearUp = () => { uploadFiles=[]; renderPrev(); updateCnt(); panel.querySelector('#upBtn').disabled=true; panel.querySelector('#upLog').textContent=''; panel.querySelector('#upProg').style.display='none'; };
  function updateCnt() { panel.querySelector('#upCnt').textContent = uploadFiles.length ? uploadFiles.length+'ì¥ ì„ íƒë¨' : ''; }

  window.doUpload = async () => {
    if (isUploading || !uploadFiles.length) return;
    isUploading = true;
    const btn = panel.querySelector('#upBtn');
    btn.disabled = true; btn.textContent = 'â³ ì—…ë¡œë“œ ì¤‘...';
    panel.querySelector('#upProg').style.display = 'block';
    const log = panel.querySelector('#upLog');
    const pb  = panel.querySelector('#upPB');
    let ok = 0, fail = 0;
    const total = uploadFiles.length;

    for (let i = 0; i < total; i++) {
      const f = uploadFiles[i];
      pb.style.width = Math.round((i / total) * 100) + '%';
      log.textContent = `(${i+1}/${total}) ${f.name} ì—…ë¡œë“œ ì¤‘...`;
      try {
        await uploadToDrive(f, currentFolderId);
        ok++;
      } catch(e) { fail++; console.error(f.name, e.message); }
    }

    pb.style.width = '100%';
    log.textContent = `âœ… ${ok}ì¥ ì™„ë£Œ${fail ? ` / âŒ ${fail}ì¥ ì‹¤íŒ¨` : ''}`;
    isUploading = false;
    btn.disabled = false; btn.textContent = 'ğŸ“¤ ì—…ë¡œë“œ';
    if (ok > 0) {
      showToast(`âœ… ${ok}ì¥ ì—…ë¡œë“œ ì™„ë£Œ!`);
      uploadFiles = []; renderPrev(); updateCnt();
      treeCache[currentFolderId] = null; // ìºì‹œ ë¬´íš¨í™”
      setTimeout(() => renderContent(), 1000);
    }
  };
}

// â”€â”€ ì‚¬ì§„ ì‚­ì œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function deletePhoto(fileId, name, card) {
  if (!confirm(`"${name}" ì„ ë“œë¼ì´ë¸Œì—ì„œ ì‚­ì œí• ê¹Œìš”?`)) return;
  try {
    await deleteFromDrive(fileId);
    card.remove();
    allPhotos = allPhotos.filter(p => p.id !== fileId);
    updatePhotoCount();
    treeCache[currentFolderId] = null;
    showToast('âœ… ì‚­ì œ ì™„ë£Œ: ' + name);
  } catch(e) { showToast('âŒ ì‚­ì œ ì‹¤íŒ¨: ' + e.message); }
}

async function deleteSelected() {
  if (!selectedPhotos.size) return;
  if (!confirm(`ì„ íƒí•œ ${selectedPhotos.size}ì¥ì„ ë“œë¼ì´ë¸Œì—ì„œ ì‚­ì œí• ê¹Œìš”?`)) return;
  let ok = 0, fail = 0;
  for (const id of selectedPhotos) {
    try { await deleteFromDrive(id); ok++; } catch { fail++; }
    document.querySelectorAll(`[data-id="${id}"]`).forEach(el => el.remove());
  }
  allPhotos = allPhotos.filter(p => !selectedPhotos.has(p.id));
  selectedPhotos.clear();
  treeCache[currentFolderId] = null;
  updatePhotoCount();
  showToast(`âœ… ${ok}ì¥ ì‚­ì œ${fail ? ` / âŒ ${fail}ì¥ ì‹¤íŒ¨` : ''}`);
}

function toggleSelect(cb, id) {
  if (cb.checked) selectedPhotos.add(id); else selectedPhotos.delete(id);
  const btn = document.getElementById('bulkDelBtn');
  if (btn) btn.style.display = selectedPhotos.size > 0 ? '' : 'none';
}
function selectAll(all) {
  document.querySelectorAll('#photoGrid .photo-card').forEach(card => {
    const cb = card.querySelector('input[type=checkbox]');
    if (all) { selectedPhotos.add(card.dataset.id); if(cb)cb.checked=true; }
    else      { selectedPhotos.delete(card.dataset.id); if(cb)cb.checked=false; }
  });
  const btn = document.getElementById('bulkDelBtn');
  if (btn) btn.style.display = selectedPhotos.size > 0 ? '' : 'none';
}
function updatePhotoCount() {
  const cnt = document.querySelectorAll('#photoGrid .photo-card').length;
  const stat = document.getElementById('photoStat');
  const lbl  = document.getElementById('photoSecLabel');
  if (stat) stat.innerHTML = `<b>${cnt}</b>ì¥`;
  if (lbl)  lbl.textContent = `ì‚¬ì§„ (${cnt}ì¥)`;
}

// â”€â”€ í¸ì§‘ ëª¨ë“œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleEditMode() {
  editMode = !editMode;
  const btn = document.getElementById('editBtn');
  btn.textContent = editMode ? 'âœ… ì™„ë£Œ' : 'âœï¸ í¸ì§‘';
  btn.className   = editMode ? 'btn sm primary' : 'btn sm';
  selectedPhotos.clear();
  renderContent();
}

// â”€â”€ ì‚¬ì§„ í•„í„° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function filterPhotos(val) {
  document.querySelectorAll('#photoGrid .photo-card').forEach(card => {
    card.style.display = (!val || card.dataset.name.toLowerCase().includes(val.toLowerCase())) ? '' : 'none';
  });
}

// â”€â”€ ëª¨ë‹¬ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openModalPhoto(photo) {
  // ì›ë³¸ í¬ê¸° ì´ë¯¸ì§€: Drive export ë°©ì‹ ì‚¬ìš©
  const src = `https://drive.google.com/uc?export=download&id=${photo.id}`;
  const mImg = document.getElementById('mImg');
  mImg.src = '';
  // ë¡œë”© í‘œì‹œ
  mImg.style.minWidth = '200px';
  mImg.style.minHeight = '150px';
  mImg.style.background = 'var(--bg3)';
  // ì¸ë„¤ì¼ ë¨¼ì € í‘œì‹œ í›„ ì›ë³¸ ë¡œë“œ
  if (photo.thumbnailLink) {
    mImg.src = photo.thumbnailLink.replace('=s220', '=s1600');
  } else {
    mImg.src = `https://lh3.googleusercontent.com/d/${photo.id}=s1600`;
  }
  document.getElementById('mInfo').textContent = photo.name;
  document.getElementById('mCounter').textContent = (curModalIdx+1) + ' / ' + allPhotos.length;
  document.getElementById('modal').classList.add('open');
}
function updateModal() {
  const p = allPhotos[curModalIdx];
  if (p.thumbnailLink) {
    document.getElementById('mImg').src = p.thumbnailLink.replace('=s220', '=s1600');
  } else {
    document.getElementById('mImg').src = `https://lh3.googleusercontent.com/d/${p.id}=s1600`;
  }
  document.getElementById('mInfo').textContent = p.name;
  document.getElementById('mCounter').textContent = (curModalIdx+1) + ' / ' + allPhotos.length;
}
function moveModal(dir) { curModalIdx=(curModalIdx+dir+allPhotos.length)%allPhotos.length; updateModal(); }
function closeModal(e) { if(e===null||e.target===document.getElementById('modal'))document.getElementById('modal').classList.remove('open'); }
document.addEventListener('keydown', e => {
  if (!document.getElementById('modal').classList.contains('open')) return;
  if (e.key==='Escape') closeModal(null);
  if (e.key==='ArrowLeft') moveModal(-1);
  if (e.key==='ArrowRight') moveModal(1);
});

// â”€â”€ ì‚¬ì´ë“œë°” ë¦¬ì‚¬ì´ì¦ˆ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(function(){
  const sidebar = document.getElementById('sidebar');
  const resizer = document.getElementById('resizer');
  const content = document.getElementById('content');
  let isDown=false, startX=0, startW=0;
  const saved = localStorage.getItem('sidebarWidth');
  if (saved) sidebar.style.width = saved + 'px';
  updateMargin();
  resizer.addEventListener('mousedown', e=>{isDown=true;startX=e.clientX;startW=sidebar.offsetWidth;resizer.classList.add('active');document.body.style.cursor='col-resize';document.body.style.userSelect='none';e.preventDefault();});
  document.addEventListener('mousemove', e=>{if(!isDown)return;const w=Math.min(500,Math.max(180,startW+(e.clientX-startX)));sidebar.style.width=w+'px';updateMargin();});
  document.addEventListener('mouseup', ()=>{if(!isDown)return;isDown=false;resizer.classList.remove('active');document.body.style.cursor='';document.body.style.userSelect='';localStorage.setItem('sidebarWidth',sidebar.offsetWidth);});
  resizer.addEventListener('dblclick',()=>{let maxW=180;document.querySelectorAll('.tree-item').forEach(el=>{maxW=Math.max(maxW,el.scrollWidth+20);});maxW=Math.min(500,maxW);sidebar.style.width=maxW+'px';updateMargin();localStorage.setItem('sidebarWidth',maxW);});
  function updateMargin(){content.style.marginLeft=(sidebar.offsetWidth+20)+'px';}
})();

// â”€â”€ ìº˜ë¦°ë” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let calYear  = new Date().getFullYear();
let calMonth = new Date().getMonth(); // 0-based
let calDateFolders = new Set(); // ë‚ ì§œ í˜•ì‹ í´ë”ëª… ìºì‹œ
let calSelected = null;

function calMove(dir) {
  calMonth += dir;
  if (calMonth > 11) { calMonth = 0; calYear++; }
  if (calMonth < 0)  { calMonth = 11; calYear--; }
  renderCal();
}

function drawCalDays() {
  const days = document.getElementById('calDays');
  if (!days) return;
  days.innerHTML = '';
  const firstDay = new Date(calYear, calMonth, 1).getDay();
  const lastDate = new Date(calYear, calMonth+1, 0).getDate();
  const today = new Date();
  for (let i = 0; i < firstDay; i++) {
    const el = document.createElement('div'); el.className='cal-day empty'; days.appendChild(el);
  }
  for (let d = 1; d <= lastDate; d++) {
    const dateStr = `${calYear}-${String(calMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const dow = new Date(calYear, calMonth, d).getDay();
    const el  = document.createElement('div');
    let cls = 'cal-day';
    if (dow === 0) cls += ' sun';
    if (dow === 6) cls += ' sat';
    if (today.getFullYear()===calYear && today.getMonth()===calMonth && today.getDate()===d) cls += ' today';
    if (calDateFolders.has(dateStr)) cls += ' has-photos';
    if (calSelected === dateStr) cls += ' selected';
    el.className = cls;
    el.textContent = d;
    if (calDateFolders.has(dateStr)) {
      el.title = `${dateStr} ì‚¬ì§„ ë³´ê¸°`;
      el.onclick = () => calGoDate(dateStr);
    }
    days.appendChild(el);
  }
}

async function renderCal() {
  const title = document.getElementById('calTitle');
  if (!title) return;
  title.textContent = `${calYear}ë…„ ${calMonth+1}ì›”`;
  // ë‚ ì§œ ë¨¼ì € í‘œì‹œ
  drawCalDays();
  // ë°±ê·¸ë¼ìš´ë“œì—ì„œ ë‚ ì§œ í´ë” ìŠ¤ìº” í›„ ì—…ë°ì´íŠ¸
  await collectDateFolders();
  drawCalDays();
}

async function collectDateFolders() {
  // ë£¨íŠ¸ë¶€í„° ì¬ê·€ì ìœ¼ë¡œ ë‚ ì§œí˜• í´ë” ì°¾ê¸° (ìºì‹œ í™œìš©)
  calDateFolders = new Set();
  await scanForDateFolders(rootFolderId);
}

async function scanForDateFolders(folderId, depth=0) {
  if (depth > 6) return; // ë„ˆë¬´ ê¹Šì´ ì•ˆ ë“¤ì–´ê°€ë„ë¡
  try {
    const files = await listFolder(folderId);
    for (const f of files) {
      if (f.mimeType !== 'application/vnd.google-apps.folder') continue;
      if (/^\d{4}-\d{2}-\d{2}$/.test(f.name)) {
        calDateFolders.add(f.name);
        // idë„ ì €ì¥
        calDateFolderMap[f.name] = f.id;
      } else {
        await scanForDateFolders(f.id, depth+1);
      }
    }
  } catch {}
}

const calDateFolderMap = {}; // dateStr â†’ folderId

async function calGoDate(dateStr) {
  calSelected = dateStr;
  renderCal();
  const folderId = calDateFolderMap[dateStr];
  if (!folderId) { showToast('í´ë”ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤'); return; }
  // í´ë”ë¡œ ì´ë™
  folderPath = [];
  await navigateToFolder(folderId, dateStr);
  showToast(`ğŸ“… ${dateStr} ì‚¬ì§„ ë³´ê¸°`);
}

// â”€â”€ í† ìŠ¤íŠ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showToast(msg){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2500);}

// â”€â”€ ì‹œì‘ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(function init() {
  if (accessToken && Date.now() < tokenExpiry && rootFolderId) {
    // í† í° ìœ íš¨ â†’ ë°”ë¡œ ê°¤ëŸ¬ë¦¬ í‘œì‹œ
    onAuthSuccess();
  }
})();
</script>
</body>
</html>
