<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>í˜„ì¥ì‚¬ì§„ ê°¤ëŸ¬ë¦¬ Â· Safety Portal</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&family=Bebas+Neue&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0f1117;--bg2:#171b24;--bg3:#1e2330;--bg4:#252a38;
  --border:#2c3347;--orange:#f97316;--blue:#3b82f6;
  --green:#22c55e;--red:#ef4444;--yellow:#eab308;
  --text:#f1f5f9;--muted:#64748b;--muted2:#94a3b8;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
html{scroll-behavior:smooth;}
body{font-family:'Noto Sans KR',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;}
body::before{content:'';position:fixed;inset:0;z-index:0;
  background-image:linear-gradient(rgba(249,115,22,.025) 1px,transparent 1px),
  linear-gradient(90deg,rgba(249,115,22,.025) 1px,transparent 1px);
  background-size:40px 40px;pointer-events:none;}

/* NAV */
nav{position:sticky;top:0;z-index:100;background:rgba(15,17,23,.95);
  backdrop-filter:blur(16px);border-bottom:1px solid var(--border);
  padding:0 24px;display:flex;align-items:center;height:52px;gap:16px;}
.nav-logo{font-family:'Bebas Neue',sans-serif;font-size:20px;
  letter-spacing:.1em;color:var(--orange);text-decoration:none;white-space:nowrap;}
.nav-logo span{color:var(--text);}
.nav-back{font-size:12px;color:var(--muted2);text-decoration:none;
  display:flex;align-items:center;gap:4px;padding:5px 10px;border-radius:6px;transition:all .15s;}
.nav-back:hover{color:var(--text);background:var(--bg3);}
.nav-divider{color:var(--border);}
.breadcrumb{display:flex;align-items:center;gap:6px;font-size:13px;overflow:hidden;}
.bc-item{color:var(--muted2);cursor:pointer;white-space:nowrap;
  padding:3px 6px;border-radius:5px;transition:all .15s;max-width:140px;
  overflow:hidden;text-overflow:ellipsis;}
.bc-item:hover{color:var(--text);background:var(--bg3);}
.bc-item.active{color:var(--text);font-weight:600;}
.bc-sep{color:var(--muted);font-size:11px;}
.nav-right{margin-left:auto;display:flex;align-items:center;gap:8px;}
.btn{padding:6px 14px;border-radius:7px;font-size:12px;font-weight:600;cursor:pointer;
  border:1px solid var(--border);background:var(--bg3);color:var(--muted2);
  transition:all .15s;font-family:'Noto Sans KR',sans-serif;white-space:nowrap;}
.btn:hover{color:var(--text);border-color:var(--muted);}
.btn.primary{background:var(--orange);border-color:var(--orange);color:#fff;}
.btn.primary:hover{background:#ea6c0a;}
.btn.danger{background:transparent;border-color:var(--red);color:var(--red);}
.btn.danger:hover{background:var(--red);color:#fff;}
.btn.sm{padding:4px 10px;font-size:11px;}

/* MAIN LAYOUT */
.page{position:relative;z-index:1;display:flex;max-width:1400px;margin:0 auto;
  padding:20px 24px 60px;gap:0;}

/* SIDEBAR TREE */
.sidebar{width:260px;min-width:180px;max-width:500px;margin-right:0;flex-shrink:0;position:relative;}
.resizer{width:6px;cursor:col-resize;position:absolute;right:-3px;top:0;bottom:0;z-index:20;
  border-radius:3px;transition:background .15s;}
.resizer:hover,.resizer.active{background:var(--orange);}
.sidebar-card{background:var(--bg2);border:1px solid var(--border);
  border-radius:10px;overflow:hidden;position:sticky;top:68px;}
.sidebar-head{padding:12px 14px;border-bottom:1px solid var(--border);
  display:flex;align-items:center;justify-content:space-between;}
.sidebar-head span{font-size:11px;font-weight:700;letter-spacing:.08em;
  color:var(--muted);text-transform:uppercase;}
.tree{padding:8px 0;max-height:calc(100vh - 140px);overflow-y:auto;}
.tree::-webkit-scrollbar{width:3px;}
.tree::-webkit-scrollbar-thumb{background:var(--border);}
.tree-item{display:flex;align-items:center;padding:6px 10px;font-size:12px;
  color:var(--muted2);cursor:pointer;gap:5px;transition:all .15s;
  border-left:2px solid transparent;user-select:none;min-width:0;}
.tree-item:hover{color:var(--text);background:rgba(255,255,255,.04);}
.tree-item.active{color:var(--orange);background:rgba(249,115,22,.07);
  border-left-color:var(--orange);}
.tree-item .ti-icon{font-size:13px;flex-shrink:0;}
.tree-item .ti-name{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-size:12px;}
.tree-item .ti-cnt{font-size:10px;color:var(--muted);background:var(--bg3);
  padding:1px 5px;border-radius:8px;flex-shrink:0;}
.tree-item .ti-toggle{font-size:10px;color:var(--muted);transition:transform .2s;flex-shrink:0;}
.tree-item.open .ti-toggle{transform:rotate(90deg);}
.tree-children{padding-left:14px;border-left:1px solid var(--border);margin-left:20px;}
.tree-children.hidden{display:none;}

/* CONTENT */
.content{flex:1;min-width:0;position:relative;margin-left:280px;transition:margin-left .0s;}

/* FOLDER VIEW */
.folder-header{display:flex;align-items:center;gap:12px;margin-bottom:20px;}
.folder-icon{font-size:28px;}
.folder-title{font-size:20px;font-weight:700;}
.folder-desc{font-size:13px;color:var(--muted2);margin-top:2px;}
.folder-actions{margin-left:auto;display:flex;gap:8px;}

/* SUBFOLDER GRID */
.subfolder-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:10px;margin-bottom:28px;}
.folder-card{background:var(--bg2);border:1px solid var(--border);border-radius:10px;
  padding:16px;cursor:pointer;transition:all .2s;text-align:center;position:relative;}
.folder-card:hover{border-color:var(--orange);background:var(--bg3);transform:translateY(-2px);}
.folder-card .fc-icon{font-size:28px;margin-bottom:8px;}
.folder-card .fc-name{font-size:12px;font-weight:600;color:var(--text);
  overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.folder-card .fc-cnt{font-size:11px;color:var(--muted);margin-top:3px;}
.folder-card .fc-actions{position:absolute;top:6px;right:6px;display:none;gap:3px;}
.folder-card:hover .fc-actions{display:flex;}
.icon-btn{width:22px;height:22px;border-radius:4px;border:none;cursor:pointer;
  display:flex;align-items:center;justify-content:center;font-size:11px;
  background:var(--bg4);color:var(--muted2);transition:all .15s;}
.icon-btn:hover.edit{background:var(--blue);color:#fff;}
.icon-btn:hover.del{background:var(--red);color:#fff;}

/* ADD FOLDER CARD */
.add-folder-card{background:transparent;border:1px dashed var(--border);border-radius:10px;
  padding:16px;cursor:pointer;transition:all .2s;text-align:center;color:var(--muted);}
.add-folder-card:hover{border-color:var(--orange);color:var(--orange);background:rgba(249,115,22,.04);}
.add-folder-card .afc-icon{font-size:24px;margin-bottom:6px;}
.add-folder-card .afc-text{font-size:12px;font-weight:500;}

/* SECTION DIVIDER */
.sec-label{font-size:11px;font-weight:700;letter-spacing:.1em;color:var(--muted);
  text-transform:uppercase;margin-bottom:12px;display:flex;align-items:center;gap:10px;}
.sec-label::after{content:'';flex:1;height:1px;background:var(--border);}

/* PHOTO GRID */
.photo-toolbar{display:flex;align-items:center;gap:10px;margin-bottom:14px;flex-wrap:wrap;}
.srch{position:relative;}
.srch svg{position:absolute;left:9px;top:50%;transform:translateY(-50%);
  pointer-events:none;color:var(--muted);}
.srch input{background:var(--bg2);border:1px solid var(--border);border-radius:7px;
  padding:7px 12px 7px 30px;color:var(--text);font-size:12px;
  font-family:'Noto Sans KR',sans-serif;width:200px;}
.srch input:focus{outline:none;border-color:var(--orange);}
.srch input::placeholder{color:var(--muted);}
.photo-stat{font-size:12px;color:var(--muted);margin-left:auto;}
.photo-stat b{color:var(--text);}

.photo-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(155px,1fr));gap:7px;}
.photo-card{position:relative;border-radius:8px;overflow:hidden;background:var(--bg3);
  cursor:pointer;border:1px solid var(--border);aspect-ratio:4/3;
  transition:transform .2s,border-color .2s,box-shadow .2s;}
.photo-card:hover{transform:translateY(-3px);border-color:var(--orange);
  box-shadow:0 10px 28px rgba(0,0,0,.5);}
.photo-card img{width:100%;height:100%;object-fit:cover;display:block;}
.photo-card .pc-ov{position:absolute;inset:0;
  background:linear-gradient(to top,rgba(0,0,0,.75),transparent 55%);
  opacity:0;transition:opacity .2s;display:flex;align-items:flex-end;padding:7px;}
.photo-card:hover .pc-ov{opacity:1;}
.photo-card .pc-nm{font-size:10px;color:#fff;word-break:break-all;line-height:1.3;}
.photo-card .pc-date{position:absolute;top:6px;left:6px;font-size:9px;
  background:rgba(0,0,0,.6);color:rgba(255,255,255,.8);padding:2px 6px;border-radius:4px;}
.photo-card .pc-del-btn{position:absolute;top:5px;right:5px;width:24px;height:24px;
  border-radius:5px;border:none;background:rgba(239,68,68,.85);color:#fff;
  font-size:12px;cursor:pointer;display:flex;align-items:center;justify-content:center;
  opacity:0;transition:opacity .15s;z-index:5;}
.photo-card:hover .pc-del-btn{opacity:1;}
.photo-card .pc-check{position:absolute;top:5px;left:5px;z-index:5;cursor:pointer;}
.photo-card .pc-check input{width:16px;height:16px;cursor:pointer;accent-color:var(--orange);}

/* EMPTY */
.empty-box{text-align:center;padding:60px 20px;color:var(--muted);}
.empty-box .eb-icon{font-size:40px;margin-bottom:12px;}
.empty-box p{font-size:13px;line-height:1.7;color:var(--muted2);}

/* MODAL */
.modal{display:none;position:fixed;inset:0;z-index:999;background:rgba(0,0,0,.93);
  align-items:center;justify-content:center;padding:20px;}
.modal.open{display:flex;}
.modal-wrap{position:relative;display:flex;flex-direction:column;align-items:center;}
.modal-img{max-width:90vw;max-height:82vh;border-radius:8px;
  box-shadow:0 24px 80px rgba(0,0,0,.8);display:block;}
.modal-x{position:absolute;top:-14px;right:-14px;width:30px;height:30px;
  border-radius:50%;background:var(--bg3);border:1px solid var(--border);
  color:var(--text);font-size:16px;cursor:pointer;
  display:flex;align-items:center;justify-content:center;transition:all .15s;}
.modal-x:hover{background:#ef4444;border-color:#ef4444;color:#fff;}
.modal-nav{display:flex;gap:10px;margin-top:14px;}
.modal-nav button{padding:7px 18px;border-radius:7px;font-size:13px;font-weight:600;
  border:1px solid var(--border);background:var(--bg3);color:var(--muted2);
  cursor:pointer;transition:all .15s;font-family:'Noto Sans KR',sans-serif;}
.modal-nav button:hover{color:var(--text);border-color:var(--muted);}
.modal-info{text-align:center;margin-top:10px;font-size:12px;color:var(--muted);}
.modal-counter{font-size:11px;color:var(--muted);margin-top:3px;}

/* DIALOG (í´ë” ì¶”ê°€/ìˆ˜ì •) */
.dialog-bg{display:none;position:fixed;inset:0;z-index:200;
  background:rgba(0,0,0,.7);align-items:center;justify-content:center;}
.dialog-bg.open{display:flex;}
.dialog{background:var(--bg2);border:1px solid var(--border);border-radius:12px;
  padding:24px;width:360px;max-width:90vw;}
.dialog h3{font-size:16px;font-weight:700;margin-bottom:16px;}
.field{margin-bottom:14px;}
.field label{display:block;font-size:12px;color:var(--muted2);margin-bottom:6px;font-weight:500;}
.field input,.field select{width:100%;background:var(--bg3);border:1px solid var(--border);
  border-radius:7px;padding:9px 12px;color:var(--text);font-size:13px;
  font-family:'Noto Sans KR',sans-serif;transition:border-color .15s;}
.field input:focus,.field select:focus{outline:none;border-color:var(--orange);}
.dialog-btns{display:flex;gap:8px;justify-content:flex-end;margin-top:20px;}

/* TOAST */
.toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(20px);
  background:var(--bg3);border:1px solid var(--border);border-radius:8px;
  padding:10px 20px;font-size:13px;color:var(--text);z-index:500;
  opacity:0;transition:all .3s;pointer-events:none;}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0);}

@media(max-width:768px){
  .sidebar{display:none;}
  .page{padding:12px 14px 40px;}
  .subfolder-grid{grid-template-columns:repeat(auto-fill,minmax(120px,1fr));}
}
</style>
</head>
<body>

<nav>
  <a class="nav-logo" href="index.html">âš  <span>SAFETY</span></a>
  <a class="nav-back" href="index.html">â† í™ˆ</a>
  <span class="nav-divider">|</span>
  <div class="breadcrumb" id="breadcrumb"></div>
  <div class="nav-right">
    <button class="btn sm" onclick="toggleEditMode()" id="editBtn">âœï¸ í¸ì§‘</button>
  </div>
</nav>

<div class="page">
  <!-- ì‚¬ì´ë“œë°” íŠ¸ë¦¬ -->
  <aside class="sidebar" id="sidebar">
    <div class="resizer" id="resizer"></div>
    <div class="sidebar-card">
      <div class="sidebar-head">
        <span>í´ë” êµ¬ì¡°</span>
      </div>
      <div class="tree" id="treeRoot"></div>
    </div>
  </aside>

  <!-- ë©”ì¸ ì½˜í…ì¸  -->
  <div class="content" id="content"></div>
</div>

<!-- ëª¨ë‹¬ -->
<div class="modal" id="modal" onclick="closeModal(event)">
  <div class="modal-wrap">
    <button class="modal-x" onclick="closeModal(null)">âœ•</button>
    <img class="modal-img" id="mImg" src="" alt="">
    <div class="modal-nav">
      <button onclick="moveModal(-1)">â† ì´ì „</button>
      <button onclick="moveModal(1)">ë‹¤ìŒ â†’</button>
    </div>
    <div class="modal-info" id="mInfo"></div>
    <div class="modal-counter" id="mCounter"></div>
  </div>
</div>

<!-- í´ë” ì¶”ê°€/ìˆ˜ì • ë‹¤ì´ì–¼ë¡œê·¸ -->
<div class="dialog-bg" id="folderDialog">
  <div class="dialog">
    <h3 id="dialogTitle">í´ë” ì¶”ê°€</h3>
    <div class="field">
      <label>í´ë” ì´ë¦„</label>
      <input type="text" id="folderNameInput" placeholder="ì˜ˆ: 01_ì¼ì¼ì ê²€">
    </div>
    <div class="field">
      <label>ì„¤ëª… (ì„ íƒ)</label>
      <input type="text" id="folderDescInput" placeholder="í´ë” ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”">
    </div>
    <div class="field">
      <label>ì•„ì´ì½˜</label>
      <select id="folderIconSelect">
        <option value="ğŸ“">ğŸ“ ê¸°ë³¸ í´ë”</option>
        <option value="ğŸ“·">ğŸ“· ì‚¬ì§„</option>
        <option value="ğŸ“‹">ğŸ“‹ ì ê²€</option>
        <option value="âš ï¸">âš ï¸ ê²½ê³ </option>
        <option value="âœ…">âœ… ì™„ë£Œ</option>
        <option value="ğŸ“Š">ğŸ“Š ë³´ê³ ì„œ</option>
        <option value="ğŸ—ï¸">ğŸ—ï¸ ê³µì‚¬</option>
        <option value="ğŸ‘·">ğŸ‘· ì•ˆì „</option>
        <option value="ğŸ”">ğŸ” ì¡°ì‚¬</option>
        <option value="ğŸ“">ğŸ“ ê¸°ë¡</option>
      </select>
    </div>
    <div class="dialog-btns">
      <button class="btn" onclick="closeDialog()">ì·¨ì†Œ</button>
      <button class="btn primary" onclick="saveFolder()" id="dialogSaveBtn">ì¶”ê°€</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// â”€â”€ ê¸°ë³¸ í´ë” êµ¬ì¡° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const DEFAULT_STRUCTURE = {
  id: 'root', name: 'í˜„ì¥ì‚¬ì§„ê´€ë¦¬', icon: 'ğŸ“¸', desc: 'ì „ì²´ í˜„ì¥ ì‚¬ì§„ ê´€ë¦¬',
  children: [
    { id: 'c01', name: '01.ì ê²€ê¸°ë¡', icon: 'ğŸ“‹', desc: 'ê°ì¢… ì ê²€ ì‚¬ì§„ ê¸°ë¡', children: [
      { id: 'c01_01', name: '01_ì¼ì¼ì ê²€', icon: 'ğŸ“…', desc: 'ì¼ì¼ ì•ˆì „ì ê²€ ì‚¬ì§„', children: [] },
      { id: 'c01_02', name: '02_ì •ê¸°ì ê²€', icon: 'ğŸ”„', desc: 'ì •ê¸°ì ê²€ ì‚¬ì§„', children: [
        { id: 'c01_02_01', name: '01_ì›”ê°„ì ê²€', icon: 'ğŸ“†', desc: '', children: [] },
        { id: 'c01_02_02', name: '02_ë²•ì •ì ê²€', icon: 'âš–ï¸', desc: '', children: [] },
        { id: 'c01_02_03', name: '03_í˜‘ë ¥ì—…ì²´ì ê²€', icon: 'ğŸ¤', desc: '', children: [] },
      ]},
      { id: 'c01_03', name: '03_í•©ë™ì ê²€', icon: 'ğŸ‘¥', desc: 'í•©ë™ì ê²€ ì‚¬ì§„', children: [
        { id: 'c01_03_01', name: '01_ë°œì£¼ì²˜í•©ë™ì ê²€', icon: 'ğŸ¢', desc: '', children: [] },
        { id: 'c01_03_02', name: '02_ê°ë¦¬í•©ë™ì ê²€', icon: 'ğŸ”', desc: '', children: [] },
      ]},
      { id: 'c01_04', name: '04_ìœ ê´€ê¸°ê´€ì ê²€', icon: 'ğŸ›ï¸', desc: '', children: [] },
    ]},
    { id: 'c02', name: '02.ì§€ì &ì´ìŠˆ', icon: 'âš ï¸', desc: 'ì§€ì ì‚¬í•­ ë° ì´ìŠˆ ì‚¬ì§„', children: [] },
    { id: 'c03', name: '03.ê°œì„ ì¡°ì¹˜', icon: 'âœ…', desc: 'ê°œì„ ì¡°ì¹˜ ì „í›„ ì‚¬ì§„', children: [] },
    { id: 'c04', name: '04.êµìœ¡&íšŒì˜', icon: 'ğŸ“', desc: 'êµìœ¡ ë° íšŒì˜ ì‚¬ì§„', children: [] },
    { id: 'c05', name: '05.ì‚¬ê³ ì‚¬ë¡€', icon: 'ğŸš¨', desc: 'ì‚¬ê³ ì‚¬ë¡€ ì‚¬ì§„', children: [] },
    { id: 'c06', name: '06.ê¸°íƒ€', icon: 'ğŸ“¦', desc: 'ê¸°íƒ€ ì‚¬ì§„', children: [] },
  ]
};

// â”€â”€ GitHub API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const OWNER  = 'fnksoul-ai';
const REPO   = 'safety-portal';
const BRANCH = 'main';
function getToken() { return localStorage.getItem('gh_token') || ''; }

function encodePath(path) {
  return path.split('/').map(seg => encodeURIComponent(seg)).join('/');
}

async function ghFetch(endpoint, method, body) {
  const token = getToken();
  if (!token) throw new Error('í† í° ì—†ìŒ â€” upload.htmlì—ì„œ ë¨¼ì € ì„¤ì •í•´ì£¼ì„¸ìš”');
  const res = await fetch(`https://api.github.com/repos/${OWNER}/${REPO}/${endpoint}`, {
    method,
    headers: {
      'Authorization': `Bearer ${token}`,
      'Content-Type': 'application/json',
      'Accept': 'application/vnd.github+json',
    },
    body: body ? JSON.stringify(body) : undefined,
  });
  if (method === 'DELETE' && res.status === 204) return {};
  const data = await res.json();
  if (!res.ok) throw new Error(data.message || `HTTP ${res.status}`);
  return data;
}

async function getFileSha(filePath) {
  try {
    const encoded = encodePath(filePath);
    const r = await ghFetch(`contents/${encoded}`, 'GET');
    return r.sha || null;
  } catch(e) {
    console.error('SHA ì¡°íšŒ ì‹¤íŒ¨:', filePath, e.message);
    return null;
  }
}

// â”€â”€ ìƒíƒœ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let structure  = loadStructure();
let currentPath= ['root'];  // id ë°°ì—´
let editMode   = false;
let allPhotos  = [];         // í˜„ì¬ í´ë”ì˜ ì‚¬ì§„ ëª©ë¡ (modalìš©)
let curModalIdx= 0;
let dialogMode = null;       // 'add' | 'edit'
let editTarget = null;       // ìˆ˜ì • ëŒ€ìƒ node
let dialogParentId = null;
let selectedPhotos = new Set(); // í¸ì§‘ëª¨ë“œ ì„ íƒëœ ì‚¬ì§„ src ëª©ë¡

function loadStructure() {
  try {
    const s = localStorage.getItem('galleryStructure');
    return s ? JSON.parse(s) : JSON.parse(JSON.stringify(DEFAULT_STRUCTURE));
  } catch { return JSON.parse(JSON.stringify(DEFAULT_STRUCTURE)); }
}
function saveStructure() {
  localStorage.setItem('galleryStructure', JSON.stringify(structure));
}

// â”€â”€ ë…¸ë“œ íƒìƒ‰ í—¬í¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function findNode(id, node) {
  if (!node) node = structure;
  if (node.id === id) return node;
  if (node.children) {
    for (const c of node.children) {
      const r = findNode(id, c);
      if (r) return r;
    }
  }
  return null;
}
function findParent(id, node, parent) {
  if (!node) node = structure;
  if (node.id === id) return parent;
  if (node.children) {
    for (const c of node.children) {
      const r = findParent(id, c, node);
      if (r) return r;
    }
  }
  return null;
}
function genId() { return 'f_' + Date.now() + '_' + Math.random().toString(36).slice(2,6); }

// â”€â”€ íŠ¸ë¦¬ ë Œë” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderTree() {
  const root = document.getElementById('treeRoot');
  root.innerHTML = '';
  renderTreeNode(structure, root, 0);
}
function renderTreeNode(node, container, depth) {
  const item = document.createElement('div');
  const hasChildren = node.children && node.children.length > 0;
  const isActive = currentPath[currentPath.length-1] === node.id;
  const isOpen   = currentPath.includes(node.id);

  item.className = 'tree-item' + (isActive ? ' active' : '') + (isOpen && hasChildren ? ' open' : '');
  item.style.paddingLeft = (14 + depth * 12) + 'px';
  item.innerHTML = `
    <span class="ti-toggle">${hasChildren ? 'â–¶' : ' '}</span>
    <span class="ti-icon">${node.icon||'ğŸ“'}</span>
    <span class="ti-name">${node.name}</span>
  `;
  item.onclick = (e) => { e.stopPropagation(); navigateTo(node.id); };
  container.appendChild(item);

  if (hasChildren) {
    const children = document.createElement('div');
    children.className = 'tree-children' + (isOpen ? '' : ' hidden');
    node.children.forEach(c => renderTreeNode(c, children, depth + 1));
    container.appendChild(children);
  }
}

// â”€â”€ ë¸Œë ˆë“œí¬ëŸ¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderBreadcrumb() {
  const bc = document.getElementById('breadcrumb');
  bc.innerHTML = '';
  currentPath.forEach((id, i) => {
    const node = findNode(id);
    if (!node) return;
    if (i > 0) { const sep = document.createElement('span'); sep.className='bc-sep'; sep.textContent='â€º'; bc.appendChild(sep); }
    const item = document.createElement('span');
    item.className = 'bc-item' + (i === currentPath.length-1 ? ' active' : '');
    item.textContent = node.name;
    item.onclick = () => navigateToPath(currentPath.slice(0, i+1));
    bc.appendChild(item);
  });
}

// â”€â”€ ë„¤ë¹„ê²Œì´ì…˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function navigateTo(id) {
  // ê²½ë¡œ ì¬ê³„ì‚°
  const path = getPathTo(id, structure, []);
  if (path) { currentPath = path; renderAll(); }
}
function getPathTo(targetId, node, path) {
  const newPath = [...path, node.id];
  if (node.id === targetId) return newPath;
  if (node.children) {
    for (const c of node.children) {
      const r = getPathTo(targetId, c, newPath);
      if (r) return r;
    }
  }
  return null;
}
function navigateToPath(path) { currentPath = path; renderAll(); }

function renderAll() {
  renderTree();
  renderBreadcrumb();
  renderContent();
  if (window._updateContentMargin) window._updateContentMargin();
}

// â”€â”€ ì½˜í…ì¸  ë Œë” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderContent() {
  const node = findNode(currentPath[currentPath.length-1]);
  if (!node) return;
  const content = document.getElementById('content');
  content.innerHTML = '';

  // í—¤ë”
  const hdr = document.createElement('div');
  hdr.className = 'folder-header';
  hdr.innerHTML = `
    <span class="folder-icon">${node.icon||'ğŸ“'}</span>
    <div>
      <div class="folder-title">${node.name}</div>
      ${node.desc ? `<div class="folder-desc">${node.desc}</div>` : ''}
    </div>
    <div class="folder-actions" id="folderActions"></div>
  `;
  content.appendChild(hdr);

  // í¸ì§‘ ë²„íŠ¼
  if (editMode && node.id !== 'root') {
    const fa = hdr.querySelector('#folderActions');
    fa.innerHTML = `
      <button class="btn sm" onclick="openEditDialog('${node.id}')">âœï¸ ì´ë¦„ ë³€ê²½</button>
      <button class="btn sm danger" onclick="deleteFolder('${node.id}')">ğŸ—‘ï¸ ì‚­ì œ</button>
    `;
  }

  // í•˜ìœ„ í´ë”
  if (node.children && node.children.length > 0) {
    const secLbl = document.createElement('div');
    secLbl.className = 'sec-label';
    secLbl.textContent = 'í•˜ìœ„ í´ë”';
    content.appendChild(secLbl);

    const grid = document.createElement('div');
    grid.className = 'subfolder-grid';
    node.children.forEach(child => {
      const card = document.createElement('div');
      card.className = 'folder-card';
      card.innerHTML = `
        <div class="fc-icon">${child.icon||'ğŸ“'}</div>
        <div class="fc-name">${child.name}</div>
        <div class="fc-cnt">${countChildren(child)}</div>
        ${editMode ? `<div class="fc-actions">
          <button class="icon-btn edit" onclick="event.stopPropagation();openEditDialog('${child.id}')">âœï¸</button>
          <button class="icon-btn del"  onclick="event.stopPropagation();deleteFolder('${child.id}')">ğŸ—‘</button>
        </div>` : ''}
      `;
      card.onclick = () => navigateTo(child.id);
      grid.appendChild(card);
    });

    // í´ë” ì¶”ê°€ ë²„íŠ¼
    if (editMode) {
      const addCard = document.createElement('div');
      addCard.className = 'add-folder-card';
      addCard.innerHTML = `<div class="afc-icon">â•</div><div class="afc-text">í´ë” ì¶”ê°€</div>`;
      addCard.onclick = () => openAddDialog(node.id);
      grid.appendChild(addCard);
    }
    content.appendChild(grid);
  } else if (editMode) {
    const grid = document.createElement('div');
    grid.className = 'subfolder-grid';
    const addCard = document.createElement('div');
    addCard.className = 'add-folder-card';
    addCard.innerHTML = `<div class="afc-icon">â•</div><div class="afc-text">í´ë” ì¶”ê°€</div>`;
    addCard.onclick = () => openAddDialog(node.id);
    grid.appendChild(addCard);

    const secLbl = document.createElement('div');
    secLbl.className = 'sec-label';
    secLbl.textContent = 'í•˜ìœ„ í´ë”';
    content.appendChild(secLbl);
    content.appendChild(grid);
  }

  // ì‚¬ì§„ ì„¹ì…˜
  renderPhotos(node, content);
}

function countChildren(node) {
  if (!node.children || !node.children.length) return 'í´ë” ì—†ìŒ';
  return node.children.length + 'ê°œ í´ë”';
}

// â”€â”€ ì‚¬ì§„ ë Œë” (photos.json ë¡œë“œ) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderPhotos(node, container) {
  // í˜„ì¬ í´ë” ê²½ë¡œ ê¸°ë°˜ìœ¼ë¡œ photos.jsonì—ì„œ ì‚¬ì§„ ë§¤í•‘
  // í´ë” ì´ë¦„ì—ì„œ ë‚ ì§œ íŒ¨í„´ ì‚¬ì§„ ë˜ëŠ” í´ë”ëª… ê¸°ë°˜ ì‚¬ì§„ í‘œì‹œ
  const pathStr = currentPath.slice(1).map(id => findNode(id)?.name || '').join('/');

  // photos.jsonì—ì„œ ë¡œë“œ ì‹œë„
  fetch('photos.json?t=' + Date.now())
    .then(r => r.ok ? r.json() : null)
    .then(data => {
      if (!data) { renderPhotoEmpty(container, true); return; }

      // ê²½ë¡œì— ë§ëŠ” ì‚¬ì§„ í•„í„°ë§
      // photos.jsonì˜ srcê°€ í˜„ì¬ í´ë” ê²½ë¡œë¥¼ í¬í•¨í•˜ëŠ” ê²ƒë§Œ
      let photos = [];
      const nodeName = node.name.toLowerCase();

      Object.entries(data).forEach(([date, list]) => {
        list.forEach(p => {
          const srcLower = p.src.toLowerCase();
          // í˜„ì¬ í´ë”ëª…ì´ ê²½ë¡œì— í¬í•¨ë˜ê±°ë‚˜ ë£¨íŠ¸/ì ê²€ê¸°ë¡ ê³„ì—´ì´ë©´ í¬í•¨
          if (srcLower.includes(nodeName.replace(/[0-9_\.]/g,'').trim()) ||
              node.id === 'c01_01' || currentPath.includes('c01_01')) {
            photos.push({...p, date});
          }
        });
      });

      // ì¼ì¼ì ê²€ í´ë”ê±°ë‚˜ rootì—ì„  ì „ì²´ í‘œì‹œ
      if (node.id === 'root' || node.id === 'c01_01') {
        photos = [];
        Object.entries(data).forEach(([date, list]) => {
          list.forEach(p => photos.push({...p, date}));
        });
      }

      if (!photos.length) { renderPhotoEmpty(container, false); return; }

      allPhotos = photos;
      const secLbl = document.createElement('div');
      secLbl.className = 'sec-label';
      secLbl.textContent = 'ì‚¬ì§„ (' + photos.length + 'ì¥)';
      container.appendChild(secLbl);

      const toolbar = document.createElement('div');
      toolbar.className = 'photo-toolbar';
      const bulkBtns = editMode ? `
        <button class="btn sm" onclick="selectAllPhotos(true)">ì „ì²´ì„ íƒ</button>
        <button class="btn sm" onclick="selectAllPhotos(false)">ì„ íƒí•´ì œ</button>
        <button class="btn sm danger" id="bulkDelBtn" onclick="deleteSelectedPhotos()" style="display:none">ğŸ—‘ ì„ íƒì‚­ì œ</button>
      ` : '';
      toolbar.innerHTML = `
        <div class="srch">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
            <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
          </svg>
          <input type="text" placeholder="íŒŒì¼ëª… ë˜ëŠ” ë‚ ì§œ ê²€ìƒ‰" oninput="filterPhotos(this.value,'photoGrid')">
        </div>
        ${bulkBtns}
        <div class="photo-stat"><b>${photos.length}</b>ì¥</div>
      `;
      container.appendChild(toolbar);

      const grid = document.createElement('div');
      grid.className = 'photo-grid'; grid.id = 'photoGrid';
      photos.forEach((p, i) => {
        const card = document.createElement('div');
        card.className = 'photo-card'; card.dataset.name = p.name; card.dataset.date = p.date||''; card.dataset.src = p.src;
        const deleteBtn = editMode
          ? `<button class="pc-del-btn" onclick="event.stopPropagation();deletePhoto('${p.src}','${p.name}')" title="ì‚­ì œ">ğŸ—‘</button>`
          : '';
        const checkbox = editMode
          ? `<label class="pc-check" onclick="event.stopPropagation()"><input type="checkbox" onchange="toggleSelectPhoto('${p.src}',this.checked)" ${selectedPhotos.has(p.src)?'checked':''}></label>`
          : '';
        card.innerHTML = `
          <img src="${p.src}" alt="${p.name}" loading="lazy"
            onerror="this.closest('.photo-card').remove(); removeBrokenFromJson('${p.src}');">
          <span class="pc-date">${p.date||''}</span>
          <div class="pc-ov"><div class="pc-nm">${p.name}</div></div>
          ${deleteBtn}${checkbox}
        `;
        if (!editMode) card.onclick = () => { curModalIdx = i; updateModal(); document.getElementById('modal').classList.add('open'); };
        grid.appendChild(card);
      });
      container.appendChild(grid);
    })
    .catch(() => renderPhotoEmpty(container, true));
}

function renderPhotoEmpty(container, noFile) {
  const box = document.createElement('div');
  box.className = 'empty-box';
  if (noFile) {
    box.innerHTML = `<div class="eb-icon">ğŸ“‚</div>
      <p>photos.json íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.<br>
      <b>ì‚¬ì§„ëª©ë¡_ìƒì„±.vbs</b>ë¥¼ ì‹¤í–‰ í›„ GitHubì— ì—…ë¡œë“œí•´ ì£¼ì„¸ìš”.</p>`;
  } else {
    box.innerHTML = `<div class="eb-icon">ğŸ–¼ï¸</div>
      <p>ì´ í´ë”ì— ë“±ë¡ëœ ì‚¬ì§„ì´ ì—†ìŠµë‹ˆë‹¤.</p>`;
  }
  container.appendChild(box);
}

function filterPhotos(val, gridId) {
  document.querySelectorAll('#'+gridId+' .photo-card').forEach(card => {
    const match = !val ||
      card.dataset.name.toLowerCase().includes(val.toLowerCase()) ||
      card.dataset.date.includes(val);
    card.style.display = match ? '' : 'none';
  });
}

// â”€â”€ ëª¨ë‹¬ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateModal() {
  const p = allPhotos[curModalIdx];
  document.getElementById('mImg').src = p.src;
  document.getElementById('mInfo').textContent = (p.date||'') + '  Â·  ' + p.name;
  document.getElementById('mCounter').textContent = (curModalIdx+1) + ' / ' + allPhotos.length;
}
function moveModal(dir) {
  curModalIdx = (curModalIdx + dir + allPhotos.length) % allPhotos.length;
  updateModal();
}
function closeModal(e) {
  if (e===null || e.target===document.getElementById('modal'))
    document.getElementById('modal').classList.remove('open');
}
document.addEventListener('keydown', e => {
  if (!document.getElementById('modal').classList.contains('open')) return;
  if (e.key==='Escape') closeModal(null);
  if (e.key==='ArrowLeft') moveModal(-1);
  if (e.key==='ArrowRight') moveModal(1);
});

// â”€â”€ í¸ì§‘ ëª¨ë“œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleEditMode() {
  editMode = !editMode;
  const btn = document.getElementById('editBtn');
  btn.textContent = editMode ? 'âœ… ì™„ë£Œ' : 'âœï¸ í¸ì§‘';
  btn.className   = editMode ? 'btn sm primary' : 'btn sm';
  renderAll();
  showToast(editMode ? 'í¸ì§‘ ëª¨ë“œ í™œì„±í™”' : 'í¸ì§‘ ì™„ë£Œ');
}

// â”€â”€ í´ë” ì¶”ê°€/ìˆ˜ì •/ì‚­ì œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openAddDialog(parentId) {
  dialogMode = 'add'; dialogParentId = parentId; editTarget = null;
  document.getElementById('dialogTitle').textContent = 'í´ë” ì¶”ê°€';
  document.getElementById('dialogSaveBtn').textContent = 'ì¶”ê°€';
  document.getElementById('folderNameInput').value = '';
  document.getElementById('folderDescInput').value = '';
  document.getElementById('folderIconSelect').value = 'ğŸ“';
  document.getElementById('folderDialog').classList.add('open');
  setTimeout(() => document.getElementById('folderNameInput').focus(), 100);
}
function openEditDialog(id) {
  const node = findNode(id);
  if (!node) return;
  dialogMode = 'edit'; editTarget = node;
  document.getElementById('dialogTitle').textContent = 'í´ë” ìˆ˜ì •';
  document.getElementById('dialogSaveBtn').textContent = 'ì €ì¥';
  document.getElementById('folderNameInput').value = node.name;
  document.getElementById('folderDescInput').value = node.desc||'';
  document.getElementById('folderIconSelect').value = node.icon||'ğŸ“';
  document.getElementById('folderDialog').classList.add('open');
  setTimeout(() => document.getElementById('folderNameInput').focus(), 100);
}
function closeDialog() { document.getElementById('folderDialog').classList.remove('open'); }

function saveFolder() {
  const name = document.getElementById('folderNameInput').value.trim();
  if (!name) { document.getElementById('folderNameInput').focus(); return; }
  const desc = document.getElementById('folderDescInput').value.trim();
  const icon = document.getElementById('folderIconSelect').value;

  if (dialogMode === 'add') {
    const parent = findNode(dialogParentId);
    if (!parent) return;
    if (!parent.children) parent.children = [];
    parent.children.push({ id: genId(), name, icon, desc, children: [] });
    showToast('í´ë” ì¶”ê°€ë¨: ' + name);
  } else if (dialogMode === 'edit' && editTarget) {
    editTarget.name = name; editTarget.icon = icon; editTarget.desc = desc;
    showToast('í´ë” ìˆ˜ì •ë¨: ' + name);
  }
  saveStructure();
  closeDialog();
  renderAll();
}

function deleteFolder(id) {
  const node = findNode(id);
  if (!node) return;
  if (!confirm('\"' + node.name + '\" í´ë”ë¥¼ ì‚­ì œí• ê¹Œìš”?\n(í•˜ìœ„ í´ë”ë„ ëª¨ë‘ ì‚­ì œë©ë‹ˆë‹¤)')) return;
  const parent = findParent(id);
  if (!parent) return;
  parent.children = parent.children.filter(c => c.id !== id);
  // í˜„ì¬ ê²½ë¡œì— ìˆë˜ í´ë”ê°€ ì‚­ì œëœ ê²½ìš° ìƒìœ„ë¡œ ì´ë™
  if (currentPath.includes(id)) {
    const idx = currentPath.indexOf(id);
    currentPath = currentPath.slice(0, idx);
    if (!currentPath.length) currentPath = ['root'];
  }
  saveStructure();
  renderAll();
  showToast('í´ë” ì‚­ì œë¨: ' + node.name);
}

// â”€â”€ ë‹¤ì´ì–¼ë¡œê·¸ í‚¤ë³´ë“œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('keydown', e => {
  if (document.getElementById('folderDialog').classList.contains('open')) {
    if (e.key === 'Enter') saveFolder();
    if (e.key === 'Escape') closeDialog();
  }
});
document.getElementById('folderDialog').onclick = e => {
  if (e.target === document.getElementById('folderDialog')) closeDialog();
};

// â”€â”€ ì´ˆê¸°í™” ë²„íŠ¼ (êµ¬ì¡° ë¦¬ì…‹) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ìˆ¨ê²¨ì§„ ê¸°ëŠ¥: ì½˜ì†”ì—ì„œ resetStructure() í˜¸ì¶œ ê°€ëŠ¥
window.resetStructure = () => {
  if (confirm('í´ë” êµ¬ì¡°ë¥¼ ê¸°ë³¸ê°’ìœ¼ë¡œ ì´ˆê¸°í™”í• ê¹Œìš”?')) {
    localStorage.removeItem('galleryStructure');
    structure = JSON.parse(JSON.stringify(DEFAULT_STRUCTURE));
    currentPath = ['root'];
    renderAll();
    showToast('ì´ˆê¸°í™” ì™„ë£Œ');
  }
};

// â”€â”€ ì‚¬ì§„ ì„ íƒ/ì‚­ì œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleSelectPhoto(src, checked) {
  if (checked) selectedPhotos.add(src);
  else selectedPhotos.delete(src);
  const btn = document.getElementById('bulkDelBtn');
  if (btn) btn.style.display = selectedPhotos.size > 0 ? '' : 'none';
}

function selectAllPhotos(all) {
  document.querySelectorAll('#photoGrid .photo-card').forEach(card => {
    const src = card.dataset.src;
    const cb  = card.querySelector('input[type=checkbox]');
    if (!src) return;
    if (all) { selectedPhotos.add(src); if(cb) cb.checked = true; }
    else      { selectedPhotos.delete(src); if(cb) cb.checked = false; }
  });
  const btn = document.getElementById('bulkDelBtn');
  if (btn) btn.style.display = selectedPhotos.size > 0 ? '' : 'none';
}

async function deletePhoto(src, name) {
  if (!getToken()) { showToast('âš  upload.htmlì—ì„œ í† í°ì„ ë¨¼ì € ì„¤ì •í•´ì£¼ì„¸ìš”'); return; }
  if (!confirm('"' + name + '" ì‚¬ì§„ì„ ì‚­ì œí• ê¹Œìš”?\nGitHubì—ì„œ ì˜êµ¬ ì‚­ì œë©ë‹ˆë‹¤.')) return;
  showToast('ğŸ—‘ ì‚­ì œ ì¤‘...');
  try {
    const sha = await getFileSha(src);
    if (!sha) { showToast('âš  íŒŒì¼ SHA ì¡°íšŒ ì‹¤íŒ¨ â€” í† í° ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”'); return; }
    await ghFetch(`contents/${encodePath(src)}`, 'DELETE', { message: 'ì‚¬ì§„ ì‚­ì œ: ' + name, sha, branch: BRANCH });
    // ë¡œì»¬ allPhotosì—ì„œ ì¦‰ì‹œ ì œê±°
    allPhotos = allPhotos.filter(p => p.src !== src);
    selectedPhotos.delete(src);
    // DOMì—ì„œ í•´ë‹¹ ì¹´ë“œ ì¦‰ì‹œ ì œê±°
    document.querySelectorAll('#photoGrid .photo-card').forEach(card => {
      if (card.dataset.src === src) card.remove();
    });
    // ì‚¬ì§„ ìˆ˜ ì—…ë°ì´íŠ¸
    const stat = document.querySelector('.photo-stat b');
    if (stat) stat.textContent = allPhotos.length;
    showToast('âœ… ì‚­ì œ ì™„ë£Œ: ' + name);
    // photos.json ë°±ê·¸ë¼ìš´ë“œ ì—…ë°ì´íŠ¸
    removeFromPhotosJson([src]);
  } catch(e) { showToast('âŒ ì‚­ì œ ì‹¤íŒ¨: ' + e.message); }
}

async function deleteSelectedPhotos() {
  if (!getToken()) { showToast('âš  upload.htmlì—ì„œ í† í°ì„ ë¨¼ì € ì„¤ì •í•´ì£¼ì„¸ìš”'); return; }
  if (!selectedPhotos.size) return;
  if (!confirm('ì„ íƒí•œ ' + selectedPhotos.size + 'ì¥ì„ ì‚­ì œí• ê¹Œìš”?\nGitHubì—ì„œ ì˜êµ¬ ì‚­ì œë©ë‹ˆë‹¤.')) return;
  let ok = 0, fail = 0;
  const srcs = [...selectedPhotos];
  for (const src of srcs) {
    try {
      const sha = await getFileSha(src);
      if (!sha) { fail++; continue; }
      const name = src.split('/').pop();
      await ghFetch(`contents/${encodePath(src)}`, 'DELETE', { message: 'ì‚¬ì§„ ì‚­ì œ: ' + name, sha, branch: BRANCH });
      ok++;
    } catch { fail++; }
  }
  // ë¡œì»¬ì—ì„œ ì¦‰ì‹œ ì œê±°
  srcs.forEach(src => {
    allPhotos = allPhotos.filter(p => p.src !== src);
    document.querySelectorAll('#photoGrid .photo-card').forEach(card => {
      if (card.dataset.src === src) card.remove();
    });
  });
  selectedPhotos.clear();
  const stat = document.querySelector('.photo-stat b');
  if (stat) stat.textContent = allPhotos.length;
  showToast('âœ… ' + ok + 'ì¥ ì‚­ì œ ì™„ë£Œ' + (fail ? ' / âŒ ' + fail + 'ì¥ ì‹¤íŒ¨' : ''));
  // photos.json ë°±ê·¸ë¼ìš´ë“œ ì—…ë°ì´íŠ¸
  removeFromPhotosJson(srcs);
}

async function removeFromPhotosJson(deletedSrcs) {
  try {
    const f = await ghFetch('contents/photos.json', 'GET');
    const sha = f.sha;
    let data = JSON.parse(atob(f.content.replace(/\n/g,'')));
    deletedSrcs.forEach(src => {
      Object.keys(data).forEach(date => {
        data[date] = data[date].filter(p => p.src !== src);
        if (!data[date].length) delete data[date];
      });
    });
    const encoded = btoa(unescape(encodeURIComponent(JSON.stringify(data, null, 2))));
    await ghFetch('contents/photos.json', 'PUT', {
      message: 'photos.json ì—…ë°ì´íŠ¸ (ì‚­ì œ: ' + deletedSrcs.length + 'ì¥)',
      content: encoded, sha, branch: BRANCH
    });
    console.log('photos.json ì—…ë°ì´íŠ¸ ì™„ë£Œ');
  } catch(e) {
    console.error('photos.json ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', e.message);
    showToast('âš  photos.json ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ' + e.message);
  }
}

// â”€â”€ ê¹¨ì§„ ì‚¬ì§„ ìë™ ì •ë¦¬ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function removeBrokenFromJson(src) {
  try {
    const f = await ghFetch('contents/photos.json', 'GET');
    const sha = f.sha;
    let data = JSON.parse(atob(f.content.replace(/\n/g,'')));
    let changed = false;
    Object.keys(data).forEach(date => {
      const before = data[date].length;
      data[date] = data[date].filter(p => p.src !== src);
      if (data[date].length !== before) changed = true;
      if (!data[date].length) delete data[date];
    });
    if (!changed) return;
    const encoded = btoa(unescape(encodeURIComponent(JSON.stringify(data, null, 2))));
    await ghFetch('contents/photos.json', 'PUT', {
      message: 'photos.json ì •ë¦¬: ì—†ëŠ” íŒŒì¼ ì œê±°',
      content: encoded, sha, branch: BRANCH
    });
  } catch(e) { console.log('json ì •ë¦¬ ì‹¤íŒ¨:', e.message); }
}

// â”€â”€ í† ìŠ¤íŠ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2500);
}

// â”€â”€ ì‚¬ì´ë“œë°” ë“œë˜ê·¸ ë¦¬ì‚¬ì´ì¦ˆ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(function() {
  const sidebar  = document.getElementById('sidebar');
  const resizer  = document.getElementById('resizer');
  const content  = document.getElementById('content');
  const page     = document.querySelector('.page');
  let isDown = false, startX = 0, startW = 0;

  // ì €ì¥ëœ ë„ˆë¹„ ë³µì›
  const saved = localStorage.getItem('sidebarWidth');
  if (saved) sidebar.style.width = saved + 'px';
  updateContentMargin();

  resizer.addEventListener('mousedown', e => {
    isDown = true;
    startX = e.clientX;
    startW = sidebar.offsetWidth;
    resizer.classList.add('active');
    document.body.style.cursor = 'col-resize';
    document.body.style.userSelect = 'none';
    e.preventDefault();
  });

  document.addEventListener('mousemove', e => {
    if (!isDown) return;
    const diff = e.clientX - startX;
    const newW = Math.min(500, Math.max(180, startW + diff));
    sidebar.style.width = newW + 'px';
    updateContentMargin();
  });

  document.addEventListener('mouseup', () => {
    if (!isDown) return;
    isDown = false;
    resizer.classList.remove('active');
    document.body.style.cursor = '';
    document.body.style.userSelect = '';
    localStorage.setItem('sidebarWidth', sidebar.offsetWidth);
  });

  // ë”ë¸”í´ë¦­ â†’ ë„ˆë¹„ ìë™ ë§ì¶¤
  resizer.addEventListener('dblclick', () => {
    // íŠ¸ë¦¬ ì•„ì´í…œ ì¤‘ ê°€ì¥ ê¸´ ê²ƒ ê¸°ì¤€ìœ¼ë¡œ ìë™ ë§ì¶¤
    let maxW = 180;
    document.querySelectorAll('.tree-item').forEach(el => {
      maxW = Math.max(maxW, el.scrollWidth + 20);
    });
    maxW = Math.min(500, maxW);
    sidebar.style.width = maxW + 'px';
    updateContentMargin();
    localStorage.setItem('sidebarWidth', maxW);
  });

  function updateContentMargin() {
    const w = sidebar.offsetWidth;
    document.querySelector('.content').style.marginLeft = (w + 20) + 'px';
  }
  window._updateContentMargin = updateContentMargin;
})();

// â”€â”€ ì‹œì‘ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
renderAll();
</script>
</body>
</html>
