<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>í˜„ì¥ì‚¬ì§„ ê°¤ëŸ¬ë¦¬ Â· Safety Portal</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&family=Bebas+Neue&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0f1117;--bg2:#171b24;--bg3:#1e2330;--bg4:#252a38;
  --border:#2c3347;--orange:#f97316;--blue:#3b82f6;
  --green:#22c55e;--red:#ef4444;--yellow:#eab308;
  --text:#f1f5f9;--muted:#64748b;--muted2:#94a3b8;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
html{scroll-behavior:smooth;}
body{font-family:'Noto Sans KR',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;}
body::before{content:'';position:fixed;inset:0;z-index:0;
  background-image:linear-gradient(rgba(249,115,22,.025) 1px,transparent 1px),
  linear-gradient(90deg,rgba(249,115,22,.025) 1px,transparent 1px);
  background-size:40px 40px;pointer-events:none;}

nav{position:sticky;top:0;z-index:100;background:rgba(15,17,23,.95);
  backdrop-filter:blur(16px);border-bottom:1px solid var(--border);
  padding:0 24px;display:flex;align-items:center;height:52px;gap:16px;}
.nav-logo{font-family:'Bebas Neue',sans-serif;font-size:20px;letter-spacing:.1em;color:var(--orange);text-decoration:none;}
.nav-logo span{color:var(--text);}
.nav-back{font-size:12px;color:var(--muted2);text-decoration:none;display:flex;align-items:center;gap:4px;padding:5px 10px;border-radius:6px;transition:all .15s;}
.nav-back:hover{color:var(--text);background:var(--bg3);}
.breadcrumb{display:flex;align-items:center;gap:6px;font-size:13px;overflow:hidden;flex-wrap:wrap;}
.bc-item{color:var(--muted2);cursor:pointer;white-space:nowrap;padding:3px 6px;border-radius:5px;transition:all .15s;}
.bc-item:hover{color:var(--text);background:var(--bg3);}
.bc-item.active{color:var(--text);font-weight:600;}
.bc-sep{color:var(--muted);font-size:11px;}
.nav-right{margin-left:auto;display:flex;align-items:center;gap:10px;}
.admin-btn{display:flex;align-items:center;gap:6px;font-size:12px;padding:5px 12px;border-radius:6px;border:1px solid var(--border);background:var(--bg3);color:var(--muted2);cursor:pointer;transition:all .15s;font-family:'Noto Sans KR',sans-serif;}
.admin-btn:hover{color:var(--text);border-color:var(--muted);}
.admin-btn.logged{border-color:var(--green);color:var(--green);}
.admin-btn .dot{width:7px;height:7px;border-radius:50%;background:var(--muted);}
.admin-btn.logged .dot{background:var(--green);box-shadow:0 0 5px var(--green);}
.btn{padding:6px 14px;border-radius:7px;font-size:12px;font-weight:600;cursor:pointer;
  border:1px solid var(--border);background:var(--bg3);color:var(--muted2);
  transition:all .15s;font-family:'Noto Sans KR',sans-serif;white-space:nowrap;}
.btn:hover{color:var(--text);border-color:var(--muted);}
.btn.primary{background:var(--orange);border-color:var(--orange);color:#fff;}
.btn.primary:hover{background:#ea6c0a;}
.btn.danger{border-color:var(--red);color:var(--red);}
.btn.danger:hover{background:var(--red);color:#fff;}
.btn.sm{padding:4px 10px;font-size:11px;}
.btn.google{background:#fff;border-color:#ddd;color:#333;display:flex;align-items:center;gap:8px;}
.btn.google:hover{background:#f5f5f5;}

/* ê´€ë¦¬ì ë¡œê·¸ì¸ ë“œë¡­ë‹¤ìš´ */
.admin-dropdown{position:fixed;top:60px;right:16px;width:300px;background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:20px;z-index:200;box-shadow:0 8px 32px rgba(0,0,0,.5);display:none;}
.admin-dropdown.open{display:block;}
.admin-dropdown h4{font-size:14px;font-weight:700;margin-bottom:6px;}
.admin-dropdown p{font-size:12px;color:var(--muted2);margin-bottom:16px;line-height:1.6;}
.admin-profile{display:flex;align-items:center;gap:12px;padding:12px;background:var(--bg3);border-radius:8px;margin-bottom:12px;}
.admin-avatar{width:36px;height:36px;border-radius:50%;border:2px solid var(--green);}
.admin-info{flex:1;}
.admin-name{font-size:13px;font-weight:600;}
.admin-email{font-size:11px;color:var(--muted2);}

/* ì´ˆê¸° ì„¤ì • í™”ë©´ */
.setup-screen{position:relative;z-index:1;display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:calc(100vh - 52px);padding:40px 24px;text-align:center;}
.setup-card{background:var(--bg2);border:1px solid var(--border);border-radius:14px;padding:28px;max-width:440px;width:100%;}
.setup-card h3{font-size:16px;font-weight:700;margin-bottom:6px;}
.setup-card p{font-size:12px;color:var(--muted2);margin-bottom:20px;line-height:1.7;}
.field{margin-bottom:14px;text-align:left;}
.field label{display:block;font-size:11px;color:var(--muted2);margin-bottom:6px;font-weight:600;}
.field input{width:100%;background:var(--bg3);border:1px solid var(--border);border-radius:7px;padding:9px 12px;color:var(--text);font-size:13px;font-family:'Noto Sans KR',sans-serif;}
.field input:focus{outline:none;border-color:var(--orange);}

/* ë ˆì´ì•„ì›ƒ */
.page{position:relative;z-index:1;display:flex;max-width:1400px;margin:0 auto;padding:20px 24px 60px;gap:0;}
.sidebar{width:260px;min-width:180px;max-width:500px;flex-shrink:0;position:relative;}
.resizer{width:6px;cursor:col-resize;position:absolute;right:-3px;top:0;bottom:0;z-index:20;border-radius:3px;transition:background .15s;}
.resizer:hover,.resizer.active{background:var(--orange);}
.sidebar-inner{position:sticky;top:68px;display:flex;flex-direction:column;gap:10px;}
.sidebar-card{background:var(--bg2);border:1px solid var(--border);border-radius:10px;overflow:hidden;position:relative;}
.tree{padding:8px 0;max-height:calc(50vh - 80px);overflow-y:auto;}
.tree::-webkit-scrollbar{width:3px;}
.tree::-webkit-scrollbar-thumb{background:var(--border);}
.tree-item{display:flex;align-items:center;padding:6px 10px;font-size:12px;color:var(--muted2);cursor:pointer;gap:5px;transition:all .15s;border-left:2px solid transparent;user-select:none;min-width:0;}
.tree-item:hover{color:var(--text);background:rgba(255,255,255,.04);}
.tree-item.active{color:var(--orange);background:rgba(249,115,22,.07);border-left-color:var(--orange);}
.tree-item .ti-icon{font-size:13px;flex-shrink:0;}
.tree-item .ti-name{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.tree-item .ti-toggle{font-size:10px;color:var(--muted);transition:transform .2s;flex-shrink:0;}
.tree-item.open .ti-toggle{transform:rotate(90deg);}
.tree-children{padding-left:14px;border-left:1px solid var(--border);margin-left:20px;}
.tree-children.hidden{display:none;}
.content{flex:1;min-width:0;margin-left:280px;}

/* í´ë” í—¤ë” */
.folder-header{display:flex;align-items:center;gap:12px;margin-bottom:20px;}
.folder-icon{font-size:28px;}
.folder-title{font-size:20px;font-weight:700;}
.folder-path{font-size:12px;color:var(--muted);margin-top:2px;}

/* ì„œë¸Œí´ë” ê·¸ë¦¬ë“œ */
.subfolder-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:10px;margin-bottom:24px;}
.folder-card{background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:16px;cursor:pointer;transition:all .2s;text-align:center;}
.folder-card:hover{border-color:var(--orange);background:var(--bg3);transform:translateY(-2px);}
.folder-card .fc-icon{font-size:26px;margin-bottom:8px;}
.folder-card .fc-name{font-size:12px;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.folder-card .fc-cnt{font-size:10px;color:var(--muted);margin-top:3px;}

/* ì—…ë¡œë“œ íŒ¨ë„ */
.upload-section{margin-top:32px;padding-top:24px;border-top:1px solid var(--border);}
.upload-section-label{font-size:11px;font-weight:700;letter-spacing:.1em;color:var(--muted);text-transform:uppercase;margin-bottom:14px;display:flex;align-items:center;gap:10px;}
.upload-section-label::after{content:'';flex:1;height:1px;background:var(--border);}
.upload-panel{background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:14px 16px;margin:0 auto 20px;max-width:560px;}
.dropzone{border:2px dashed var(--border);border-radius:8px;padding:18px 16px;text-align:center;cursor:pointer;transition:all .2s;position:relative;}
.dropzone:hover,.dropzone.drag{border-color:var(--orange);background:rgba(249,115,22,.04);}
.dropzone input[type=file]{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%;}
.preview-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(80px,1fr));gap:5px;margin:10px 0;}
.preview-item{position:relative;border-radius:5px;overflow:hidden;aspect-ratio:4/3;background:var(--bg3);}
.preview-item img{width:100%;height:100%;object-fit:cover;}
.preview-item .pi-x{position:absolute;top:2px;right:2px;width:15px;height:15px;border-radius:50%;background:rgba(239,68,68,.9);color:#fff;font-size:9px;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;}
.upload-prog{height:5px;background:var(--bg3);border-radius:3px;overflow:hidden;margin:8px 0;}
.upload-prog-bar{height:100%;background:var(--orange);border-radius:3px;transition:width .3s;width:0%;}
.upload-log{font-size:11px;color:var(--muted2);text-align:center;min-height:18px;margin-bottom:8px;}

/* ì„¹ì…˜ ë¼ë²¨ */
.sec-label{font-size:11px;font-weight:700;letter-spacing:.1em;color:var(--muted);text-transform:uppercase;margin-bottom:12px;display:flex;align-items:center;gap:10px;}
.sec-label::after{content:'';flex:1;height:1px;background:var(--border);}

/* ì‚¬ì§„ ê·¸ë¦¬ë“œ */
.photo-toolbar{display:flex;align-items:center;gap:10px;margin-bottom:12px;flex-wrap:wrap;}
.srch{position:relative;}
.srch svg{position:absolute;left:9px;top:50%;transform:translateY(-50%);pointer-events:none;color:var(--muted);}
.srch input{background:var(--bg2);border:1px solid var(--border);border-radius:7px;padding:7px 12px 7px 30px;color:var(--text);font-size:12px;font-family:'Noto Sans KR',sans-serif;width:190px;}
.srch input:focus{outline:none;border-color:var(--orange);}
.srch input::placeholder{color:var(--muted);}
.photo-stat{font-size:12px;color:var(--muted);margin-left:auto;}
.photo-stat b{color:var(--text);}
.photo-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(155px,1fr));gap:7px;}
.photo-card{position:relative;border-radius:8px;overflow:hidden;background:var(--bg3);cursor:pointer;border:1px solid var(--border);aspect-ratio:4/3;transition:transform .2s,border-color .2s,box-shadow .2s;}
.photo-card:hover{transform:translateY(-3px);border-color:var(--orange);box-shadow:0 10px 28px rgba(0,0,0,.5);}
.photo-card img{width:100%;height:100%;object-fit:cover;display:block;}
.photo-card .pc-ov{position:absolute;inset:0;background:linear-gradient(to top,rgba(0,0,0,.75),transparent 55%);opacity:0;transition:opacity .2s;display:flex;align-items:flex-end;padding:7px;}
.photo-card:hover .pc-ov{opacity:1;}
.photo-card .pc-nm{font-size:10px;color:#fff;word-break:break-all;line-height:1.3;}
.photo-card .pc-del-btn{position:absolute;top:5px;right:5px;width:24px;height:24px;border-radius:5px;border:none;background:rgba(239,68,68,.85);color:#fff;font-size:12px;cursor:pointer;opacity:0;transition:opacity .15s;z-index:5;display:flex;align-items:center;justify-content:center;}
.photo-card:hover .pc-del-btn{opacity:1;}
.photo-card .pc-check{position:absolute;top:5px;left:5px;z-index:5;}
.photo-card .pc-check input{width:16px;height:16px;cursor:pointer;accent-color:var(--orange);}

/* ìº˜ë¦°ë” */
.cal-card{background:var(--bg2);border:1px solid var(--border);border-radius:10px;overflow:hidden;}
.cal-head{padding:8px 12px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;}
.cal-head span{font-size:12px;font-weight:700;color:var(--text);}
.cal-nav{background:none;border:none;color:var(--muted2);cursor:pointer;font-size:16px;padding:2px 6px;border-radius:4px;transition:all .15s;}
.cal-nav:hover{color:var(--text);background:var(--bg3);}
.cal-grid{padding:8px;}
.cal-dow{display:grid;grid-template-columns:repeat(7,1fr);margin-bottom:4px;}
.cal-dow span{text-align:center;font-size:9px;font-weight:700;color:var(--muted);padding:2px 0;}
.cal-days{display:grid;grid-template-columns:repeat(7,1fr);gap:2px;}
.cal-day{text-align:center;font-size:11px;padding:4px 2px;border-radius:5px;cursor:default;color:var(--muted2);transition:all .15s;min-height:24px;display:flex;align-items:center;justify-content:center;position:relative;}
.cal-day.has-photos{color:var(--orange);font-weight:700;cursor:pointer;}
.cal-day.has-photos:hover{background:rgba(249,115,22,.15);}
.cal-day.has-photos::after{content:'';position:absolute;bottom:2px;left:50%;transform:translateX(-50%);width:4px;height:4px;border-radius:50%;background:var(--orange);}
.cal-day.today{background:var(--bg3);color:var(--text);}
.cal-day.selected{background:var(--orange);color:#fff;}
.cal-day.selected::after{display:none;}
.cal-day.sun{color:#f87171;}.cal-day.sat{color:#60a5fa;}
.cal-day.has-photos.sun{color:#fca5a5;}.cal-day.has-photos.sat{color:#93c5fd;}

/* ë¹ˆìƒíƒœ / ë¡œë”© */
.empty-box{text-align:center;padding:48px 20px;color:var(--muted);}
.empty-box .eb-icon{font-size:36px;margin-bottom:10px;}
.empty-box p{font-size:13px;line-height:1.8;color:var(--muted2);}
.loading-box{text-align:center;padding:40px;color:var(--muted);font-size:13px;}
.spin{display:inline-block;animation:spin 1s linear infinite;}
@keyframes spin{to{transform:rotate(360deg);}}

/* ëª¨ë‹¬ */
.modal{display:none;position:fixed;inset:0;z-index:999;background:rgba(0,0,0,.93);align-items:center;justify-content:center;padding:20px;}
.modal.open{display:flex;}
.modal-wrap{position:relative;display:flex;flex-direction:column;align-items:center;}
.modal-img{max-width:90vw;max-height:82vh;border-radius:8px;box-shadow:0 24px 80px rgba(0,0,0,.8);display:block;object-fit:contain;}
.modal-x{position:absolute;top:-14px;right:-14px;width:30px;height:30px;border-radius:50%;background:var(--bg3);border:1px solid var(--border);color:var(--text);font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .15s;}
.modal-x:hover{background:#ef4444;border-color:#ef4444;color:#fff;}
.modal-nav{display:flex;gap:10px;margin-top:14px;}
.modal-nav button{padding:7px 18px;border-radius:7px;font-size:13px;font-weight:600;border:1px solid var(--border);background:var(--bg3);color:var(--muted2);cursor:pointer;transition:all .15s;font-family:'Noto Sans KR',sans-serif;}
.modal-nav button:hover{color:var(--text);border-color:var(--muted);}
.modal-info{text-align:center;margin-top:8px;font-size:12px;color:var(--muted);}
.modal-counter{font-size:11px;color:var(--muted);margin-top:3px;}

/* í† ìŠ¤íŠ¸ */
.toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(20px);background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:10px 20px;font-size:13px;color:var(--text);z-index:500;opacity:0;transition:all .3s;pointer-events:none;}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0);}

@media(max-width:768px){.sidebar{display:none;}.page{padding:12px 14px 40px;}.content{margin-left:0;}}
</style>
</head>
<body>

<nav>
  <a class="nav-logo" href="index.html">âš  <span>SAFETY</span></a>
  <a class="nav-back" href="index.html">â† í™ˆ</a>
  <span style="color:var(--border)">|</span>
  <div class="breadcrumb" id="breadcrumb"></div>
  <div class="nav-right">
    <button class="btn sm" onclick="toggleEditMode()" id="editBtn" style="display:none">âœï¸ í¸ì§‘</button>
  </div>
</nav>



<!-- ì´ˆê¸° ì„¤ì • í™”ë©´ (í´ë”ID ì—†ì„ ë•Œ) -->
<div id="setupScreen" style="display:none" class="setup-screen">
  <div class="setup-card">
    <h3>ğŸ“ êµ¬ê¸€ ë“œë¼ì´ë¸Œ ì—°ë™</h3>
    <p>ê°¤ëŸ¬ë¦¬ë¡œ ì‚¬ìš©í•  êµ¬ê¸€ ë“œë¼ì´ë¸Œ í´ë” IDë¥¼ ì…ë ¥í•˜ì„¸ìš”.<br>
    í•œ ë²ˆ ì„¤ì •í•˜ë©´ ì €ì¥ë˜ì–´ ë‹¤ìŒ ì ‘ì†ë¶€í„° ìë™ìœ¼ë¡œ ì—´ë¦½ë‹ˆë‹¤.</p>
    <div class="field">
      <label>ë“œë¼ì´ë¸Œ í´ë” ID</label>
      <input type="text" id="setupFolderInput" placeholder="í´ë” ID (folders/ ë’¤ì˜ ë¬¸ìì—´)">
    </div>
    <div style="font-size:11px;color:var(--muted);margin-bottom:16px;line-height:1.7;">
      ğŸ’¡ êµ¬ê¸€ ë“œë¼ì´ë¸Œ í´ë” ì—´ê¸° â†’ ì£¼ì†Œì°½ URLì—ì„œ<br>
      <code style="color:var(--orange);">folders/</code> ë’¤ì˜ ë¬¸ìì—´ì„ ë³µì‚¬í•´ì„œ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”
    </div>
    <button class="btn primary" style="width:100%;padding:11px;" onclick="setupSave()">ì €ì¥ í›„ ì‹œì‘</button>
  </div>
</div>

<!-- ê°¤ëŸ¬ë¦¬ í™”ë©´ -->
<div id="galleryScreen" style="display:none">
  <div class="page">
    <aside class="sidebar" id="sidebar">
      <div class="resizer" id="resizer"></div>
      <div class="sidebar-inner">
        <div class="sidebar-card">
          <div style="padding:11px 12px 9px;font-size:15px;font-weight:700;letter-spacing:.06em;color:var(--text);text-align:center;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:center;gap:8px;">
            í´ë” êµ¬ì¡°
            <button class="btn sm" onclick="refreshTree()" title="ìƒˆë¡œê³ ì¹¨" style="padding:2px 8px;position:absolute;right:10px;">â†º</button>
          </div>
          <div class="tree" id="treeRoot"></div>
        </div>
        <div class="cal-card" id="calCard">
          <div style="padding:11px 12px 9px;font-size:15px;font-weight:700;letter-spacing:.06em;color:var(--text);text-align:center;border-bottom:1px solid var(--border);">ì¼ìë³„ ì‚¬ì§„</div>
          <div class="cal-head">
            <button class="cal-nav" onclick="calMove(-1)">â€¹</button>
            <span id="calTitle"></span>
            <button class="cal-nav" onclick="calMove(1)">â€º</button>
          </div>
          <div class="cal-grid">
            <div class="cal-dow">
              <span style="color:#f87171">ì¼</span><span>ì›”</span><span>í™”</span><span>ìˆ˜</span><span>ëª©</span><span>ê¸ˆ</span><span style="color:#60a5fa">í† </span>
            </div>
            <div class="cal-days" id="calDays"></div>
          </div>
        </div>
      </div>
    </aside>
    <div class="content" id="content"></div>
  </div>
</div>

<!-- ëª¨ë‹¬ -->
<div class="modal" id="modal" onclick="closeModal(event)">
  <div class="modal-wrap">
    <button class="modal-x" onclick="closeModal(null)">âœ•</button>
    <img class="modal-img" id="mImg" src="" alt="">
    <div class="modal-nav">
      <button onclick="moveModal(-1)">â† ì´ì „</button>
      <button onclick="moveModal(1)">ë‹¤ìŒ â†’</button>
    </div>
    <div class="modal-info" id="mInfo"></div>
    <div class="modal-counter" id="mCounter"></div>
  </div>
</div>

<div class="toast" id="toast"></div>
<script src="auth.js"></script>
<script src="https://accounts.google.com/gsi/client" async></script>
<script>
// â”€â”€ ì„¤ì • â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const CLIENT_ID = '167323077293-8gsd86rn7fjvo7dvo4994fhm6opr19cd.apps.googleusercontent.com';
const API_KEY   = 'AIzaSyAycJXlAGR8ZQKtpqhH1JPML7BmeZzYOJE';
const ADMIN_SCOPE = 'https://www.googleapis.com/auth/drive https://www.googleapis.com/auth/userinfo.profile https://www.googleapis.com/auth/userinfo.email';
const IMG_EXTS  = /\.(jpg|jpeg|png|bmp|gif|tif|tiff|webp)$/i;

// â”€â”€ ìƒíƒœ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ê´€ë¦¬ì ìƒíƒœëŠ” AUTH ëª¨ë“ˆì—ì„œ ê´€ë¦¬
let adminToken   = () => AUTH.getToken();
let isAdmin      = false; // AUTH.isAdmin()ìœ¼ë¡œ ë™ì  ì²´í¬
let rootFolderId = localStorage.getItem('drive_root') || '';
let currentFolderId = '';
let currentFolderName = '';
let folderPath   = [];
let allPhotos    = [];
let curModalIdx  = 0;
let editMode     = false;
let selectedPhotos = new Set();
let treeCache    = {};
let calYear  = new Date().getFullYear();
let calMonth = new Date().getMonth();
let calDateFolders = new Set();
let calDateFolderMap = {};
let calSelected  = null;
let calScanDone  = false;

// â”€â”€ Drive API (ê³µê°œ ì½ê¸° + ê´€ë¦¬ì ì“°ê¸°) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function driveAPI(endpoint, opts = {}) {
  const token = AUTH.isAdmin() ? AUTH.getToken() : null;
  const headers = { ...(opts.headers||{}) };
  if (opts.method !== 'DELETE') headers['Content-Type'] = 'application/json';

  const sep = endpoint.includes('?') ? '&' : '?';
  let url;
  if (token) {
    // ê´€ë¦¬ì: Bearer í† í° ì‚¬ìš©
    headers['Authorization'] = `Bearer ${token}`;
    url = `https://www.googleapis.com/drive/v3/${endpoint}`;
  } else {
    // ë¹„ë¡œê·¸ì¸: API Keyë¡œ ê³µê°œ í´ë” ì½ê¸°
    url = `https://www.googleapis.com/drive/v3/${endpoint}${sep}key=${API_KEY}`;
  }

  const res = await fetch(url, { ...opts, headers });
  if (res.status === 204) return {};
  const data = await res.json();
  if (!res.ok) throw new Error(data.error?.message || `HTTP ${res.status}`);
  return data;
}

async function listFolder(folderId) {
  if (treeCache[folderId]) return treeCache[folderId];
  const q = encodeURIComponent(`'${folderId}' in parents and trashed=false`);
  const fields = 'files(id,name,mimeType,thumbnailLink,webContentLink,size,modifiedTime,shortcutDetails)';
  const data = await driveAPI(`files?q=${q}&fields=${fields}&orderBy=name&pageSize=1000&supportsAllDrives=false`);
  let files = data.files || [];

  // ë°”ë¡œê°€ê¸° ì²˜ë¦¬
  const shortcuts = files.filter(f => f.mimeType === 'application/vnd.google-apps.shortcut');
  if (shortcuts.length > 0) {
    const resolved = await Promise.all(shortcuts.map(async s => {
      try {
        const tid = s.shortcutDetails?.targetId;
        if (!tid) return null;
        const t = await driveAPI(`files/${tid}?fields=id,name,mimeType,thumbnailLink,webContentLink,size,modifiedTime`);
        return { ...t, name: s.name, _shortcut: true };
      } catch { return null; }
    }));
    const sids = new Set(shortcuts.map(s => s.id));
    files = files.filter(f => !sids.has(f.id));
    resolved.filter(Boolean).forEach(f => files.push(f));
  }
  treeCache[folderId] = files;
  return files;
}

// â”€â”€ ê´€ë¦¬ì ë¡œê·¸ì¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€





function setupSave() {
  const val = document.getElementById('setupFolderInput').value.trim();
  if (!val) { showToast('í´ë” IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }
  const match = val.match(/[-\w]{25,}/);
  rootFolderId = match ? match[0] : val;
  localStorage.setItem('drive_root', rootFolderId);
  startGallery();
}

function startGallery() {
  document.getElementById('setupScreen').style.display = 'none';
  document.getElementById('galleryScreen').style.display = 'block';
  const savedName = localStorage.getItem('drive_root_name') || 'ì„ë¬¸í˜¸ ìˆ˜ìƒíƒœì–‘ê´‘ë°œì „ì†Œ EPCê³µì‚¬';
  folderPath = [];
  navigateToFolder(rootFolderId, savedName);
  setTimeout(() => renderCal(), 2000);
}

// â”€â”€ ë„¤ë¹„ê²Œì´ì…˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function navigateToFolder(folderId, name) {
  currentFolderId = folderId;
  currentFolderName = name;
  selectedPhotos.clear();
  const existing = folderPath.findIndex(f => f.id === folderId);
  if (existing >= 0) folderPath = folderPath.slice(0, existing + 1);
  else if (folderId !== rootFolderId) folderPath.push({ id: folderId, name });
  else folderPath = [{ id: folderId, name }];
  renderBreadcrumb();
  await renderContent();
}

function renderBreadcrumb() {
  const bc = document.getElementById('breadcrumb'); bc.innerHTML = '';
  folderPath.forEach((f, i) => {
    if (i > 0) { const s = document.createElement('span'); s.className='bc-sep'; s.textContent='â€º'; bc.appendChild(s); }
    const item = document.createElement('span');
    item.className = 'bc-item' + (i===folderPath.length-1?' active':'');
    item.textContent = f.name;
    item.onclick = () => navigateToFolder(f.id, f.name);
    bc.appendChild(item);
  });
}

// â”€â”€ íŠ¸ë¦¬ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function refreshTree() {
  treeCache = {}; calScanDone = false;
  Object.keys(calDateFolderMap).forEach(k => delete calDateFolderMap[k]);
  calDateFolders = new Set();
  renderTreeRoot(); renderCal();
}
async function renderTreeRoot() {
  const root = document.getElementById('treeRoot');
  root.innerHTML = '<div style="padding:10px 14px;font-size:11px;color:var(--muted);display:flex;align-items:center;gap:6px;"><span class="spin">â³</span> ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
  try {
    const files = await listFolder(rootFolderId);
    root.innerHTML = '';
    const folders = files.filter(f => f.mimeType === 'application/vnd.google-apps.folder');
    const savedName = localStorage.getItem('drive_root_name') || 'ì„ë¬¸í˜¸ ìˆ˜ìƒíƒœì–‘ê´‘ë°œì „ì†Œ EPCê³µì‚¬';
    const rootItem = makeTreeItem('ğŸ“', savedName, rootFolderId, 0, folders.length > 0, true);
    root.appendChild(rootItem);
    if (currentFolderId === rootFolderId || folderPath.some(f => f.id === rootFolderId)) {
      const ch = document.createElement('div'); ch.className = 'tree-children';
      folders.forEach(f => ch.appendChild(makeTreeItem('ğŸ“‚', f.name, f.id, 1, false, false)));
      root.appendChild(ch);
    }
  } catch(e) {
    root.innerHTML = `<div style="padding:10px 14px;font-size:11px;color:var(--red);">ì˜¤ë¥˜: ${e.message}</div>`;
  }
}
function makeTreeItem(icon, name, folderId, depth, hasChildren, isRoot) {
  const item = document.createElement('div');
  item.className = 'tree-item' + (currentFolderId === folderId ? ' active' : '');
  item.style.paddingLeft = (14 + depth * 12) + 'px';
  item.innerHTML = `<span class="ti-toggle">${hasChildren?'â–¶':' '}</span><span class="ti-icon">${icon}</span><span class="ti-name">${name}</span>${isRoot?'<span style="margin-left:4px;font-size:10px;color:var(--muted);cursor:pointer;flex-shrink:0;" onclick="event.stopPropagation();editRootName()" title="ì´ë¦„ ë³€ê²½">âœï¸</span>':''}`;
  item.onclick = () => navigateToFolder(folderId, name);
  return item;
}
function editRootName() {
  const cur = localStorage.getItem('drive_root_name') || 'ì„ë¬¸í˜¸ ìˆ˜ìƒíƒœì–‘ê´‘ë°œì „ì†Œ EPCê³µì‚¬';
  const n = prompt('í´ë” í‘œì‹œ ì´ë¦„:', cur);
  if (!n || !n.trim()) return;
  localStorage.setItem('drive_root_name', n.trim());
  if (folderPath.length > 0 && folderPath[0].id === rootFolderId) folderPath[0].name = n.trim();
  renderBreadcrumb(); renderTreeRoot(); showToast('âœ… ì´ë¦„ ë³€ê²½ë¨');
}

// â”€â”€ ì½˜í…ì¸  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function renderContent() {
  const content = document.getElementById('content');
  content.innerHTML = '<div class="loading-box"><span class="spin">â³</span> ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
  renderTreeRoot();
  try {
    const files = await listFolder(currentFolderId);
    content.innerHTML = '';
    const folders = files.filter(f => f.mimeType === 'application/vnd.google-apps.folder');
    const photos  = files.filter(f => f.mimeType !== 'application/vnd.google-apps.folder' && (f.mimeType?.startsWith('image/') || IMG_EXTS.test(f.name)));
    allPhotos = photos;

    // í—¤ë”
    const hdr = document.createElement('div'); hdr.className = 'folder-header';
    hdr.innerHTML = `<span class="folder-icon">ğŸ“‚</span>
      <div><div class="folder-title">${currentFolderName}</div>
      <div class="folder-path">í´ë” ${folders.length}ê°œ Â· ì‚¬ì§„ ${photos.length}ì¥</div></div>`;
    content.appendChild(hdr);

    // í•˜ìœ„ í´ë”
    if (folders.length > 0) {
      const lbl = document.createElement('div'); lbl.className='sec-label'; lbl.textContent='í•˜ìœ„ í´ë”';
      content.appendChild(lbl);
      const grid = document.createElement('div'); grid.className='subfolder-grid';
      folders.forEach(f => {
        const card = document.createElement('div'); card.className='folder-card';
        card.innerHTML = `<div class="fc-icon">ğŸ“</div><div class="fc-name">${f.name}</div><div class="fc-cnt">í´ë”</div>`;
        card.onclick = () => navigateToFolder(f.id, f.name);
        grid.appendChild(card);
      });
      content.appendChild(grid);
    }

    // ì‚¬ì§„
    if (photos.length > 0) {
      const lbl = document.createElement('div'); lbl.className='sec-label'; lbl.id='photoSecLabel';
      lbl.textContent = `ì‚¬ì§„ (${photos.length}ì¥)`;
      content.appendChild(lbl);
      const toolbar = document.createElement('div'); toolbar.className='photo-toolbar';
      toolbar.innerHTML = `
        <div class="srch"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
          <input type="text" placeholder="íŒŒì¼ëª… ê²€ìƒ‰" oninput="filterPhotos(this.value)"></div>
        ${editMode&&AUTH.isAdmin()?`<button class="btn sm" onclick="selectAll(true)">ì „ì²´ì„ íƒ</button>
          <button class="btn sm" onclick="selectAll(false)">ì„ íƒí•´ì œ</button>
          <button class="btn sm danger" id="bulkDelBtn" style="display:none" onclick="deleteSelected()">ğŸ—‘ ì„ íƒì‚­ì œ</button>`:''}
        <div class="photo-stat" id="photoStat"><b>${photos.length}</b>ì¥</div>`;
      content.appendChild(toolbar);
      const grid = document.createElement('div'); grid.className='photo-grid'; grid.id='photoGrid';
      photos.forEach((p, i) => {
        const card = document.createElement('div'); card.className='photo-card';
        card.dataset.name = p.name; card.dataset.id = p.id;
        const src = p.thumbnailLink ? p.thumbnailLink.replace('=s220','=s400') : `https://lh3.googleusercontent.com/d/${p.id}=s400`;
        card.innerHTML = `<img src="${src}" alt="${p.name}" loading="lazy">
          <div class="pc-ov"><div class="pc-nm">${p.name}</div></div>
          ${editMode&&AUTH.isAdmin()?`<button class="pc-del-btn" onclick="event.stopPropagation();deletePhoto('${p.id}','${p.name}',this.closest('.photo-card'))">ğŸ—‘</button>
            <label class="pc-check" onclick="event.stopPropagation()"><input type="checkbox" onchange="toggleSelect(this,'${p.id}')"></label>`:''}`;
        if (!editMode) card.onclick = () => { curModalIdx=i; openModalPhoto(p); };
        grid.appendChild(card);
      });
      content.appendChild(grid);
    } else if (folders.length === 0) {
      const box = document.createElement('div'); box.className='empty-box';
      box.innerHTML = '<div class="eb-icon">ğŸ–¼ï¸</div><p>ì´ í´ë”ì— ì‚¬ì§„ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
      content.appendChild(box);
    }

    // ì—…ë¡œë“œ (ê´€ë¦¬ìë§Œ)
    if (AUTH.isAdmin()) {
      const sec = document.createElement('div'); sec.className='upload-section';
      const lbl = document.createElement('div'); lbl.className='upload-section-label'; lbl.textContent='ì‚¬ì§„ ì—…ë¡œë“œ';
      sec.appendChild(lbl); content.appendChild(sec);
      renderUploadPanel(sec);
    }
  } catch(e) {
    content.innerHTML = `<div class="empty-box"><div class="eb-icon">âš ï¸</div><p>ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ${e.message}</p></div>`;
  }
}

// â”€â”€ ì—…ë¡œë“œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderUploadPanel(container) {
  let uploadFiles = [], isUploading = false;
  const panel = document.createElement('div'); panel.className='upload-panel';
  panel.innerHTML = `
    <div class="dropzone" id="upDZ"><input type="file" id="upFI" accept="image/*" multiple>
      <div style="font-size:24px;margin-bottom:6px">ğŸ“¸</div>
      <div style="font-size:13px;font-weight:600;color:var(--muted2)">ì‚¬ì§„ì„ ëŒì–´ë‹¤ ë†“ê±°ë‚˜ í´ë¦­</div>
      <div style="font-size:11px;color:var(--muted);margin-top:3px">JPG, PNG, BMP, GIF Â· ì—¬ëŸ¬ ì¥ ë™ì‹œ ê°€ëŠ¥</div>
    </div>
    <div class="preview-grid" id="upPG" style="display:none"></div>
    <div class="upload-prog" id="upProg" style="display:none"><div class="upload-prog-bar" id="upPB"></div></div>
    <div class="upload-log" id="upLog"></div>
    <div style="display:flex;gap:8px;align-items:center;">
      <button class="btn primary" id="upBtn" onclick="doUpload()" disabled>ğŸ“¤ ì—…ë¡œë“œ</button>
      <button class="btn sm" id="upClr" onclick="clearUp()" style="display:none">ì´ˆê¸°í™”</button>
      <span id="upCnt" style="font-size:12px;color:var(--muted)"></span>
    </div>`;
  container.appendChild(panel);
  const dz=panel.querySelector('#upDZ'), fi=panel.querySelector('#upFI');
  dz.addEventListener('dragover',e=>{e.preventDefault();dz.classList.add('drag');});
  dz.addEventListener('dragleave',()=>dz.classList.remove('drag'));
  dz.addEventListener('drop',e=>{e.preventDefault();dz.classList.remove('drag');addFiles(e.dataTransfer.files);});
  fi.addEventListener('change',()=>addFiles(fi.files));
  function addFiles(list){
    const exts=['jpg','jpeg','png','bmp','gif','tif','tiff','webp'];
    [...list].filter(f=>exts.includes(f.name.split('.').pop().toLowerCase()))
      .forEach(f=>{if(!uploadFiles.find(x=>x.name===f.name&&x.size===f.size))uploadFiles.push(f);});
    renderPrev(); panel.querySelector('#upBtn').disabled=!uploadFiles.length;
  }
  function renderPrev(){
    const pg=panel.querySelector('#upPG'); pg.style.display=uploadFiles.length?'grid':'none'; pg.innerHTML='';
    uploadFiles.forEach((f,i)=>{const url=URL.createObjectURL(f);const el=document.createElement('div');el.className='preview-item';el.innerHTML=`<img src="${url}"><button class="pi-x" onclick="rmFile(${i})">âœ•</button>`;pg.appendChild(el);});
    panel.querySelector('#upClr').style.display=uploadFiles.length?'':'none';
    panel.querySelector('#upCnt').textContent=uploadFiles.length?uploadFiles.length+'ì¥ ì„ íƒë¨':'';
  }
  window.rmFile=i=>{uploadFiles.splice(i,1);renderPrev();if(!uploadFiles.length)panel.querySelector('#upBtn').disabled=true;};
  window.clearUp=()=>{uploadFiles=[];renderPrev();panel.querySelector('#upBtn').disabled=true;panel.querySelector('#upLog').textContent='';panel.querySelector('#upProg').style.display='none';};
  window.doUpload=async()=>{
    if(isUploading||!uploadFiles.length)return;
    if(!AUTH.isAdmin()){showToast('ê´€ë¦¬ì ë¡œê·¸ì¸ í›„ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤');return;}
    isUploading=true;
    const btn=panel.querySelector('#upBtn');btn.disabled=true;btn.textContent='â³ ì—…ë¡œë“œ ì¤‘...';
    panel.querySelector('#upProg').style.display='block';
    const log=panel.querySelector('#upLog'),pb=panel.querySelector('#upPB');
    let ok=0,fail=0,total=uploadFiles.length;
    for(let i=0;i<total;i++){
      const f=uploadFiles[i];pb.style.width=Math.round((i/total)*100)+'%';log.textContent=`(${i+1}/${total}) ${f.name}`;
      try{
        const meta=JSON.stringify({name:f.name,parents:[currentFolderId]});
        const form=new FormData();form.append('metadata',new Blob([meta],{type:'application/json'}));form.append('file',f);
        const res=await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart',{method:'POST',headers:{Authorization:`Bearer ${AUTH.getToken()}`},body:form});
        if(!res.ok)throw new Error('ì‹¤íŒ¨');ok++;
      }catch{fail++;}
    }
    pb.style.width='100%';log.textContent=`âœ… ${ok}ì¥ ì™„ë£Œ${fail?` / âŒ ${fail}ì¥ ì‹¤íŒ¨`:''}`;
    isUploading=false;btn.disabled=false;btn.textContent='ğŸ“¤ ì—…ë¡œë“œ';
    if(ok>0){showToast(`âœ… ${ok}ì¥ ì—…ë¡œë“œ ì™„ë£Œ!`);uploadFiles=[];renderPrev();treeCache[currentFolderId]=null;setTimeout(()=>renderContent(),1000);}
  };
}

// â”€â”€ ì‚­ì œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function deletePhoto(fileId, name, card) {
  if (!AUTH.isAdmin()){showToast('ê´€ë¦¬ì ë¡œê·¸ì¸ í•„ìš”');return;}
  if (!confirm(`"${name}" ì‚­ì œí• ê¹Œìš”?`)) return;
  try {
    await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}`,{method:'DELETE',headers:{Authorization:`Bearer ${AUTH.getToken()}`}});
    card.remove(); allPhotos=allPhotos.filter(p=>p.id!==fileId); updatePhotoCount(); treeCache[currentFolderId]=null; showToast('âœ… ì‚­ì œ: '+name);
  } catch(e){showToast('âŒ ì‹¤íŒ¨: '+e.message);}
}
async function deleteSelected(){
  if(!AUTH.isAdmin()){showToast('ê´€ë¦¬ì ë¡œê·¸ì¸ í•„ìš”');return;}
  if(!selectedPhotos.size)return;
  if(!confirm(`ì„ íƒí•œ ${selectedPhotos.size}ì¥ ì‚­ì œ?`))return;
  let ok=0,fail=0;
  for(const id of selectedPhotos){
    try{await fetch(`https://www.googleapis.com/drive/v3/files/${id}`,{method:'DELETE',headers:{Authorization:`Bearer ${AUTH.getToken()}`}});ok++;}catch{fail++;}
    document.querySelectorAll(`[data-id="${id}"]`).forEach(el=>el.remove());
  }
  allPhotos=allPhotos.filter(p=>!selectedPhotos.has(p.id));selectedPhotos.clear();treeCache[currentFolderId]=null;updatePhotoCount();
  showToast(`âœ… ${ok}ì¥ ì‚­ì œ${fail?` / âŒ ${fail}ì¥ ì‹¤íŒ¨`:''}`);
}
function toggleSelect(cb,id){if(cb.checked)selectedPhotos.add(id);else selectedPhotos.delete(id);const btn=document.getElementById('bulkDelBtn');if(btn)btn.style.display=selectedPhotos.size>0?'':'none';}
function selectAll(all){document.querySelectorAll('#photoGrid .photo-card').forEach(card=>{const cb=card.querySelector('input[type=checkbox]');if(all){selectedPhotos.add(card.dataset.id);if(cb)cb.checked=true;}else{selectedPhotos.delete(card.dataset.id);if(cb)cb.checked=false;}});const btn=document.getElementById('bulkDelBtn');if(btn)btn.style.display=selectedPhotos.size>0?'':'none';}
function updatePhotoCount(){const cnt=document.querySelectorAll('#photoGrid .photo-card').length;const s=document.getElementById('photoStat');const l=document.getElementById('photoSecLabel');if(s)s.innerHTML=`<b>${cnt}</b>ì¥`;if(l)l.textContent=`ì‚¬ì§„ (${cnt}ì¥)`;}
function filterPhotos(val){document.querySelectorAll('#photoGrid .photo-card').forEach(c=>{c.style.display=(!val||c.dataset.name.toLowerCase().includes(val.toLowerCase()))?'':'none';});}
function toggleEditMode(){editMode=!editMode;const btn=document.getElementById('editBtn');btn.textContent=editMode?'âœ… ì™„ë£Œ':'âœï¸ í¸ì§‘';btn.className=editMode?'btn sm primary':'btn sm';selectedPhotos.clear();renderContent();}

// â”€â”€ ëª¨ë‹¬ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openModalPhoto(p){
  const src=p.thumbnailLink?p.thumbnailLink.replace('=s220','=s1600'):`https://lh3.googleusercontent.com/d/${p.id}=s1600`;
  document.getElementById('mImg').src=src;document.getElementById('mInfo').textContent=p.name;
  document.getElementById('mCounter').textContent=(curModalIdx+1)+' / '+allPhotos.length;
  document.getElementById('modal').classList.add('open');
}
function updateModal(){const p=allPhotos[curModalIdx];const src=p.thumbnailLink?p.thumbnailLink.replace('=s220','=s1600'):`https://lh3.googleusercontent.com/d/${p.id}=s1600`;document.getElementById('mImg').src=src;document.getElementById('mInfo').textContent=p.name;document.getElementById('mCounter').textContent=(curModalIdx+1)+' / '+allPhotos.length;}
function moveModal(dir){curModalIdx=(curModalIdx+dir+allPhotos.length)%allPhotos.length;updateModal();}
function closeModal(e){if(e===null||e.target===document.getElementById('modal'))document.getElementById('modal').classList.remove('open');}
document.addEventListener('keydown',e=>{if(!document.getElementById('modal').classList.contains('open'))return;if(e.key==='Escape')closeModal(null);if(e.key==='ArrowLeft')moveModal(-1);if(e.key==='ArrowRight')moveModal(1);});

// â”€â”€ ìº˜ë¦°ë” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function calMove(dir){calMonth+=dir;if(calMonth>11){calMonth=0;calYear++;}if(calMonth<0){calMonth=11;calYear--;}renderCal();}
function drawCalDays(){
  const days=document.getElementById('calDays');if(!days)return;days.innerHTML='';
  const firstDay=new Date(calYear,calMonth,1).getDay();
  const lastDate=new Date(calYear,calMonth+1,0).getDate();
  const today=new Date();
  for(let i=0;i<firstDay;i++){const el=document.createElement('div');el.className='cal-day';days.appendChild(el);}
  for(let d=1;d<=lastDate;d++){
    const ds=`${calYear}-${String(calMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const dow=new Date(calYear,calMonth,d).getDay();
    const el=document.createElement('div');
    let cls='cal-day';
    if(dow===0)cls+=' sun';if(dow===6)cls+=' sat';
    if(today.getFullYear()===calYear&&today.getMonth()===calMonth&&today.getDate()===d)cls+=' today';
    if(calDateFolders.has(ds))cls+=' has-photos';
    if(calSelected===ds)cls+=' selected';
    el.className=cls;el.textContent=d;
    if(calDateFolders.has(ds)){el.title=ds+' ì‚¬ì§„ ë³´ê¸°';el.onclick=()=>calGoDate(ds);}
    days.appendChild(el);
  }
}
async function renderCal(){
  const t=document.getElementById('calTitle');if(!t)return;
  t.textContent=`${calYear}ë…„ ${calMonth+1}ì›”`;
  drawCalDays();
  await collectDateFolders();
  drawCalDays();
}
async function collectDateFolders(){
  if(calScanDone)return;
  try{const rf=await listFolder(rootFolderId);const subs=rf.filter(f=>f.mimeType==='application/vnd.google-apps.folder');await Promise.all(subs.map(f=>scanForDateFolders(f.id,1)));}catch{}
  calScanDone=true;
}
async function scanForDateFolders(folderId,depth=0){
  if(depth>10)return;
  try{
    const files=await listFolder(folderId);const subs=[];
    for(const f of files){
      if(f.mimeType!=='application/vnd.google-apps.folder')continue;
      if(/^\d{4}-\d{2}-\d{2}$/.test(f.name)){
        calDateFolders.add(f.name);
        if(!calDateFolderMap[f.name])calDateFolderMap[f.name]=[];
        if(!calDateFolderMap[f.name].includes(f.id))calDateFolderMap[f.name].push(f.id);
      }else{subs.push(f);}
    }
    await Promise.all(subs.map(f=>scanForDateFolders(f.id,depth+1)));
  }catch{}
}
async function calGoDate(dateStr){
  calSelected=dateStr;drawCalDays();
  const ids=calDateFolderMap[dateStr];
  if(!ids||!ids.length){showToast('í´ë”ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');return;}
  if(ids.length===1){folderPath=[];await navigateToFolder(ids[0],dateStr);}
  else{
    folderPath=[{id:'__date__',name:dateStr}];currentFolderId='__date__';currentFolderName=dateStr;
    renderBreadcrumb();await renderDateMerged(dateStr,ids);
  }
}
async function renderDateMerged(dateStr,folderIds){
  const content=document.getElementById('content');
  content.innerHTML='<div class="loading-box"><span class="spin">â³</span> ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
  try{
    const results=await Promise.all(folderIds.map(id=>listFolder(id)));
    const photos=results.flat().filter(f=>f.mimeType!=='application/vnd.google-apps.folder'&&(f.mimeType?.startsWith('image/')||IMG_EXTS.test(f.name)));
    allPhotos=photos;selectedPhotos.clear();content.innerHTML='';
    const hdr=document.createElement('div');hdr.className='folder-header';
    hdr.innerHTML=`<span class="folder-icon">ğŸ“…</span><div><div class="folder-title">${dateStr}</div><div class="folder-path">${folderIds.length}ê°œ í´ë” Â· ì‚¬ì§„ ${photos.length}ì¥</div></div>`;
    content.appendChild(hdr);
    if(!photos.length){const box=document.createElement('div');box.className='empty-box';box.innerHTML='<div class="eb-icon">ğŸ–¼ï¸</div><p>ì´ ë‚ ì§œì— ì‚¬ì§„ì´ ì—†ìŠµë‹ˆë‹¤.</p>';content.appendChild(box);return;}
    const lbl=document.createElement('div');lbl.className='sec-label';lbl.id='photoSecLabel';lbl.textContent=`ì‚¬ì§„ (${photos.length}ì¥)`;content.appendChild(lbl);
    const toolbar=document.createElement('div');toolbar.className='photo-toolbar';
    toolbar.innerHTML=`<div class="srch"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg><input type="text" placeholder="íŒŒì¼ëª… ê²€ìƒ‰" oninput="filterPhotos(this.value)"></div><div class="photo-stat" id="photoStat"><b>${photos.length}</b>ì¥</div>`;
    content.appendChild(toolbar);
    const grid=document.createElement('div');grid.className='photo-grid';grid.id='photoGrid';
    photos.forEach((p,i)=>{
      const card=document.createElement('div');card.className='photo-card';card.dataset.name=p.name;card.dataset.id=p.id;
      const src=p.thumbnailLink?p.thumbnailLink.replace('=s220','=s400'):`https://lh3.googleusercontent.com/d/${p.id}=s400`;
      card.innerHTML=`<img src="${src}" alt="${p.name}" loading="lazy"><div class="pc-ov"><div class="pc-nm">${p.name}</div></div>`;
      card.onclick=()=>{curModalIdx=i;openModalPhoto(p);};
      grid.appendChild(card);
    });
    content.appendChild(grid);
  }catch(e){content.innerHTML=`<div class="empty-box"><div class="eb-icon">âš ï¸</div><p>ì‹¤íŒ¨: ${e.message}</p></div>`;}
}

// â”€â”€ ì‚¬ì´ë“œë°” ë¦¬ì‚¬ì´ì¦ˆ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(function(){
  const sidebar=document.getElementById('sidebar'),resizer=document.getElementById('resizer'),content=document.getElementById('content');
  let isDown=false,startX=0,startW=0;
  const saved=localStorage.getItem('sidebarWidth');if(saved)sidebar.style.width=saved+'px';
  updateM();
  resizer.addEventListener('mousedown',e=>{isDown=true;startX=e.clientX;startW=sidebar.offsetWidth;resizer.classList.add('active');document.body.style.cursor='col-resize';document.body.style.userSelect='none';e.preventDefault();});
  document.addEventListener('mousemove',e=>{if(!isDown)return;const w=Math.min(500,Math.max(180,startW+(e.clientX-startX)));sidebar.style.width=w+'px';updateM();});
  document.addEventListener('mouseup',()=>{if(!isDown)return;isDown=false;resizer.classList.remove('active');document.body.style.cursor='';document.body.style.userSelect='';localStorage.setItem('sidebarWidth',sidebar.offsetWidth);});
  function updateM(){content.style.marginLeft=(sidebar.offsetWidth+20)+'px';}
})();

// â”€â”€ í† ìŠ¤íŠ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showToast(msg){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2500);}

// â”€â”€ ì‹œì‘ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(function init(){
  if (typeof AUTH === 'undefined') { console.error('auth.js ë¡œë“œ ì‹¤íŒ¨'); return; }
  // ê´€ë¦¬ì í† í° ë³µì›
  if (false) {
    const p = JSON.parse(localStorage.getItem('admin_profile')||'{}');
    if (p.picture) document.getElementById('adminAvatar').src = p.picture;
    if (p.name)    document.getElementById('adminName').textContent = p.name;
    if (p.email)   document.getElementById('adminEmail').textContent = p.email;
  }
  AUTH.updateUI();

  // í´ë” ID ìˆìœ¼ë©´ ë°”ë¡œ ê°¤ëŸ¬ë¦¬, ì—†ìœ¼ë©´ ì„¤ì • í™”ë©´
  if (rootFolderId) {
    startGallery();
  } else {
    document.getElementById('setupScreen').style.display = 'flex';
  }
})();
</script>
</body>
</html>
