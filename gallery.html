<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>í˜„ì¥ì‚¬ì§„ ê°¤ëŸ¬ë¦¬ Â· Safety Portal</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&family=Bebas+Neue&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0f1117;--bg2:#171b24;--bg3:#1e2330;--bg4:#252a38;
  --border:#2c3347;--orange:#f97316;--blue:#3b82f6;
  --green:#22c55e;--red:#ef4444;--yellow:#eab308;
  --text:#f1f5f9;--muted:#64748b;--muted2:#94a3b8;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
html{scroll-behavior:smooth;}
body{font-family:'Noto Sans KR',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;}
body::before{content:'';position:fixed;inset:0;z-index:0;
  background-image:linear-gradient(rgba(249,115,22,.025) 1px,transparent 1px),
  linear-gradient(90deg,rgba(249,115,22,.025) 1px,transparent 1px);
  background-size:40px 40px;pointer-events:none;}
nav{position:sticky;top:0;z-index:100;background:rgba(15,17,23,.95);
  backdrop-filter:blur(16px);border-bottom:1px solid var(--border);
  padding:0 24px;display:flex;align-items:center;height:52px;gap:16px;}
.nav-logo{font-family:'Bebas Neue',sans-serif;font-size:20px;letter-spacing:.1em;color:var(--orange);text-decoration:none;}
.nav-logo span{color:var(--text);}
.nav-back{font-size:12px;color:var(--muted2);text-decoration:none;display:flex;align-items:center;gap:4px;padding:5px 10px;border-radius:6px;transition:all .15s;}
.nav-back:hover{color:var(--text);background:var(--bg3);}
.breadcrumb{display:flex;align-items:center;gap:6px;font-size:13px;overflow:hidden;flex-wrap:wrap;}
.bc-item{color:var(--muted2);cursor:pointer;white-space:nowrap;padding:3px 6px;border-radius:5px;transition:all .15s;}
.bc-item:hover{color:var(--text);background:var(--bg3);}
.bc-item.active{color:var(--text);font-weight:600;}
.bc-sep{color:var(--muted);font-size:11px;}
.nav-right{margin-left:auto;display:flex;align-items:center;gap:8px;}
.btn{padding:6px 14px;border-radius:7px;font-size:12px;font-weight:600;cursor:pointer;
  border:1px solid var(--border);background:var(--bg3);color:var(--muted2);
  transition:all .15s;font-family:'Noto Sans KR',sans-serif;white-space:nowrap;}
.btn:hover{color:var(--text);border-color:var(--muted);}
.btn.primary{background:var(--orange);border-color:var(--orange);color:#fff;}
.btn.primary:hover{background:#ea6c0a;}
.btn.danger{border-color:var(--red);color:var(--red);}
.btn.danger:hover{background:var(--red);color:#fff;}
.btn.sm{padding:4px 10px;font-size:11px;}
.page{position:relative;z-index:1;display:flex;max-width:1400px;margin:0 auto;padding:20px 24px 60px;gap:0;}
.sidebar{width:260px;min-width:180px;max-width:500px;margin-right:0;flex-shrink:0;position:relative;}
.resizer{width:6px;cursor:col-resize;position:absolute;right:-3px;top:0;bottom:0;z-index:20;border-radius:3px;transition:background .15s;}
.resizer:hover,.resizer.active{background:var(--orange);}
.sidebar-card{background:var(--bg2);border:1px solid var(--border);border-radius:10px;overflow:hidden;position:sticky;top:68px;}
.sidebar-head{padding:12px 14px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;}
.sidebar-head span{font-size:11px;font-weight:700;letter-spacing:.08em;color:var(--muted);text-transform:uppercase;}
.tree{padding:8px 0;max-height:calc(100vh - 140px);overflow-y:auto;}
.tree::-webkit-scrollbar{width:3px;}
.tree::-webkit-scrollbar-thumb{background:var(--border);}
.tree-item{display:flex;align-items:center;padding:6px 10px;font-size:12px;color:var(--muted2);cursor:pointer;gap:5px;transition:all .15s;border-left:2px solid transparent;user-select:none;min-width:0;}
.tree-item:hover{color:var(--text);background:rgba(255,255,255,.04);}
.tree-item.active{color:var(--orange);background:rgba(249,115,22,.07);border-left-color:var(--orange);}
.tree-item .ti-icon{font-size:13px;flex-shrink:0;}
.tree-item .ti-name{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-size:12px;}
.tree-item .ti-cnt{font-size:10px;color:var(--muted);background:var(--bg3);padding:1px 5px;border-radius:8px;flex-shrink:0;}
.tree-item .ti-toggle{font-size:10px;color:var(--muted);transition:transform .2s;flex-shrink:0;}
.tree-item.open .ti-toggle{transform:rotate(90deg);}
.tree-children{padding-left:14px;border-left:1px solid var(--border);margin-left:20px;}
.tree-children.hidden{display:none;}
.content{flex:1;min-width:0;position:relative;margin-left:280px;}
.folder-header{display:flex;align-items:center;gap:12px;margin-bottom:20px;}
.folder-icon{font-size:28px;}
.folder-title{font-size:20px;font-weight:700;}
.folder-desc{font-size:13px;color:var(--muted2);margin-top:2px;}
.folder-actions{margin-left:auto;display:flex;gap:8px;}
.subfolder-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:10px;margin-bottom:28px;}
.folder-card{background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:16px;cursor:pointer;transition:all .2s;text-align:center;position:relative;}
.folder-card:hover{border-color:var(--orange);background:var(--bg3);transform:translateY(-2px);}
.folder-card .fc-icon{font-size:28px;margin-bottom:8px;}
.folder-card .fc-name{font-size:12px;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.folder-card .fc-cnt{font-size:11px;color:var(--muted);margin-top:3px;}
.folder-card .fc-actions{position:absolute;top:6px;right:6px;display:none;gap:3px;}
.folder-card:hover .fc-actions{display:flex;}
.icon-btn{width:22px;height:22px;border-radius:4px;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:11px;background:var(--bg4);color:var(--muted2);transition:all .15s;}
.icon-btn:hover.edit{background:var(--blue);color:#fff;}
.icon-btn:hover.del{background:var(--red);color:#fff;}
.add-folder-card{background:transparent;border:1px dashed var(--border);border-radius:10px;padding:16px;cursor:pointer;transition:all .2s;text-align:center;color:var(--muted);}
.add-folder-card:hover{border-color:var(--orange);color:var(--orange);background:rgba(249,115,22,.04);}
.sec-label{font-size:11px;font-weight:700;letter-spacing:.1em;color:var(--muted);text-transform:uppercase;margin-bottom:12px;display:flex;align-items:center;gap:10px;}
.sec-label::after{content:'';flex:1;height:1px;background:var(--border);}
.photo-toolbar{display:flex;align-items:center;gap:10px;margin-bottom:14px;flex-wrap:wrap;}
.srch{position:relative;}
.srch svg{position:absolute;left:9px;top:50%;transform:translateY(-50%);pointer-events:none;color:var(--muted);}
.srch input{background:var(--bg2);border:1px solid var(--border);border-radius:7px;padding:7px 12px 7px 30px;color:var(--text);font-size:12px;font-family:'Noto Sans KR',sans-serif;width:200px;}
.srch input:focus{outline:none;border-color:var(--orange);}
.srch input::placeholder{color:var(--muted);}
.photo-stat{font-size:12px;color:var(--muted);margin-left:auto;}
.photo-stat b{color:var(--text);}
.photo-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(155px,1fr));gap:7px;}
.photo-card{position:relative;border-radius:8px;overflow:hidden;background:var(--bg3);cursor:pointer;border:1px solid var(--border);aspect-ratio:4/3;transition:transform .2s,border-color .2s,box-shadow .2s;}
.photo-card:hover{transform:translateY(-3px);border-color:var(--orange);box-shadow:0 10px 28px rgba(0,0,0,.5);}
.photo-card img{width:100%;height:100%;object-fit:cover;display:block;}
.photo-card .pc-ov{position:absolute;inset:0;background:linear-gradient(to top,rgba(0,0,0,.75),transparent 55%);opacity:0;transition:opacity .2s;display:flex;align-items:flex-end;padding:7px;}
.photo-card:hover .pc-ov{opacity:1;}
.photo-card .pc-nm{font-size:10px;color:#fff;word-break:break-all;line-height:1.3;}
.photo-card .pc-date{position:absolute;top:6px;left:6px;font-size:9px;background:rgba(0,0,0,.6);color:rgba(255,255,255,.8);padding:2px 6px;border-radius:4px;}
.photo-card .pc-del-btn{position:absolute;top:5px;right:5px;width:24px;height:24px;border-radius:5px;border:none;background:rgba(239,68,68,.85);color:#fff;font-size:12px;cursor:pointer;display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity .15s;z-index:5;}
.photo-card:hover .pc-del-btn{opacity:1;}
.photo-card .pc-check{position:absolute;top:5px;left:5px;z-index:5;cursor:pointer;}
.photo-card .pc-check input{width:16px;height:16px;cursor:pointer;accent-color:var(--orange);}
.empty-box{text-align:center;padding:60px 20px;color:var(--muted);}
.empty-box .eb-icon{font-size:40px;margin-bottom:12px;}
.empty-box p{font-size:13px;line-height:1.7;color:var(--muted2);}
.loading-box{text-align:center;padding:40px;color:var(--muted);font-size:13px;}
.loading-box .spin{display:inline-block;animation:spin 1s linear infinite;font-size:24px;margin-bottom:8px;}
@keyframes spin{to{transform:rotate(360deg);}}
.modal{display:none;position:fixed;inset:0;z-index:999;background:rgba(0,0,0,.93);align-items:center;justify-content:center;padding:20px;}
.modal.open{display:flex;}
.modal-wrap{position:relative;display:flex;flex-direction:column;align-items:center;}
.modal-img{max-width:90vw;max-height:82vh;border-radius:8px;box-shadow:0 24px 80px rgba(0,0,0,.8);display:block;}
.modal-x{position:absolute;top:-14px;right:-14px;width:30px;height:30px;border-radius:50%;background:var(--bg3);border:1px solid var(--border);color:var(--text);font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .15s;}
.modal-x:hover{background:#ef4444;border-color:#ef4444;color:#fff;}
.modal-nav{display:flex;gap:10px;margin-top:14px;}
.modal-nav button{padding:7px 18px;border-radius:7px;font-size:13px;font-weight:600;border:1px solid var(--border);background:var(--bg3);color:var(--muted2);cursor:pointer;transition:all .15s;font-family:'Noto Sans KR',sans-serif;}
.modal-nav button:hover{color:var(--text);border-color:var(--muted);}
.modal-info{text-align:center;margin-top:10px;font-size:12px;color:var(--muted);}
.modal-counter{font-size:11px;color:var(--muted);margin-top:3px;}
.dialog-bg{display:none;position:fixed;inset:0;z-index:200;background:rgba(0,0,0,.7);align-items:center;justify-content:center;}
.dialog-bg.open{display:flex;}
.dialog{background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:24px;width:360px;max-width:90vw;}
.dialog h3{font-size:16px;font-weight:700;margin-bottom:16px;}
.field{margin-bottom:14px;}
.field label{display:block;font-size:12px;color:var(--muted2);margin-bottom:6px;font-weight:500;}
.field input,.field select{width:100%;background:var(--bg3);border:1px solid var(--border);border-radius:7px;padding:9px 12px;color:var(--text);font-size:13px;font-family:'Noto Sans KR',sans-serif;transition:border-color .15s;}
.field input:focus,.field select:focus{outline:none;border-color:var(--orange);}
.dialog-btns{display:flex;gap:8px;justify-content:flex-end;margin-top:20px;}
.token-warn{background:rgba(234,179,8,.08);border:1px solid rgba(234,179,8,.25);border-radius:8px;padding:12px 14px;font-size:12px;color:#ca8a04;margin-bottom:20px;display:none;}
.token-warn.show{display:block;}
.upload-card{background:transparent;border:1px dashed var(--border);border-radius:10px;padding:16px;cursor:pointer;transition:all .2s;text-align:center;color:var(--muted);}
.upload-card:hover{border-color:var(--blue);color:var(--blue);background:rgba(59,130,246,.04);}
.upload-panel{background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:20px;margin-bottom:20px;}
.upload-panel h4{font-size:13px;font-weight:700;margin-bottom:14px;display:flex;align-items:center;gap:8px;}
.dropzone{border:2px dashed var(--border);border-radius:8px;padding:32px 16px;text-align:center;cursor:pointer;transition:all .2s;position:relative;margin-bottom:12px;}
.dropzone:hover,.dropzone.drag{border-color:var(--orange);background:rgba(249,115,22,.04);}
.dropzone input[type=file]{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%;}
.preview-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(90px,1fr));gap:6px;margin-bottom:12px;}
.preview-item{position:relative;border-radius:6px;overflow:hidden;aspect-ratio:4/3;background:var(--bg3);}
.preview-item img{width:100%;height:100%;object-fit:cover;}
.preview-item .pi-x{position:absolute;top:3px;right:3px;width:16px;height:16px;border-radius:50%;background:rgba(239,68,68,.9);color:#fff;font-size:10px;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;}
.preview-item .pi-nm{position:absolute;bottom:0;left:0;right:0;background:rgba(0,0,0,.65);font-size:8px;color:#fff;padding:2px 4px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.upload-prog{height:6px;background:var(--bg3);border-radius:3px;overflow:hidden;margin-bottom:8px;}
.upload-prog-bar{height:100%;background:var(--orange);border-radius:3px;transition:width .3s;width:0%;}
.upload-log{font-size:11px;color:var(--muted2);text-align:center;margin-bottom:10px;}
.token-panel{background:var(--bg2);border:1px solid rgba(234,179,8,.3);border-radius:10px;padding:16px;margin-bottom:20px;}
.token-panel h4{font-size:12px;font-weight:700;color:#ca8a04;margin-bottom:10px;}
.token-row{display:flex;gap:8px;}
.token-row input{flex:1;background:var(--bg3);border:1px solid var(--border);border-radius:7px;padding:8px 12px;color:var(--text);font-size:12px;font-family:'Noto Sans KR',sans-serif;}
.token-row input:focus{outline:none;border-color:var(--orange);}
.token-help{font-size:11px;color:var(--muted);margin-top:8px;line-height:1.6;}
.token-help a{color:var(--orange);text-decoration:none;}
.toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(20px);background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:10px 20px;font-size:13px;color:var(--text);z-index:500;opacity:0;transition:all .3s;pointer-events:none;}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0);}
@media(max-width:768px){.sidebar{display:none;}.page{padding:12px 14px 40px;}.content{margin-left:0;}}
</style>
</head>
<body>

<nav>
  <a class="nav-logo" href="index.html">âš  <span>SAFETY</span></a>
  <a class="nav-back" href="index.html">â† í™ˆ</a>
  <span style="color:var(--border)">|</span>
  <div class="breadcrumb" id="breadcrumb"></div>
  <div class="nav-right">
    <div id="tokenDot" style="width:8px;height:8px;border-radius:50%;background:var(--red);cursor:pointer;" onclick="toggleTokenPanel()" title="í† í° ì„¤ì •"></div>
    <button class="btn sm" onclick="toggleEditMode()" id="editBtn">âœï¸ í¸ì§‘</button>
  </div>
</nav>

<div class="page">
  <aside class="sidebar" id="sidebar">
    <div class="resizer" id="resizer"></div>
    <div class="sidebar-card">
      <div class="sidebar-head"><span>í´ë” êµ¬ì¡°</span></div>
      <div class="tree" id="treeRoot"></div>
    </div>
  </aside>
  <div class="content" id="content">
    <div class="token-panel" id="tokenPanel" style="display:none">
      <h4>ğŸ”‘ GitHub í† í° ì„¤ì •</h4>
      <div class="token-row">
        <input type="password" id="tokenInput" placeholder="ghp_xxxxxxxxxxxxxxxx">
        <button class="btn primary sm" onclick="saveToken()">ì €ì¥</button>
        <button class="btn danger sm" id="clearTokenBtn" onclick="clearToken()" style="display:none">ì‚­ì œ</button>
      </div>
      <div class="token-help">
        í† í°ì´ ì—†ìœ¼ë©´ <a href="https://github.com/settings/tokens/new?scopes=repo&description=SafetyPortal" target="_blank">ì—¬ê¸° í´ë¦­</a>
        â†’ <b>repo</b> ì²´í¬ â†’ Generate token â†’ ë³µì‚¬ í›„ ë¶™ì—¬ë„£ê¸°
      </div>
    </div>
  </div>
</div>

<div class="modal" id="modal" onclick="closeModal(event)">
  <div class="modal-wrap">
    <button class="modal-x" onclick="closeModal(null)">âœ•</button>
    <img class="modal-img" id="mImg" src="" alt="">
    <div class="modal-nav">
      <button onclick="moveModal(-1)">â† ì´ì „</button>
      <button onclick="moveModal(1)">ë‹¤ìŒ â†’</button>
    </div>
    <div class="modal-info" id="mInfo"></div>
    <div class="modal-counter" id="mCounter"></div>
  </div>
</div>

<div class="dialog-bg" id="folderDialog">
  <div class="dialog">
    <h3 id="dialogTitle">í´ë” ì¶”ê°€</h3>
    <div class="field"><label>í´ë” ì´ë¦„</label><input type="text" id="folderNameInput" placeholder="ì˜ˆ: 01_ì¼ì¼ì ê²€"></div>
    <div class="field"><label>ì„¤ëª… (ì„ íƒ)</label><input type="text" id="folderDescInput" placeholder="í´ë” ì„¤ëª…"></div>
    <div class="field">
      <label>ì•„ì´ì½˜</label>
      <select id="folderIconSelect">
        <option value="ğŸ“">ğŸ“ ê¸°ë³¸ í´ë”</option>
        <option value="ğŸ“·">ğŸ“· ì‚¬ì§„</option>
        <option value="ğŸ“‹">ğŸ“‹ ì ê²€</option>
        <option value="âš ï¸">âš ï¸ ê²½ê³ </option>
        <option value="âœ…">âœ… ì™„ë£Œ</option>
        <option value="ğŸ“Š">ğŸ“Š ë³´ê³ ì„œ</option>
        <option value="ğŸ—ï¸">ğŸ—ï¸ ê³µì‚¬</option>
        <option value="ğŸ‘·">ğŸ‘· ì•ˆì „</option>
        <option value="ğŸ”">ğŸ” ì¡°ì‚¬</option>
        <option value="ğŸ“">ğŸ“ ê¸°ë¡</option>
      </select>
    </div>
    <div class="dialog-btns">
      <button class="btn" onclick="closeDialog()">ì·¨ì†Œ</button>
      <button class="btn primary" onclick="saveFolder()" id="dialogSaveBtn">ì¶”ê°€</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
const OWNER  = 'fnksoul-ai';
const REPO   = 'safety-portal';
const BRANCH = 'main';

// â”€â”€ í† í° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getToken() { return localStorage.getItem('gh_token') || ''; }

function encodePath(path) {
  return path.split('/').map(s => encodeURIComponent(s)).join('/');
}

async function ghFetch(endpoint, method='GET', body=null) {
  const token = getToken();
  if (!token) throw new Error('NO_TOKEN');
  const res = await fetch(`https://api.github.com/repos/${OWNER}/${REPO}/${endpoint}`, {
    method,
    headers: {
      'Authorization': `Bearer ${token}`,
      'Content-Type': 'application/json',
      'Accept': 'application/vnd.github+json',
    },
    body: body ? JSON.stringify(body) : undefined,
  });
  if (method === 'DELETE' && res.status === 204) return {};
  const data = await res.json();
  if (!res.ok) throw new Error(data.message || `HTTP ${res.status}`);
  return data;
}

// â”€â”€ GitHub í´ë” ì§ì ‘ ì½ê¸° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const IMG_EXTS = /\.(jpg|jpeg|png|bmp|gif|tif|tiff|webp)$/i;

async function listPhotos(ghPath) {
  // GitHub APIë¡œ í•´ë‹¹ ê²½ë¡œì˜ íŒŒì¼ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
  const items = await ghFetch(`contents/${encodePath(ghPath)}`);
  if (!Array.isArray(items)) return [];
  return items
    .filter(f => f.type === 'file' && IMG_EXTS.test(f.name))
    .map(f => ({
      src: f.download_url,
      name: f.name,
      path: f.path,
      sha: f.sha,
    }));
}

// â”€â”€ í´ë” êµ¬ì¡° (ë¡œì»¬ìŠ¤í† ë¦¬ì§€) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const DEFAULT_STRUCTURE = {
  id:'root', name:'í˜„ì¥ì‚¬ì§„ê´€ë¦¬', icon:'ğŸ“¸', desc:'ì „ì²´ í˜„ì¥ ì‚¬ì§„ ê´€ë¦¬', ghPath:'photos',
  children:[
    {id:'c01', name:'01.ì ê²€ê¸°ë¡', icon:'ğŸ“‹', desc:'ê°ì¢… ì ê²€ ì‚¬ì§„ ê¸°ë¡', ghPath:'photos/01.ì ê²€ê¸°ë¡', children:[
      {id:'c01_01', name:'01_ì¼ì¼ì ê²€', icon:'ğŸ“…', desc:'ì¼ì¼ ì•ˆì „ì ê²€ ì‚¬ì§„', ghPath:'photos/01.ì ê²€ê¸°ë¡/01_ì¼ì¼ì ê²€', children:[]},
      {id:'c01_02', name:'02_ì •ê¸°ì ê²€', icon:'ğŸ”„', desc:'ì •ê¸°ì ê²€ ì‚¬ì§„', ghPath:'photos/01.ì ê²€ê¸°ë¡/02_ì •ê¸°ì ê²€', children:[
        {id:'c01_02_01', name:'01_ì›”ê°„ì ê²€', icon:'ğŸ“†', desc:'', ghPath:'photos/01.ì ê²€ê¸°ë¡/02_ì •ê¸°ì ê²€/01_ì›”ê°„ì ê²€', children:[]},
        {id:'c01_02_02', name:'02_ë²•ì •ì ê²€', icon:'âš–ï¸', desc:'', ghPath:'photos/01.ì ê²€ê¸°ë¡/02_ì •ê¸°ì ê²€/02_ë²•ì •ì ê²€', children:[]},
        {id:'c01_02_03', name:'03_í˜‘ë ¥ì—…ì²´ì ê²€', icon:'ğŸ¤', desc:'', ghPath:'photos/01.ì ê²€ê¸°ë¡/02_ì •ê¸°ì ê²€/03_í˜‘ë ¥ì—…ì²´ì ê²€', children:[]},
      ]},
      {id:'c01_03', name:'03_í•©ë™ì ê²€', icon:'ğŸ‘¥', desc:'í•©ë™ì ê²€ ì‚¬ì§„', ghPath:'photos/01.ì ê²€ê¸°ë¡/03_í•©ë™ì ê²€', children:[
        {id:'c01_03_01', name:'01_ë°œì£¼ì²˜í•©ë™ì ê²€', icon:'ğŸ¢', desc:'', ghPath:'photos/01.ì ê²€ê¸°ë¡/03_í•©ë™ì ê²€/01_ë°œì£¼ì²˜í•©ë™ì ê²€', children:[]},
        {id:'c01_03_02', name:'02_ê°ë¦¬í•©ë™ì ê²€', icon:'ğŸ”', desc:'', ghPath:'photos/01.ì ê²€ê¸°ë¡/03_í•©ë™ì ê²€/02_ê°ë¦¬í•©ë™ì ê²€', children:[]},
      ]},
      {id:'c01_04', name:'04_ìœ ê´€ê¸°ê´€ì ê²€', icon:'ğŸ›ï¸', desc:'', ghPath:'photos/01.ì ê²€ê¸°ë¡/04_ìœ ê´€ê¸°ê´€ì ê²€', children:[]},
    ]},
    {id:'c02', name:'02.ì§€ì &ì´ìŠˆ', icon:'âš ï¸', desc:'ì§€ì ì‚¬í•­ ë° ì´ìŠˆ', ghPath:'photos/02.ì§€ì &ì´ìŠˆ', children:[]},
    {id:'c03', name:'03.ê°œì„ ì¡°ì¹˜', icon:'âœ…', desc:'ê°œì„ ì¡°ì¹˜ ì „í›„ ì‚¬ì§„', ghPath:'photos/03.ê°œì„ ì¡°ì¹˜', children:[]},
    {id:'c04', name:'04.êµìœ¡&íšŒì˜', icon:'ğŸ“', desc:'êµìœ¡ ë° íšŒì˜', ghPath:'photos/04.êµìœ¡&íšŒì˜', children:[]},
    {id:'c05', name:'05.ì‚¬ê³ ì‚¬ë¡€', icon:'ğŸš¨', desc:'ì‚¬ê³ ì‚¬ë¡€ ì‚¬ì§„', ghPath:'photos/05.ì‚¬ê³ ì‚¬ë¡€', children:[]},
    {id:'c06', name:'06.ê¸°íƒ€', icon:'ğŸ“¦', desc:'ê¸°íƒ€ ì‚¬ì§„', ghPath:'photos/06.ê¸°íƒ€', children:[]},
  ]
};

function loadStructure(){
  try{ const s=localStorage.getItem('galleryStructure'); return s?JSON.parse(s):JSON.parse(JSON.stringify(DEFAULT_STRUCTURE)); }
  catch{ return JSON.parse(JSON.stringify(DEFAULT_STRUCTURE)); }
}
function saveStructure(){ localStorage.setItem('galleryStructure', JSON.stringify(structure)); }

// â”€â”€ ìƒíƒœ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let structure    = loadStructure();
let currentPath  = ['root'];
let editMode     = false;
let allPhotos    = [];
let curModalIdx  = 0;
let dialogMode   = null;
let editTarget   = null;
let dialogParentId = null;
let selectedPhotos = new Set();

// â”€â”€ ë…¸ë“œ íƒìƒ‰ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function findNode(id, node){ if(!node)node=structure; if(node.id===id)return node; if(node.children){for(const c of node.children){const r=findNode(id,c);if(r)return r;}} return null; }
function findParent(id, node, parent){ if(!node)node=structure; if(node.id===id)return parent; if(node.children){for(const c of node.children){const r=findParent(id,c,node);if(r)return r;}} return null; }
function genId(){ return 'f_'+Date.now()+'_'+Math.random().toString(36).slice(2,6); }
function getPathTo(targetId, node, path){ const np=[...path,node.id]; if(node.id===targetId)return np; if(node.children){for(const c of node.children){const r=getPathTo(targetId,c,np);if(r)return r;}} return null; }

// â”€â”€ íŠ¸ë¦¬ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderTree(){
  const root=document.getElementById('treeRoot');
  root.innerHTML='';
  renderTreeNode(structure,root,0);
}
function renderTreeNode(node, container, depth){
  const hasChildren=node.children&&node.children.length>0;
  const isActive=currentPath[currentPath.length-1]===node.id;
  const isOpen=currentPath.includes(node.id);
  const item=document.createElement('div');
  item.className='tree-item'+(isActive?' active':'')+(isOpen&&hasChildren?' open':'');
  item.style.paddingLeft=(14+depth*12)+'px';
  item.innerHTML=`<span class="ti-toggle">${hasChildren?'â–¶':' '}</span><span class="ti-icon">${node.icon||'ğŸ“'}</span><span class="ti-name">${node.name}</span>`;
  item.onclick=e=>{e.stopPropagation();navigateTo(node.id);};
  container.appendChild(item);
  if(hasChildren){
    const ch=document.createElement('div');
    ch.className='tree-children'+(isOpen?'':' hidden');
    node.children.forEach(c=>renderTreeNode(c,ch,depth+1));
    container.appendChild(ch);
  }
}

// â”€â”€ ë¸Œë ˆë“œí¬ëŸ¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderBreadcrumb(){
  const bc=document.getElementById('breadcrumb');
  bc.innerHTML='';
  currentPath.forEach((id,i)=>{
    const node=findNode(id);
    if(!node)return;
    if(i>0){const sep=document.createElement('span');sep.className='bc-sep';sep.textContent='â€º';bc.appendChild(sep);}
    const item=document.createElement('span');
    item.className='bc-item'+(i===currentPath.length-1?' active':'');
    item.textContent=node.name;
    item.onclick=()=>navigateToPath(currentPath.slice(0,i+1));
    bc.appendChild(item);
  });
}

// â”€â”€ ë„¤ë¹„ê²Œì´ì…˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function navigateTo(id){ const path=getPathTo(id,structure,[]); if(path){currentPath=path;renderAll();} }
function navigateToPath(path){ currentPath=path; renderAll(); }

function renderAll(){ renderTree(); renderBreadcrumb(); renderContent(); if(window._updateContentMargin)window._updateContentMargin(); }

// â”€â”€ ì½˜í…ì¸  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderContent(){
  const node=findNode(currentPath[currentPath.length-1]);
  if(!node)return;
  const content=document.getElementById('content');

  // í† í° ê²½ê³  ìœ ì§€
  const warn=document.getElementById('tokenWarn');
  content.innerHTML='';
  content.appendChild(warn);
  if(!getToken()) warn.classList.add('show'); else warn.classList.remove('show');

  // í—¤ë”
  const hdr=document.createElement('div');
  hdr.className='folder-header';
  hdr.innerHTML=`<span class="folder-icon">${node.icon||'ğŸ“'}</span>
    <div><div class="folder-title">${node.name}</div>${node.desc?`<div class="folder-desc">${node.desc}</div>`:''}</div>
    <div class="folder-actions" id="folderActions"></div>`;
  content.appendChild(hdr);

  if(editMode&&node.id!=='root'){
    hdr.querySelector('#folderActions').innerHTML=`
      <button class="btn sm" onclick="openEditDialog('${node.id}')">âœï¸ ì´ë¦„ ë³€ê²½</button>
      <button class="btn sm danger" onclick="deleteFolder('${node.id}')">ğŸ—‘ï¸ ì‚­ì œ</button>`;
  }

  // í•˜ìœ„ í´ë”
  if(node.children&&node.children.length>0){
    const lbl=document.createElement('div');lbl.className='sec-label';lbl.textContent='í•˜ìœ„ í´ë”';
    content.appendChild(lbl);
    const grid=document.createElement('div');grid.className='subfolder-grid';
    node.children.forEach(child=>{
      const card=document.createElement('div');card.className='folder-card';
      card.innerHTML=`<div class="fc-icon">${child.icon||'ğŸ“'}</div>
        <div class="fc-name">${child.name}</div>
        <div class="fc-cnt">í´ë”</div>
        ${editMode?`<div class="fc-actions">
          <button class="icon-btn edit" onclick="event.stopPropagation();openEditDialog('${child.id}')">âœï¸</button>
          <button class="icon-btn del" onclick="event.stopPropagation();deleteFolder('${child.id}')">ğŸ—‘</button>
        </div>`:''}`;
      card.onclick=()=>navigateTo(child.id);
      grid.appendChild(card);
    });
    if(editMode){
      const add=document.createElement('div');add.className='add-folder-card';
      add.innerHTML='<div style="font-size:24px;margin-bottom:6px">â•</div><div style="font-size:12px;font-weight:500">í´ë” ì¶”ê°€</div>';
      add.onclick=()=>openAddDialog(node.id);
      grid.appendChild(add);
    }
    content.appendChild(grid);
  } else if(editMode){
    const lbl=document.createElement('div');lbl.className='sec-label';lbl.textContent='í•˜ìœ„ í´ë”';
    content.appendChild(lbl);
    const grid=document.createElement('div');grid.className='subfolder-grid';
    const add=document.createElement('div');add.className='add-folder-card';
    add.innerHTML='<div style="font-size:24px;margin-bottom:6px">â•</div><div style="font-size:12px;font-weight:500">í´ë” ì¶”ê°€</div>';
    add.onclick=()=>openAddDialog(node.id);
    grid.appendChild(add);
    content.appendChild(grid);
  }

  // ğŸ“¤ ì‚¬ì§„ ì—…ë¡œë“œ íŒ¨ë„ (í´ë”ì— ghPathê°€ ìˆì„ ë•Œ í•­ìƒ í‘œì‹œ)
  if(node.ghPath && getToken()){
    renderUploadPanel(node, content);
  }

  // ì‚¬ì§„ ì„¹ì…˜ â€” GitHub APIë¡œ ì§ì ‘ ë¡œë“œ
  if(node.ghPath && getToken()){
    renderPhotosFromGitHub(node, content);
  } else if(!getToken()) {
    // í† í° ì—†ìŒ ì•ˆë‚´
  }
}

// â”€â”€ ì—…ë¡œë“œ íŒ¨ë„ ë Œë” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderUploadPanel(node, container){
  let uploadFiles = [];
  let isUploading = false;

  const panel = document.createElement('div');
  panel.className = 'upload-panel';
  panel.id = 'uploadPanel';
  panel.innerHTML = `
    <h4>ğŸ“¤ ì‚¬ì§„ ì—…ë¡œë“œ <span style="font-size:11px;color:var(--muted);font-weight:400">â†’ ${node.ghPath}/</span></h4>
    <div class="dropzone" id="upDropzone">
      <input type="file" id="upFileInput" accept="image/*" multiple>
      <div style="font-size:28px;margin-bottom:8px">ğŸ“¸</div>
      <div style="font-size:13px;font-weight:600;color:var(--muted2)">ì‚¬ì§„ì„ ëŒì–´ë‹¤ ë†“ê±°ë‚˜ í´ë¦­í•´ì„œ ì„ íƒ</div>
      <div style="font-size:11px;color:var(--muted);margin-top:4px">JPG, PNG, BMP, GIF Â· ì—¬ëŸ¬ ì¥ ë™ì‹œ ê°€ëŠ¥</div>
    </div>
    <div class="preview-grid" id="upPreviewGrid" style="display:none"></div>
    <div class="upload-prog" id="upProg" style="display:none"><div class="upload-prog-bar" id="upProgBar"></div></div>
    <div class="upload-log" id="upLog"></div>
    <div style="display:flex;gap:8px;align-items:center;">
      <button class="btn primary" id="upBtn" onclick="startUpload_${node.id}()" disabled>ğŸ“¤ ì—…ë¡œë“œ</button>
      <button class="btn sm" id="upClearBtn" onclick="clearUpload_${node.id}()" style="display:none">ì´ˆê¸°í™”</button>
      <span id="upCount" style="font-size:12px;color:var(--muted)"></span>
    </div>`;
  container.appendChild(panel);

  const dz = panel.querySelector('#upDropzone');
  const fi = panel.querySelector('#upFileInput');
  const IMG_EXTS2 = ['jpg','jpeg','png','bmp','gif','tif','tiff','webp'];

  dz.addEventListener('dragover', e=>{e.preventDefault();dz.classList.add('drag');});
  dz.addEventListener('dragleave', ()=>dz.classList.remove('drag'));
  dz.addEventListener('drop', e=>{e.preventDefault();dz.classList.remove('drag');handleUploadFiles(e.dataTransfer.files);});
  fi.addEventListener('change', ()=>handleUploadFiles(fi.files));

  function handleUploadFiles(fileList){
    const exts = IMG_EXTS2;
    const newFiles = [...fileList].filter(f=>exts.includes(f.name.split('.').pop().toLowerCase()));
    if(!newFiles.length){showToast('ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì„ íƒ ê°€ëŠ¥í•©ë‹ˆë‹¤');return;}
    newFiles.forEach(f=>{if(!uploadFiles.find(x=>x.name===f.name&&x.size===f.size))uploadFiles.push(f);});
    renderPreviews();
    updateUploadCount();
    if(getToken()) panel.querySelector('#upBtn').disabled = false;
  }

  function renderPreviews(){
    const grid = panel.querySelector('#upPreviewGrid');
    grid.style.display = uploadFiles.length ? 'grid' : 'none';
    grid.innerHTML = '';
    uploadFiles.forEach((f,i)=>{
      const url = URL.createObjectURL(f);
      const item = document.createElement('div');
      item.className = 'preview-item';
      item.innerHTML = `<img src="${url}"><div class="pi-nm">${f.name}</div><button class="pi-x" onclick="removeUpFile(${i})">âœ•</button>`;
      grid.appendChild(item);
    });
    panel.querySelector('#upClearBtn').style.display = uploadFiles.length ? '' : 'none';
  }

  window[`removeUpFile`] = function(i){ uploadFiles.splice(i,1); renderPreviews(); updateUploadCount(); if(!uploadFiles.length) panel.querySelector('#upBtn').disabled=true; };

  function updateUploadCount(){
    panel.querySelector('#upCount').textContent = uploadFiles.length ? uploadFiles.length+'ì¥ ì„ íƒë¨' : '';
  }

  window[`clearUpload_${node.id}`] = function(){
    uploadFiles=[];renderPreviews();updateUploadCount();
    panel.querySelector('#upBtn').disabled=true;
    panel.querySelector('#upLog').textContent='';
    panel.querySelector('#upProg').style.display='none';
  };

  window[`startUpload_${node.id}`] = async function(){
    if(isUploading||!uploadFiles.length) return;
    if(!getToken()){showToast('í† í°ì„ ë¨¼ì € ì„¤ì •í•´ì£¼ì„¸ìš”');return;}
    isUploading = true;
    const btn = panel.querySelector('#upBtn');
    btn.disabled=true; btn.textContent='â³ ì—…ë¡œë“œ ì¤‘...';
    panel.querySelector('#upProg').style.display='block';
    const log = panel.querySelector('#upLog');
    const progBar = panel.querySelector('#upProgBar');
    let ok=0, fail=0;
    const total = uploadFiles.length;

    for(let i=0;i<total;i++){
      const f = uploadFiles[i];
      progBar.style.width = Math.round((i/total)*100)+'%';
      log.textContent = `(${i+1}/${total}) ${f.name} ì—…ë¡œë“œ ì¤‘...`;
      try{
        const b64 = await fileToBase64(f);
        const ghPath = node.ghPath+'/'+f.name;
        let sha;
        try{ const chk=await ghFetch(`contents/${encodePath(ghPath)}`); sha=chk.sha; }catch{}
        const body={message:`ì‚¬ì§„ ì—…ë¡œë“œ: ${f.name}`, content:b64, branch:BRANCH};
        if(sha) body.sha=sha;
        await ghFetch(`contents/${encodePath(ghPath)}`, 'PUT', body);
        ok++;
      }catch(e){ fail++; console.error(f.name, e.message); }
    }

    progBar.style.width='100%';
    log.textContent = `âœ… ${ok}ì¥ ì™„ë£Œ${fail?` / âŒ ${fail}ì¥ ì‹¤íŒ¨`:''}`;
    isUploading=false;
    btn.disabled=false; btn.textContent='ğŸ“¤ ì—…ë¡œë“œ';
    if(ok>0){
      showToast(`âœ… ${ok}ì¥ ì—…ë¡œë“œ ì™„ë£Œ!`);
      uploadFiles=[];renderPreviews();updateUploadCount();
      // ì‚¬ì§„ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
      setTimeout(()=>renderAll(), 1500);
    }
  };
}

async function fileToBase64(file){
  return new Promise((res,rej)=>{
    const r=new FileReader();
    r.onload=()=>res(r.result.split(',')[1]);
    r.onerror=rej;
    r.readAsDataURL(file);
  });
}

// â”€â”€ GitHub APIë¡œ ì‚¬ì§„ ì§ì ‘ ë¡œë“œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function renderPhotosFromGitHub(node, container){
  const loadingEl=document.createElement('div');
  loadingEl.className='loading-box';
  loadingEl.innerHTML='<div class="spin">â³</div><div>ì‚¬ì§„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
  container.appendChild(loadingEl);

  try {
    const photos = await listPhotos(node.ghPath);
    loadingEl.remove();

    if(!photos.length){
      const box=document.createElement('div');box.className='empty-box';
      box.innerHTML='<div class="eb-icon">ğŸ–¼ï¸</div><p>ì´ í´ë”ì— ì‚¬ì§„ì´ ì—†ìŠµë‹ˆë‹¤.<br><a href="upload.html" style="color:var(--orange)">ì‚¬ì§„ ì—…ë¡œë“œí•˜ê¸° â†’</a></p>';
      container.appendChild(box);
      return;
    }

    allPhotos = photos;
    selectedPhotos.clear();

    const lbl=document.createElement('div');lbl.className='sec-label';lbl.id='photoSecLabel';
    lbl.textContent=`ì‚¬ì§„ (${photos.length}ì¥)`;
    container.appendChild(lbl);

    const toolbar=document.createElement('div');toolbar.className='photo-toolbar';
    toolbar.innerHTML=`
      <div class="srch">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
        <input type="text" placeholder="íŒŒì¼ëª… ê²€ìƒ‰" oninput="filterPhotos(this.value)">
      </div>
      ${editMode?`<button class="btn sm" onclick="selectAll(true)">ì „ì²´ì„ íƒ</button>
        <button class="btn sm" onclick="selectAll(false)">ì„ íƒí•´ì œ</button>
        <button class="btn sm danger" id="bulkDelBtn" style="display:none" onclick="deleteSelected()">ğŸ—‘ ì„ íƒì‚­ì œ</button>`:''}
      <div class="photo-stat" id="photoStat"><b>${photos.length}</b>ì¥</div>`;
    container.appendChild(toolbar);

    const grid=document.createElement('div');grid.className='photo-grid';grid.id='photoGrid';
    photos.forEach((p,i)=>{
      const card=document.createElement('div');
      card.className='photo-card';card.dataset.name=p.name;card.dataset.path=p.path;card.dataset.sha=p.sha;
      card.innerHTML=`
        <img src="${p.src}" alt="${p.name}" loading="lazy">
        <div class="pc-ov"><div class="pc-nm">${p.name}</div></div>
        ${editMode?`<button class="pc-del-btn" onclick="event.stopPropagation();deletePhoto(this.closest('.photo-card'))">ğŸ—‘</button>
          <label class="pc-check" onclick="event.stopPropagation()"><input type="checkbox" onchange="toggleSelect(this,'${p.path}')"></label>`:''}`;
      if(!editMode) card.onclick=()=>{curModalIdx=i;updateModal();document.getElementById('modal').classList.add('open');};
      grid.appendChild(card);
    });
    container.appendChild(grid);

  } catch(e) {
    loadingEl.remove();
    if(e.message==='NO_TOKEN') return;
    const box=document.createElement('div');box.className='empty-box';
    box.innerHTML=`<div class="eb-icon">âš ï¸</div><p>ì‚¬ì§„ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.<br>${e.message}</p>`;
    container.appendChild(box);
  }
}

// â”€â”€ ì‚¬ì§„ í•„í„° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function filterPhotos(val){
  document.querySelectorAll('#photoGrid .photo-card').forEach(card=>{
    card.style.display=(!val||card.dataset.name.toLowerCase().includes(val.toLowerCase()))?'':'none';
  });
}

// â”€â”€ ì‚¬ì§„ ì„ íƒ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleSelect(cb, path){
  if(cb.checked) selectedPhotos.add(path); else selectedPhotos.delete(path);
  const btn=document.getElementById('bulkDelBtn');
  if(btn) btn.style.display=selectedPhotos.size>0?'':'none';
}
function selectAll(all){
  document.querySelectorAll('#photoGrid .photo-card').forEach(card=>{
    const cb=card.querySelector('input[type=checkbox]');
    const path=card.dataset.path;
    if(all){selectedPhotos.add(path);if(cb)cb.checked=true;}
    else{selectedPhotos.delete(path);if(cb)cb.checked=false;}
  });
  const btn=document.getElementById('bulkDelBtn');
  if(btn) btn.style.display=selectedPhotos.size>0?'':'none';
}

// â”€â”€ ì‚¬ì§„ ì‚­ì œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function deletePhoto(card){
  if(!getToken()){showToast('âš  í† í°ì„ ë¨¼ì € ì„¤ì •í•´ì£¼ì„¸ìš”');return;}
  const path=card.dataset.path;
  const sha=card.dataset.sha;
  const name=card.dataset.name;
  if(!confirm(`"${name}" ì„ ì‚­ì œí• ê¹Œìš”?`))return;
  try{
    await ghFetch(`contents/${encodePath(path)}`, 'DELETE', {message:`ì‚¬ì§„ ì‚­ì œ: ${name}`, sha, branch:BRANCH});
    card.remove();
    updatePhotoCount(-1);
    showToast('âœ… ì‚­ì œ ì™„ë£Œ: '+name);
  }catch(e){showToast('âŒ ì‚­ì œ ì‹¤íŒ¨: '+e.message);}
}

async function deleteSelected(){
  if(!getToken()){showToast('âš  í† í°ì„ ë¨¼ì € ì„¤ì •í•´ì£¼ì„¸ìš”');return;}
  if(!selectedPhotos.size)return;
  if(!confirm(`ì„ íƒí•œ ${selectedPhotos.size}ì¥ì„ ì‚­ì œí• ê¹Œìš”?`))return;
  let ok=0,fail=0;
  const cards=[...document.querySelectorAll('#photoGrid .photo-card')].filter(c=>selectedPhotos.has(c.dataset.path));
  for(const card of cards){
    try{
      await ghFetch(`contents/${encodePath(card.dataset.path)}`, 'DELETE', {message:`ì‚¬ì§„ ì‚­ì œ: ${card.dataset.name}`, sha:card.dataset.sha, branch:BRANCH});
      card.remove(); ok++;
    }catch{fail++;}
  }
  selectedPhotos.clear();
  updatePhotoCount(-ok);
  showToast(`âœ… ${ok}ì¥ ì‚­ì œ${fail?` / âŒ ${fail}ì¥ ì‹¤íŒ¨`:''}`);
}

function updatePhotoCount(delta){
  const stat=document.getElementById('photoStat');
  const lbl=document.getElementById('photoSecLabel');
  const cur=allPhotos.length+delta; // ê·¼ì‚¬ê°’
  const actual=document.querySelectorAll('#photoGrid .photo-card').length;
  if(stat) stat.innerHTML=`<b>${actual}</b>ì¥`;
  if(lbl) lbl.textContent=`ì‚¬ì§„ (${actual}ì¥)`;
}

// â”€â”€ ëª¨ë‹¬ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateModal(){ const p=allPhotos[curModalIdx]; document.getElementById('mImg').src=p.src; document.getElementById('mInfo').textContent=p.name; document.getElementById('mCounter').textContent=(curModalIdx+1)+' / '+allPhotos.length; }
function moveModal(dir){ curModalIdx=(curModalIdx+dir+allPhotos.length)%allPhotos.length; updateModal(); }
function closeModal(e){ if(e===null||e.target===document.getElementById('modal'))document.getElementById('modal').classList.remove('open'); }
document.addEventListener('keydown',e=>{
  if(!document.getElementById('modal').classList.contains('open'))return;
  if(e.key==='Escape')closeModal(null);
  if(e.key==='ArrowLeft')moveModal(-1);
  if(e.key==='ArrowRight')moveModal(1);
});

// â”€â”€ í¸ì§‘ ëª¨ë“œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleEditMode(){
  editMode=!editMode;
  const btn=document.getElementById('editBtn');
  btn.textContent=editMode?'âœ… ì™„ë£Œ':'âœï¸ í¸ì§‘';
  btn.className=editMode?'btn sm primary':'btn sm';
  selectedPhotos.clear();
  renderAll();
  showToast(editMode?'í¸ì§‘ ëª¨ë“œ í™œì„±í™”':'í¸ì§‘ ì™„ë£Œ');
}

// â”€â”€ í´ë” ì¶”ê°€/ìˆ˜ì •/ì‚­ì œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openAddDialog(parentId){
  dialogMode='add';dialogParentId=parentId;editTarget=null;
  document.getElementById('dialogTitle').textContent='í´ë” ì¶”ê°€';
  document.getElementById('dialogSaveBtn').textContent='ì¶”ê°€';
  document.getElementById('folderNameInput').value='';
  document.getElementById('folderDescInput').value='';
  document.getElementById('folderIconSelect').value='ğŸ“';
  document.getElementById('folderDialog').classList.add('open');
  setTimeout(()=>document.getElementById('folderNameInput').focus(),100);
}
function openEditDialog(id){
  const node=findNode(id);if(!node)return;
  dialogMode='edit';editTarget=node;
  document.getElementById('dialogTitle').textContent='í´ë” ìˆ˜ì •';
  document.getElementById('dialogSaveBtn').textContent='ì €ì¥';
  document.getElementById('folderNameInput').value=node.name;
  document.getElementById('folderDescInput').value=node.desc||'';
  document.getElementById('folderIconSelect').value=node.icon||'ğŸ“';
  document.getElementById('folderDialog').classList.add('open');
  setTimeout(()=>document.getElementById('folderNameInput').focus(),100);
}
function closeDialog(){document.getElementById('folderDialog').classList.remove('open');}
function saveFolder(){
  const name=document.getElementById('folderNameInput').value.trim();
  if(!name){document.getElementById('folderNameInput').focus();return;}
  const desc=document.getElementById('folderDescInput').value.trim();
  const icon=document.getElementById('folderIconSelect').value;
  if(dialogMode==='add'){
    const parent=findNode(dialogParentId);if(!parent)return;
    if(!parent.children)parent.children=[];
    const parentPath=parent.ghPath||'photos';
    parent.children.push({id:genId(),name,icon,desc,ghPath:parentPath+'/'+name,children:[]});
    showToast('í´ë” ì¶”ê°€ë¨: '+name);
  }else if(dialogMode==='edit'&&editTarget){
    editTarget.name=name;editTarget.icon=icon;editTarget.desc=desc;
    showToast('í´ë” ìˆ˜ì •ë¨: '+name);
  }
  saveStructure();closeDialog();renderAll();
}
function deleteFolder(id){
  const node=findNode(id);if(!node)return;
  if(!confirm(`"${node.name}" í´ë”ë¥¼ ì‚­ì œí• ê¹Œìš”?\n(ë¡œì»¬ êµ¬ì¡°ì—ì„œë§Œ ì‚­ì œë©ë‹ˆë‹¤)`))return;
  const parent=findParent(id);if(!parent)return;
  parent.children=parent.children.filter(c=>c.id!==id);
  if(currentPath.includes(id)){const idx=currentPath.indexOf(id);currentPath=currentPath.slice(0,idx);if(!currentPath.length)currentPath=['root'];}
  saveStructure();renderAll();showToast('í´ë” ì‚­ì œë¨: '+node.name);
}
document.addEventListener('keydown',e=>{
  if(document.getElementById('folderDialog').classList.contains('open')){
    if(e.key==='Enter')saveFolder();
    if(e.key==='Escape')closeDialog();
  }
});
document.getElementById('folderDialog').onclick=e=>{if(e.target===document.getElementById('folderDialog'))closeDialog();};
window.resetStructure=()=>{if(confirm('ì´ˆê¸°í™”í• ê¹Œìš”?')){localStorage.removeItem('galleryStructure');structure=JSON.parse(JSON.stringify(DEFAULT_STRUCTURE));currentPath=['root'];renderAll();showToast('ì´ˆê¸°í™” ì™„ë£Œ');}};

// â”€â”€ ì‚¬ì´ë“œë°” ë¦¬ì‚¬ì´ì¦ˆ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(function(){
  const sidebar=document.getElementById('sidebar');
  const resizer=document.getElementById('resizer');
  let isDown=false,startX=0,startW=0;
  const saved=localStorage.getItem('sidebarWidth');
  if(saved)sidebar.style.width=saved+'px';
  updateContentMargin();
  resizer.addEventListener('mousedown',e=>{isDown=true;startX=e.clientX;startW=sidebar.offsetWidth;resizer.classList.add('active');document.body.style.cursor='col-resize';document.body.style.userSelect='none';e.preventDefault();});
  document.addEventListener('mousemove',e=>{if(!isDown)return;const newW=Math.min(500,Math.max(180,startW+(e.clientX-startX)));sidebar.style.width=newW+'px';updateContentMargin();});
  document.addEventListener('mouseup',()=>{if(!isDown)return;isDown=false;resizer.classList.remove('active');document.body.style.cursor='';document.body.style.userSelect='';localStorage.setItem('sidebarWidth',sidebar.offsetWidth);});
  resizer.addEventListener('dblclick',()=>{let maxW=180;document.querySelectorAll('.tree-item').forEach(el=>{maxW=Math.max(maxW,el.scrollWidth+20);});maxW=Math.min(500,maxW);sidebar.style.width=maxW+'px';updateContentMargin();localStorage.setItem('sidebarWidth',maxW);});
  function updateContentMargin(){document.querySelector('.content').style.marginLeft=(sidebar.offsetWidth+20)+'px';}
  window._updateContentMargin=updateContentMargin;
})();

// â”€â”€ í† í° ê´€ë¦¬ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleTokenPanel(){
  const panel = document.getElementById('tokenPanel');
  panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
}
function saveToken(){
  const val = document.getElementById('tokenInput').value.trim();
  if(!val){showToast('í† í°ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');return;}
  if(!val.startsWith('ghp_')&&!val.startsWith('github_pat_')){showToast('ì˜¬ë°”ë¥¸ GitHub í† í° í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤');return;}
  localStorage.setItem('gh_token', val);
  document.getElementById('tokenInput').value='';
  updateTokenDot();
  document.getElementById('tokenPanel').style.display='none';
  showToast('âœ… í† í° ì €ì¥ë¨! ê°¤ëŸ¬ë¦¬ë¥¼ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.');
  setTimeout(()=>renderAll(), 500);
}
function clearToken(){
  if(!confirm('í† í°ì„ ì‚­ì œí• ê¹Œìš”?'))return;
  localStorage.removeItem('gh_token');
  updateTokenDot();
  showToast('í† í° ì‚­ì œë¨');
  renderAll();
}
function updateTokenDot(){
  const dot = document.getElementById('tokenDot');
  const clearBtn = document.getElementById('clearTokenBtn');
  if(getToken()){
    dot.style.background='var(--green)';
    dot.title='í† í° ì„¤ì •ë¨ (í´ë¦­í•˜ì—¬ ë³€ê²½)';
    if(clearBtn) clearBtn.style.display='';
  } else {
    dot.style.background='var(--red)';
    dot.title='í† í° ë¯¸ì„¤ì • (í´ë¦­í•˜ì—¬ ì„¤ì •)';
    if(clearBtn) clearBtn.style.display='none';
  }
}

// â”€â”€ í† ìŠ¤íŠ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showToast(msg){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2500);}

// â”€â”€ ì‹œì‘ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
updateTokenDot();
renderAll();
</script>
</body>
</html>
