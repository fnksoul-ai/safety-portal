<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ì‚¬ì§„ ì—…ë¡œë“œ Â· Safety Portal</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&family=Bebas+Neue&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0f1117;--bg2:#171b24;--bg3:#1e2330;--bg4:#252a38;
  --border:#2c3347;--orange:#f97316;--blue:#3b82f6;
  --green:#22c55e;--red:#ef4444;--yellow:#eab308;
  --text:#f1f5f9;--muted:#64748b;--muted2:#94a3b8;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'Noto Sans KR',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;}
body::before{content:'';position:fixed;inset:0;z-index:0;
  background-image:linear-gradient(rgba(249,115,22,.025) 1px,transparent 1px),
  linear-gradient(90deg,rgba(249,115,22,.025) 1px,transparent 1px);
  background-size:40px 40px;pointer-events:none;}

/* NAV */
nav{position:sticky;top:0;z-index:100;background:rgba(15,17,23,.95);
  backdrop-filter:blur(16px);border-bottom:1px solid var(--border);
  padding:0 24px;display:flex;align-items:center;height:52px;gap:16px;}
.nav-logo{font-family:'Bebas Neue',sans-serif;font-size:20px;
  letter-spacing:.1em;color:var(--orange);text-decoration:none;}
.nav-logo span{color:var(--text);}
.nav-back{font-size:12px;color:var(--muted2);text-decoration:none;
  display:flex;align-items:center;gap:4px;padding:5px 10px;border-radius:6px;transition:all .15s;}
.nav-back:hover{color:var(--text);background:var(--bg3);}
.nav-title{font-size:13px;font-weight:600;color:var(--muted2);}
.nav-right{margin-left:auto;display:flex;align-items:center;gap:8px;}
.token-status{font-size:11px;display:flex;align-items:center;gap:5px;}
.dot{width:7px;height:7px;border-radius:50%;}
.dot.ok{background:var(--green);box-shadow:0 0 5px var(--green);}
.dot.no{background:var(--red);box-shadow:0 0 5px var(--red);}

/* LAYOUT */
.wrap{position:relative;z-index:1;max-width:900px;margin:0 auto;padding:28px 24px 60px;}

/* CARD */
.card{background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:24px;margin-bottom:20px;}
.card-title{font-size:14px;font-weight:700;margin-bottom:16px;display:flex;align-items:center;gap:8px;}
.card-title .ct-icon{font-size:18px;}

/* í† í° ì„¤ì • */
.token-wrap{display:flex;gap:8px;}
.token-input{flex:1;background:var(--bg3);border:1px solid var(--border);border-radius:8px;
  padding:10px 14px;color:var(--text);font-size:13px;font-family:'Noto Sans KR',sans-serif;}
.token-input:focus{outline:none;border-color:var(--orange);}
.token-input::placeholder{color:var(--muted);}
.btn{padding:9px 18px;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;
  border:1px solid var(--border);background:var(--bg3);color:var(--muted2);
  transition:all .15s;font-family:'Noto Sans KR',sans-serif;white-space:nowrap;}
.btn:hover{color:var(--text);border-color:var(--muted);}
.btn.primary{background:var(--orange);border-color:var(--orange);color:#fff;}
.btn.primary:hover{background:#ea6c0a;}
.btn.primary:disabled{background:var(--muted);border-color:var(--muted);cursor:not-allowed;opacity:.6;}
.btn.sm{padding:6px 12px;font-size:12px;}
.btn.danger{border-color:var(--red);color:var(--red);}
.btn.danger:hover{background:var(--red);color:#fff;}
.token-help{font-size:11px;color:var(--muted);margin-top:8px;line-height:1.6;}
.token-help a{color:var(--orange);text-decoration:none;}
.token-help a:hover{text-decoration:underline;}

/* ì—…ë¡œë“œ í¼ */
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px;}
.field label{display:block;font-size:12px;color:var(--muted2);margin-bottom:6px;font-weight:500;}
.field select,.field input{width:100%;background:var(--bg3);border:1px solid var(--border);
  border-radius:8px;padding:9px 12px;color:var(--text);font-size:13px;
  font-family:'Noto Sans KR',sans-serif;transition:border-color .15s;}
.field select:focus,.field input:focus{outline:none;border-color:var(--orange);}

/* ë“œë¡­ì¡´ */
.dropzone{border:2px dashed var(--border);border-radius:10px;
  padding:48px 24px;text-align:center;cursor:pointer;
  transition:all .2s;position:relative;margin-bottom:16px;}
.dropzone:hover,.dropzone.drag{border-color:var(--orange);background:rgba(249,115,22,.04);}
.dropzone input[type=file]{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%;}
.dz-icon{font-size:36px;margin-bottom:10px;}
.dz-text{font-size:14px;font-weight:600;color:var(--muted2);margin-bottom:4px;}
.dz-sub{font-size:12px;color:var(--muted);}

/* ë¯¸ë¦¬ë³´ê¸° ê·¸ë¦¬ë“œ */
.preview-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:8px;margin-bottom:16px;}
.preview-item{position:relative;border-radius:7px;overflow:hidden;
  background:var(--bg3);border:1px solid var(--border);aspect-ratio:4/3;}
.preview-item img{width:100%;height:100%;object-fit:cover;display:block;}
.preview-item .pi-name{position:absolute;bottom:0;left:0;right:0;
  background:rgba(0,0,0,.7);font-size:9px;color:#fff;padding:3px 5px;
  overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.preview-item .pi-remove{position:absolute;top:4px;right:4px;width:18px;height:18px;
  border-radius:50%;background:rgba(239,68,68,.9);color:#fff;font-size:11px;
  border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;}
.preview-item .pi-status{position:absolute;inset:0;display:flex;align-items:center;
  justify-content:center;font-size:20px;background:rgba(0,0,0,.5);}

/* ì§„í–‰ ìƒí™© */
.progress-wrap{margin-bottom:16px;}
.progress-bar-bg{height:8px;background:var(--bg3);border-radius:4px;overflow:hidden;}
.progress-bar{height:100%;background:var(--orange);border-radius:4px;
  transition:width .3s;width:0%;}
.progress-text{font-size:12px;color:var(--muted2);margin-top:6px;text-align:center;}

/* ë¡œê·¸ */
.log{background:var(--bg3);border:1px solid var(--border);border-radius:8px;
  padding:12px;max-height:200px;overflow-y:auto;font-size:11px;
  font-family:monospace;line-height:1.7;}
.log::-webkit-scrollbar{width:3px;}
.log::-webkit-scrollbar-thumb{background:var(--border);}
.log .ok{color:var(--green);}
.log .err{color:var(--red);}
.log .info{color:var(--muted2);}
.log .warn{color:var(--yellow);}

/* ê²°ê³¼ ë°°ë„ˆ */
.result-banner{display:none;border-radius:8px;padding:14px 18px;
  font-size:13px;margin-bottom:16px;display:none;align-items:center;gap:10px;}
.result-banner.ok{background:rgba(34,197,94,.1);border:1px solid rgba(34,197,94,.3);color:var(--green);display:flex;}
.result-banner.err{background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.3);color:var(--red);display:flex;}

/* ì•ˆë‚´ */
.info-box{background:rgba(59,130,246,.07);border:1px solid rgba(59,130,246,.2);
  border-radius:8px;padding:14px 16px;font-size:12px;color:var(--muted2);line-height:1.7;}
.info-box strong{color:var(--blue);}

/* í† ìŠ¤íŠ¸ */
.toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(20px);
  background:var(--bg3);border:1px solid var(--border);border-radius:8px;
  padding:10px 20px;font-size:13px;color:var(--text);z-index:500;
  opacity:0;transition:all .3s;pointer-events:none;}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0);}
</style>
</head>
<body>

<nav>
  <a class="nav-logo" href="index.html">âš  <span>SAFETY</span></a>
  <a class="nav-back" href="index.html">â† í™ˆ</a>
  <span style="color:var(--border)">|</span>
  <span class="nav-title">ğŸ“¤ ì‚¬ì§„ ì—…ë¡œë“œ</span>
  <div class="nav-right">
    <div class="token-status" id="tokenStatus">
      <div class="dot no" id="tokenDot"></div>
      <span id="tokenLabel">í† í° ë¯¸ì„¤ì •</span>
    </div>
  </div>
</nav>

<div class="wrap">

  <!-- â‘  GitHub í† í° ì„¤ì • -->
  <div class="card" id="tokenCard">
    <div class="card-title"><span class="ct-icon">ğŸ”‘</span> GitHub í† í° ì„¤ì • <span style="font-size:11px;color:var(--muted);font-weight:400;">(ìµœì´ˆ 1íšŒë§Œ)</span></div>
    <div class="token-wrap">
      <input class="token-input" type="password" id="tokenInput" placeholder="ghp_xxxxxxxxxxxxxxxx">
      <button class="btn primary" onclick="saveToken()">ì €ì¥</button>
      <button class="btn danger sm" onclick="clearToken()" style="display:none" id="clearBtn">ì‚­ì œ</button>
    </div>
    <div class="token-help">
      í† í°ì´ ì—†ìœ¼ì‹ ê°€ìš”?
      <a href="https://github.com/settings/tokens/new?scopes=repo&description=SafetyPortal" target="_blank">ì—¬ê¸° í´ë¦­</a>
      â†’ <strong>repo</strong> ê¶Œí•œ ì²´í¬ â†’ Generate token â†’ ë³µì‚¬í•´ì„œ ë¶™ì—¬ë„£ê¸°<br>
      âš  í† í°ì€ ì´ ë¸Œë¼ìš°ì €ì—ë§Œ ì €ì¥ë˜ë©° ì™¸ë¶€ë¡œ ì „ì†¡ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
    </div>
  </div>

  <!-- â‘¡ ì—…ë¡œë“œ í¼ -->
  <div class="card">
    <div class="card-title"><span class="ct-icon">ğŸ“</span> ì—…ë¡œë“œ ìœ„ì¹˜ ì„¤ì •</div>
    <div class="form-row">
      <div class="field">
        <label>ì¹´í…Œê³ ë¦¬</label>
        <select id="categorySelect" onchange="updatePath()">
          <option value="01_ì¼ì¼ì ê²€">01_ì¼ì¼ì ê²€</option>
          <option value="02_ì •ê¸°ì ê²€/01_ì›”ê°„ì ê²€">02_ì •ê¸°ì ê²€/01_ì›”ê°„ì ê²€</option>
          <option value="02_ì •ê¸°ì ê²€/02_ë²•ì •ì ê²€">02_ì •ê¸°ì ê²€/02_ë²•ì •ì ê²€</option>
          <option value="02_ì •ê¸°ì ê²€/03_í˜‘ë ¥ì—…ì²´ì ê²€">02_ì •ê¸°ì ê²€/03_í˜‘ë ¥ì—…ì²´ì ê²€</option>
          <option value="03_í•©ë™ì ê²€/01_ë°œì£¼ì²˜í•©ë™ì ê²€">03_í•©ë™ì ê²€/01_ë°œì£¼ì²˜í•©ë™ì ê²€</option>
          <option value="03_í•©ë™ì ê²€/02_ê°ë¦¬í•©ë™ì ê²€">03_í•©ë™ì ê²€/02_ê°ë¦¬í•©ë™ì ê²€</option>
          <option value="04_ìœ ê´€ê¸°ê´€ì ê²€">04_ìœ ê´€ê¸°ê´€ì ê²€</option>
          <option value="02.ì§€ì &ì´ìŠˆ">02.ì§€ì &ì´ìŠˆ</option>
          <option value="03.ê°œì„ ì¡°ì¹˜">03.ê°œì„ ì¡°ì¹˜</option>
          <option value="04.êµìœ¡&íšŒì˜">04.êµìœ¡&íšŒì˜</option>
          <option value="05.ì‚¬ê³ ì‚¬ë¡€">05.ì‚¬ê³ ì‚¬ë¡€</option>
          <option value="06.ê¸°íƒ€">06.ê¸°íƒ€</option>
        </select>
      </div>
      <div class="field">
        <label>ë‚ ì§œ</label>
        <input type="date" id="dateInput" onchange="updatePath()">
      </div>
    </div>
    <div class="info-box" id="pathPreview">
      <strong>ì—…ë¡œë“œ ê²½ë¡œ:</strong> <span id="pathText">photos/01_ì¼ì¼ì ê²€/2026-02-28/</span>
    </div>
  </div>

  <!-- â‘¢ ë“œë¡­ì¡´ -->
  <div class="card">
    <div class="card-title"><span class="ct-icon">ğŸ–¼ï¸</span> ì‚¬ì§„ ì„ íƒ</div>
    <div class="dropzone" id="dropzone">
      <input type="file" id="fileInput" accept="image/*" multiple onchange="handleFiles(this.files)">
      <div class="dz-icon">ğŸ“¸</div>
      <div class="dz-text">ì‚¬ì§„ì„ ëŒì–´ë‹¤ ë†“ê±°ë‚˜ í´ë¦­í•´ì„œ ì„ íƒ</div>
      <div class="dz-sub">JPG, PNG, BMP, GIF Â· í•œë²ˆì— ì—¬ëŸ¬ì¥ ê°€ëŠ¥</div>
    </div>

    <!-- ë¯¸ë¦¬ë³´ê¸° -->
    <div class="preview-grid" id="previewGrid" style="display:none"></div>

    <!-- ì§„í–‰ ìƒí™© -->
    <div class="progress-wrap" id="progressWrap" style="display:none">
      <div class="progress-bar-bg"><div class="progress-bar" id="progressBar"></div></div>
      <div class="progress-text" id="progressText"></div>
    </div>

    <!-- ê²°ê³¼ -->
    <div class="result-banner" id="resultBanner"></div>

    <!-- ì—…ë¡œë“œ ë²„íŠ¼ -->
    <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
      <button class="btn primary" id="uploadBtn" onclick="startUpload()" disabled>
        ğŸ“¤ ì—…ë¡œë“œ ì‹œì‘
      </button>
      <button class="btn sm" onclick="clearFiles()" id="clearFilesBtn" style="display:none">ì´ˆê¸°í™”</button>
      <span id="fileCount" style="font-size:12px;color:var(--muted)"></span>
    </div>
  </div>

  <!-- ì—…ë¡œë“œ ë¡œê·¸ -->
  <div class="card" id="logCard" style="display:none">
    <div class="card-title"><span class="ct-icon">ğŸ“‹</span> ì—…ë¡œë“œ ë¡œê·¸</div>
    <div class="log" id="logBox"></div>
  </div>

</div>

<div class="toast" id="toast"></div>

<script>
const OWNER = 'fnksoul-ai';
const REPO  = 'safety-portal';
const BRANCH= 'main';

let selectedFiles = [];
let isUploading   = false;

// â”€â”€ ì´ˆê¸°í™” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.onload = () => {
  // ì˜¤ëŠ˜ ë‚ ì§œ ê¸°ë³¸ê°’
  const today = new Date();
  document.getElementById('dateInput').value = today.toISOString().split('T')[0];
  updatePath();
  checkToken();

  // ë“œë˜ê·¸ì•¤ë“œë¡­
  const dz = document.getElementById('dropzone');
  dz.addEventListener('dragover', e => { e.preventDefault(); dz.classList.add('drag'); });
  dz.addEventListener('dragleave', () => dz.classList.remove('drag'));
  dz.addEventListener('drop', e => {
    e.preventDefault(); dz.classList.remove('drag');
    handleFiles(e.dataTransfer.files);
  });
};

// â”€â”€ ê²½ë¡œ ë¯¸ë¦¬ë³´ê¸° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updatePath() {
  const cat  = document.getElementById('categorySelect').value;
  const date = document.getElementById('dateInput').value || 'ë‚ ì§œì„ íƒ';
  document.getElementById('pathText').textContent = `photos/${cat}/${date}/`;
}

// â”€â”€ í† í° ê´€ë¦¬ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function saveToken() {
  const val = document.getElementById('tokenInput').value.trim();
  if (!val) { showToast('í† í°ì„ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }
  if (!val.startsWith('ghp_') && !val.startsWith('github_pat_')) {
    showToast('ì˜¬ë°”ë¥¸ GitHub í† í° í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤');
    return;
  }
  localStorage.setItem('gh_token', val);
  document.getElementById('tokenInput').value = '';
  checkToken();
  showToast('âœ… í† í°ì´ ì €ì¥ëì–´ìš”!');
}
function clearToken() {
  if (!confirm('í† í°ì„ ì‚­ì œí• ê¹Œìš”?')) return;
  localStorage.removeItem('gh_token');
  checkToken();
}
function getToken() { return localStorage.getItem('gh_token') || ''; }
function checkToken() {
  const t = getToken();
  const dot   = document.getElementById('tokenDot');
  const label = document.getElementById('tokenLabel');
  const clearBtn = document.getElementById('clearBtn');
  const uploadBtn= document.getElementById('uploadBtn');
  if (t) {
    dot.className   = 'dot ok';
    label.textContent = 'í† í° ì„¤ì •ë¨';
    clearBtn.style.display = '';
    document.getElementById('tokenInput').placeholder = 'í† í°ì´ ì €ì¥ë˜ì–´ ìˆìŠµë‹ˆë‹¤';
    if (selectedFiles.length) uploadBtn.disabled = false;
  } else {
    dot.className   = 'dot no';
    label.textContent = 'í† í° ë¯¸ì„¤ì •';
    clearBtn.style.display = 'none';
    uploadBtn.disabled = true;
  }
}

// â”€â”€ íŒŒì¼ ì„ íƒ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function handleFiles(fileList) {
  const exts = ['jpg','jpeg','png','bmp','gif','tif','tiff','webp'];
  const newFiles = [...fileList].filter(f => exts.includes(f.name.split('.').pop().toLowerCase()));
  if (!newFiles.length) { showToast('ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì„ íƒ ê°€ëŠ¥í•©ë‹ˆë‹¤'); return; }

  // ì¤‘ë³µ ì œê±°
  newFiles.forEach(f => {
    if (!selectedFiles.find(x => x.name === f.name && x.size === f.size))
      selectedFiles.push(f);
  });

  renderPreviews();
  updateFileCount();
  if (getToken()) document.getElementById('uploadBtn').disabled = false;
}

function renderPreviews() {
  const grid = document.getElementById('previewGrid');
  grid.style.display = selectedFiles.length ? 'grid' : 'none';
  grid.innerHTML = '';
  selectedFiles.forEach((f, i) => {
    const item = document.createElement('div');
    item.className = 'preview-item'; item.id = `pi_${i}`;
    const url = URL.createObjectURL(f);
    item.innerHTML = `
      <img src="${url}" alt="${f.name}">
      <div class="pi-name">${f.name}</div>
      <button class="pi-remove" onclick="removeFile(${i})">âœ•</button>
    `;
    grid.appendChild(item);
  });
  document.getElementById('clearFilesBtn').style.display = selectedFiles.length ? '' : 'none';
}

function removeFile(i) {
  selectedFiles.splice(i, 1);
  renderPreviews(); updateFileCount();
  if (!selectedFiles.length) document.getElementById('uploadBtn').disabled = true;
}

function clearFiles() {
  selectedFiles = []; renderPreviews(); updateFileCount();
  document.getElementById('uploadBtn').disabled = true;
  document.getElementById('resultBanner').style.display = 'none';
  document.getElementById('logCard').style.display = 'none';
  document.getElementById('progressWrap').style.display = 'none';
}

function updateFileCount() {
  document.getElementById('fileCount').textContent =
    selectedFiles.length ? selectedFiles.length + 'ì¥ ì„ íƒë¨' : '';
}

// â”€â”€ ì—…ë¡œë“œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function startUpload() {
  if (isUploading) return;
  const token = getToken();
  if (!token) { showToast('í† í°ì„ ë¨¼ì € ì„¤ì •í•´ì£¼ì„¸ìš”'); return; }
  if (!selectedFiles.length) { showToast('ì‚¬ì§„ì„ ì„ íƒí•´ì£¼ì„¸ìš”'); return; }

  const cat  = document.getElementById('categorySelect').value;
  const date = document.getElementById('dateInput').value;
  if (!date) { showToast('ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”'); return; }

  isUploading = true;
  document.getElementById('uploadBtn').disabled = true;
  document.getElementById('uploadBtn').textContent = 'â³ ì—…ë¡œë“œ ì¤‘...';
  document.getElementById('progressWrap').style.display = 'block';
  document.getElementById('logCard').style.display = 'block';
  document.getElementById('resultBanner').style.display = 'none';

  const logBox = document.getElementById('logBox');
  logBox.innerHTML = '';
  const log = (msg, cls='info') => {
    logBox.innerHTML += `<div class="${cls}">${msg}</div>`;
    logBox.scrollTop = logBox.scrollHeight;
  };

  let ok = 0, fail = 0;
  const total = selectedFiles.length;

  log(`ğŸ“¤ ì—…ë¡œë“œ ì‹œì‘ â€” ${total}ì¥ Â· ê²½ë¡œ: photos/${cat}/${date}/`);

  for (let i = 0; i < total; i++) {
    const f = selectedFiles[i];
    const pct = Math.round((i / total) * 100);
    document.getElementById('progressBar').style.width = pct + '%';
    document.getElementById('progressText').textContent = `${i+1} / ${total} â€” ${f.name}`;

    // ë¯¸ë¦¬ë³´ê¸°ì— ë¡œë”© í‘œì‹œ
    const piEl = document.getElementById(`pi_${i}`);
    if (piEl) piEl.innerHTML += '<div class="pi-status">â³</div>';

    try {
      const b64 = await fileToBase64(f);
      const path = `photos/${cat}/${date}/${f.name}`;

      // ê¸°ì¡´ íŒŒì¼ SHA í™•ì¸ (ë®ì–´ì“°ê¸° ìœ„í•´)
      let sha = undefined;
      try {
        const chk = await ghFetch(`contents/${path}`, 'GET', null, token);
        if (chk.sha) sha = chk.sha;
      } catch {}

      const body = {
        message: `ì‚¬ì§„ ì—…ë¡œë“œ: ${f.name} (${date})`,
        content: b64,
        branch: BRANCH,
      };
      if (sha) body.sha = sha;

      await ghFetch(`contents/${path}`, 'PUT', body, token);
      ok++;
      log(`âœ… ${f.name}`, 'ok');
      if (piEl) { piEl.querySelector('.pi-status').textContent = 'âœ…'; }
    } catch(e) {
      fail++;
      log(`âŒ ${f.name} â€” ${e.message}`, 'err');
      if (piEl) { piEl.querySelector('.pi-status').textContent = 'âŒ'; }
    }
  }

  // photos.json ì—…ë°ì´íŠ¸
  log('ğŸ“‹ photos.json ì—…ë°ì´íŠ¸ ì¤‘...', 'warn');
  try {
    await updatePhotosJson(token, cat, date);
    log('âœ… photos.json ì—…ë°ì´íŠ¸ ì™„ë£Œ', 'ok');
  } catch(e) {
    log(`âš  photos.json ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ${e.message}`, 'warn');
  }

  document.getElementById('progressBar').style.width = '100%';
  document.getElementById('progressText').textContent = `ì™„ë£Œ! ì„±ê³µ ${ok}ì¥ / ì‹¤íŒ¨ ${fail}ì¥`;

  const banner = document.getElementById('resultBanner');
  if (fail === 0) {
    banner.className = 'result-banner ok';
    banner.innerHTML = `âœ… ${ok}ì¥ ì—…ë¡œë“œ ì™„ë£Œ! <a href="gallery.html" style="color:inherit;margin-left:12px;text-decoration:underline">ê°¤ëŸ¬ë¦¬ í™•ì¸í•˜ê¸° â†’</a>`;
  } else {
    banner.className = 'result-banner err';
    banner.innerHTML = `âš  ì„±ê³µ ${ok}ì¥ / ì‹¤íŒ¨ ${fail}ì¥. ì‹¤íŒ¨ í•­ëª©ì€ ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.`;
  }
  banner.style.display = 'flex';

  log(`\nğŸ ì™„ë£Œ â€” ì„±ê³µ ${ok} / ì‹¤íŒ¨ ${fail}`);
  isUploading = false;
  document.getElementById('uploadBtn').disabled = false;
  document.getElementById('uploadBtn').textContent = 'ğŸ“¤ ì—…ë¡œë“œ ì‹œì‘';
}

// â”€â”€ GitHub API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function ghFetch(endpoint, method, body, token) {
  const res = await fetch(`https://api.github.com/repos/${OWNER}/${REPO}/${endpoint}`, {
    method,
    headers: {
      'Authorization': `Bearer ${token}`,
      'Content-Type': 'application/json',
      'Accept': 'application/vnd.github+json',
    },
    body: body ? JSON.stringify(body) : undefined,
  });
  const data = await res.json();
  if (!res.ok) throw new Error(data.message || res.statusText);
  return data;
}

async function fileToBase64(file) {
  return new Promise((res, rej) => {
    const reader = new FileReader();
    reader.onload  = () => res(reader.result.split(',')[1]);
    reader.onerror = rej;
    reader.readAsDataURL(file);
  });
}

// â”€â”€ photos.json ìë™ ì—…ë°ì´íŠ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function updatePhotosJson(token, cat, date) {
  let existing = {};
  let sha = undefined;

  try {
    const f = await ghFetch('contents/photos.json', 'GET', null, token);
    sha = f.sha;
    existing = JSON.parse(atob(f.content.replace(/\n/g,'')));
  } catch {}

  // í˜„ì¬ ë‚ ì§œ í´ë” íŒŒì¼ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
  let fileList = [];
  try {
    const items = await ghFetch(`contents/photos/${cat}/${date}`, 'GET', null, token);
    fileList = items.filter(x => /\.(jpg|jpeg|png|bmp|gif|tif|tiff|webp)$/i.test(x.name))
                    .map(x => ({ src: `photos/${cat}/${date}/${x.name}`, name: x.name }));
  } catch {}

  if (!fileList.length) return;

  // ê¸°ì¡´ ë°ì´í„°ì— ë³‘í•© (ë‚ ì§œ í‚¤)
  if (!existing[date]) existing[date] = [];
  fileList.forEach(f => {
    if (!existing[date].find(x => x.src === f.src)) existing[date].push(f);
  });

  const content = btoa(unescape(encodeURIComponent(JSON.stringify(existing, null, 2))));
  const body = { message: `photos.json ì—…ë°ì´íŠ¸ (${date})`, content, branch: BRANCH };
  if (sha) body.sha = sha;
  await ghFetch('contents/photos.json', 'PUT', body, token);
}

// â”€â”€ í† ìŠ¤íŠ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2500);
}
</script>
</body>
</html>
